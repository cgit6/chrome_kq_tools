





<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/css/style.css?timestamp=202411191047" rel="stylesheet" type="text/css">
  <link href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/css/icon-fonts/css/jambo_iconsystem.css?timestamp=8" rel="stylesheet" type="text/css">
  
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/underscore/1.9.1/underscore-min.js"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/vanilla-lazyload/12.4.0/lazyload.min.js"></script>
  <script type="text/javascript" src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/jquery/1.8.3/jquery-1.8.3.min.js"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js"></script>
  <link rel="stylesheet" type="text/css" media="screen" href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/css/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css" />
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/mustache/2.3.2/mustache.js"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/jquery-ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/css/jquery-ui/1.12.1/themes/smoothness/jquery-ui.css">
  <script type="text/javascript" src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/tag-it.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/css/jquery.tagit.css" />
  <link rel="stylesheet" type="text/css" href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/css/image-select.css?timestamp=2" />
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/stimulus/1.1.1/stimulus.umd.js"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/bills-loader-controller.js?timestamp=202410221144"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/user-remark-controller.js?timestamp=1590906294310"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/jquery.tablesorter.js?timestamp=5"></script>
  <script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/tw-city-selector.min.js"></script>
  <title>出 貨 小 幫 手</title>
  



<script id="ship_a4" type="x-tmpl-mustache">
<div style="page-break-after: always;">
  <style>
	.border {
		width: 100%;
		border-collapse: collapse;
		border: 1px solid black;
	}
	.border th {
		border: 1px solid black;
		padding: 4px;
	}
	.border td {
		border: 1px solid black;
		padding: 4px;
	}
	.underline {
		border-bottom: 1px solid black;
	}
  .break-word {
    word-break: break-word;
  }
  </style>
  [[ #ship_note_images ]]
  <div><img src="[[ . ]]" style="width: [[ #is_hct ]]45%[[ /is_hct ]][[ ^is_hct ]]50%[[ /is_hct ]]"></div>
  [[ /ship_note_images ]]
  <h2 align="center">[[ store_name ]] 出貨單</h2>
  <table style="width: 100%; break-inside: avoid;">
    
    <tr><td colspan="4" align="center">[[ store_contact ]] [[ store_email ]]</td></tr>
    
    <tr>
      
      <td align="right">付款單號：</td>
      
      <td>[[ serial ]]</td>
      
      
      
      <td align="right">FB 帳號：</td>
      <td>
        [[ from_name ]]
        
        
        <img src="https://graph.facebook.com/[[ from_id ]]/picture">
        
      </td>
      
    </tr>
    <tr>
      
      <td align="right">收件人：</td>
      <td class="ship_name">[[ ship_name ]]</td>
      
      
      <td align="right">聯絡電話：</td>
      <td class="ship_contact">[[ ship_contact ]]</td>
      
    </tr>
    <tr>
      
      <td align="right">出貨地址：</td>
      <td class="ship_address break-word">
        [[ #ship_zipcode ]]([[ ship_zipcode ]])[[ /ship_zipcode ]]
        [[{ ship_address }]]
      </td>
      
      
    </tr>
    <tr>
      
      <td align="right">消費者備註：</td>
      <td class="remark" style="width: 35%">
        [[ #is_a4 ]]
        [[ #invoice_method ]][發票處理][[ invoice_method ]] [[ /invoice_method ]]
        [[ #buyer_vat ]][統編][[ buyer_vat ]] [[ /buyer_vat ]]
        [[ /is_a4 ]]
        [[ remark ]]
      </td>
      
      
    </tr>
    <tr>
      
    </tr>
    
    [[ #sns ]]
    <tr>
      <td align="right">託運單號：</td>
      <td colspan="3" class="sns">[[ sns ]]</td>
    </tr>
    [[ /sns ]]
    [[ #custom_ship_notes ]]
    <tr>
      <td align="right">自訂託運單號：</td>
      <td colspan="3" class="custom_ship_notes">[[ custom_ship_notes ]]</td>
    </tr>
    [[ /custom_ship_notes ]]
    
    
    [[ #invoices ]]
    <tr>
      <td align="right">發票號碼：</td>
      <td colspan="3" class="sns">[[ invoices ]]</td>
    </tr>
    [[ /invoices ]]
    
    
  </table>
  <table class="border">
    <tr>
      
      <th>項次</th>
      
      
      <th>訂單編號</th>
      
      
      <th>場次</th>
      
      
      <th>品項名稱</th>
      
      <th>樣式</th>
      
      
      
      <th>規格</th>
      
      
      <th>數量</th>
      
      
      <th>單價</th>
      
      
      <th>折扣</th>
      
      
      <th>小計</th>
      
      
      
      
    </tr>
    [[ #orders ]]
    <tr [[#bold]] style="font-weight:bold; background-color: #d3d3d3;"[[/bold]]>
      
      <td align="center">[[ index ]]</td>
      
      
      <td style="width: 80px;">[[ serial ]]</td>
      
      
			<td>[[ session ]]</td>
      
      
      <td>
				<div style="display: flex;">
					[[ #photo ]]<img src="[[ photo ]]" style="width: [[ photo_length ]]px;height: [[ photo_length ]]px;">[[ /photo ]]
					<div[[ ^quantity ]] style="text-decoration: line-through;" [[ /quantity ]]>
            
            [[ origin_name ]]
            
					</div>
				</div>
			</td>
      
      <td>[[ style ]]</td>
      
      
      
      <td>[[{ specification }]]</td>
      
      
      <td align="right">[[ quantity ]]</td>
      
      
      <td align="right">[[ price ]]</td>
      
      
      <td align="right">[[ discount ]]</td>
      
      
      <td align="right">[[ subtotal ]]</td>
      
      
      [[ #suborder ]]
      
      [[ /suborder ]]
      
    </tr>
    [[ /orders ]]
  </table>
  <table style="width: 100%; border-collapse: collapse; break-inside: avoid;">
    
    <tr><td style="width: 80%"></td><td class="underline">商品總額：</td><td class="underline" align="right">[[ orders_subtotal ]]</td></tr>
    
    
    
    
    [[ #subtotal_discount ]]<tr><td style="width: 80%"></td><td class="underline">專屬折扣：</td><td class="underline" align="right">- [[ subtotal_discount ]]</td></tr>[[ /subtotal_discount ]]
    
    
    [[ #reward_discount ]]<tr><td style="width: 80%"></td><td class="underline">紅利折抵：</td><td class="underline" align="right">- [[ reward_discount ]]</td></tr>[[ /reward_discount ]]
    
    
    
    
    <tr><td style="width: 80%"></td><td class="underline">總計：</td><td class="underline" align="right">[[ amount ]]</td></tr>
    
  </table>
  [[ ^is_a4 ]]
  [[ #invoice_method ]]
  <div>發票處理方式：[[ invoice_method ]]</div>
  [[ /invoice_method ]]
  [[ #invoice_images ]]
  <div style="break-inside: avoid;"><img src="[[ . ]]" style="max-width: 25%; max-height: 25%;"></div>
  [[ /invoice_images ]]
  [[ /is_a4 ]]
</div>
</script>

<script id="ship_thermal" type="x-tmpl-mustache">
<div style="page-break-after: always;">
  <style>
  @media print {
    @page {
    margin: 0;
    }
  }
  .border {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid black;
  }
  .border th {
    border: 1px solid black;
  }
  .border td {
    border: 1px solid black;
  }
  .underline {
    border-bottom: 1px solid black;
  }
  .info_td {
    text-align: right;
    
    min-width: 100px;
    
  }
  .info_tr {
    float: left;
    width: 100%;
  }
  </style>
  <div style="width: 100%;">
    
    <div style="text-align: center;">[[ store_name ]]</div>
    
    <table style="width: 100%;">
      
      <tr class="info_tr">
        <td class="info_td">付款單號：</td>
        
        <td>[[ serial ]]</td>
        
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">FB 帳號：</td>
        <td>[[ from_name ]]</td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">&emsp;收件人：</td>
        <td>[[ ship_name ]]</td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">聯絡電話：</td>
        <td>[[ ship_contact ]]</td>
      </tr class="info_tr">
      
      
      <tr class="info_tr">
        <td class="info_td">出貨地址：</td>
        <td>
          [[ #ship_zipcode ]]([[ ship_zipcode ]])[[ /ship_zipcode ]]
          [[{ ship_address }]]
        </td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">付款方式：</td>
        <td>[[ payment_method ]]</td>
      </tr>
      
      [[ #pick_id ]]
      
      <tr class="info_tr">
        <td class="info_td">撿貨序號：</td>
        <td>[[ pick_id ]]</td>
      </tr>
      
      [[ /pick_id ]]
      
      <tr class="info_tr">
        <td class="info_td">列印時間：</td>
        <td>[[ print_time ]]</td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">消費者備註：</td>
        <td>[[ remark ]]</td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">小幫手備註：</td>
        <td>
          [[ extra_remark ]]
        </td>
      </tr>
      
      
      <tr class="info_tr">
        <td class="info_td">系統備註：</td>
        <td>
          [[ system_remark ]]
        </td>
      </tr>
      
      [[ #sns ]]
      
      <tr class="info_tr">
        <td class="info_td">託運單號：</td>
        <td>[[ sns ]]</td>
      </tr>
      
      [[ /sns ]]
    </table>
  </div>
  <table class="border">
    <tr>
        
        <th>場次</th>
        
        
        <th>編號</th>
        
        
        <th>名稱</th>
        
        
        <th>規格</th>
        
        
        <th>數量</th>
        
        
        <th>單價</th>
        
        
        <th>折扣</th>
        
        
        <th>小計</th>
        
        
        <th>備註</th>
        
        
        <th>儲位</th>
        
    </tr>
    [[ #orders ]]
    <tr [[#bold]] style="font-weight:bold; background-color: #d3d3d3;"[[/bold]]>
      
      <td>[[ session ]]</td>
      
      
      <td>[[ serial ]]</td>
      
      
      <td>[[ name ]]</td>
      
      
      <td>[[{ specification }]]</td>
      
      
      <td align="right">[[ quantity ]]</td>
      
      
      <td align="right">[[ price ]]</td>
      
      
      <td align="right">[[ discount ]]</td>
      
      
      <td align="right">[[ subtotal ]]</td>
      
      
      <td>[[ remark ]][[ #multi_pieces_discount ]]<br>[多件優惠]<br>專屬折扣：[[ multi_pieces_discount ]][[ /multi_pieces_discount ]]
        
        [[ #extra_remark ]]
        <br>[小幫手]<br>[[ extra_remark ]]
        [[ /extra_remark ]]
        
      </td>
      
      
      <th>[[ storage ]]</th>
      
    </tr>
    [[ /orders ]]
  </table>
  <table style="width: 100%; border-collapse: collapse;">
    
    <tr><td style="width: 50%"></td><td class="underline">商品總額：</td><td class="underline" align="right">[[ orders_subtotal ]]</td></tr>
    
    
    <tr><td style="width: 50%"></td><td class="underline">商品總數：</td><td class="underline" align="right">[[ commodity_total_quantity ]]</td></tr>
    
    
    <tr><td style="width: 50%"></td><td class="underline">運費：</td><td class="underline" align="right">[[ shipping_fee ]]</td></tr>
    [[ #extra_shipping_fee ]]
    <tr><td style="width: 50%"></td><td class="underline">附加運費：</td><td class="underline" align="right">[[ extra_shipping_fee ]]</td></tr>
    [[ /extra_shipping_fee ]]
    
    
    [[ #subtotal_discount ]]<tr><td style="width: 80%"></td><td class="underline">專屬折扣：</td><td class="underline" align="right">- [[ subtotal_discount ]]</td></tr>[[ /subtotal_discount ]]
    
    [[ #reward_discount ]]
    
    <tr><td style="width: 50%"></td><td class="underline">紅利折抵：</td><td class="underline" align="right">- [[ reward_discount ]]</td></tr>
    
    [[ /reward_discount ]]
    [[ #cash_flow_fee ]]
    
    <tr><td style="width: 50%"></td><td class="underline">服務費：</td><td class="underline" align="right">[[ cash_flow_fee ]]</td></tr>
    
    [[ /cash_flow_fee ]]
    [[ #tax ]]
    
    <tr><td style="width: 50%"></td><td class="underline">營業稅：</td><td class="underline" align="right">[[ tax ]]</td></tr>
    
    [[ /tax ]]
    
    <tr><td style="width: 50%"></td><td class="underline">總計：</td><td class="underline" align="right">[[ amount ]]</td></tr>
    
  </table>
  <br>
</div>
</script>

<script id="ship_order" type="x-tmpl-mustache">
<tr>
  <td>
    <label class="manage-checkbox">
      <input type="checkbox" class="[[# from_allowance ]]allowance_[[ /from_allowance ]]order-checkbox" name="[[# from_allowance ]]allowance_[[ /from_allowance ]]orders" value="[[ id ]]" />
      <span class="manage-checkmark"></span>
    </label>
  </td>
  [[ ^from_allowance ]]
  <td>
    <img src="[[ photo ]]" alt="" class="manage-table-cover "/>
  </td>
  <td>
    <h3>[[ name ]]</h3>
  </td>
  <td>
    <p class="theme align-c">[[ serial ]]</p>
    [[ #returnwarehousedate ]]
    <span>(已銷退)</span>
    [[ /returnwarehousedate ]]
  </td>
  <td>
    <p>[[ specification ]]</p>
  </td>
  <td>
    <span>[[ date ]]</span>
  </td>
  <td>
    <p class="theme align-c">[[ price ]]</p>
  </td>
  <td>
    <p class="theme align-c quantity">[[ quantity ]]</p>
  </td>
  <td>
    <p class="theme align-c discount">[[ discount ]]</p>
  </td>
  <td>
    <p class="theme align-c subtotal">[[ subtotal ]]</p>
  </td>
  <td>
    <p class="remark">[[ remark ]][[ #multi_pieces_discount ]]<br><span style="color: #e75280;">[多件優惠]</span><br>專屬折扣：[[ multi_pieces_discount ]][[ /multi_pieces_discount ]]</p>
  </td>
  <td>
    [[ #refundable ]]
    <div class="product-edit-tool order-manage-edit inline-b align-c">
      <button type="button" class="demo-icon btn-icon icon-o btn-theme indent icon-soldout btn-refund" title="賣家退單" data-id="[[ id ]]"><span>賣家退單</span></button>
    </div>
    [[ /refundable ]]
    [[ #exchangeable ]]
    <div class="product-edit-tool order-manage-edit inline-b align-c">
      <button type="button" class="demo-icon btn-icon icon-o btn-theme indent icon-chang-goods btn-exchange" title="換貨" data-id="[[ id ]]"><span>換貨</span></button>
    </div>
    [[ /exchangeable ]]
    [[ #quantity_editable ]]
    <div class="product-edit-tool order-manage-edit inline-b align-c">
      <button type="button" class="demo-icon btn-icon icon-o btn-theme indent icon-chang_counter btn-quantity_edit" title="變更數量" data-id="[[ id ]]"><span>變更數量</span></button>
    </div>
    [[ /quantity_editable ]]
    [[ #order_split ]]
    <div class="product-edit-tool order-manage-edit inline-b align-c">
      <button type="button" class="demo-icon btn-icon icon-o btn-theme indent icon-split_order btn-order_split" title="拆分訂單" data-id="[[ id ]]"><span>拆分訂單</span></button>
    </div>
    [[ /order_split ]]
  </td>
  [[ /from_allowance ]]
  [[ #from_allowance ]]
  <td><input type="text" name="allowance_name_[[ id ]]" value="[[ name ]]" readonly></td>
  <td><input class="input1" type="number" name="allowance_quantity_[[ id ]]" value="[[ quantity ]]"></td>
  <td><input class="input1" type="number" name="allowance_price_[[ id ]]" value="[[ price ]]"></td>
  <input class="input1" type="hidden" name="allowance_tax_type_[[ id ]]" value="[[ tax_type ]]">
  [[ /from_allowance ]]
</tr>
</script>

<script id="ship_add_order" type="x-tmpl-mustache">
<tr>
  <td>
    <label class="manage-checkbox">
      <input type="checkbox" class="order-checkbox" name="add_orders" value="[[ id ]]" />
      <span class="manage-checkmark"></span>
    </label>
  </td>
  <td>
    <img src="[[ photo ]]" alt="" class="manage-table-cover "/>
  </td>
  <td>
    <h3>[[ name ]]</h3>
  </td>
  <td>
    <p class="theme align-c">[[ serial ]]</p>
  </td>
  <td>
    <p>[[ specification ]]</p>
  </td>
  <td>
    <span>[[ date ]]</span>
  </td>
  <td>
    <p class="theme align-c">[[ price ]]</p>
  </td>
  <td>
    <p class="theme align-c quantity">[[ quantity ]]</p>
  </td>
  <td>
    <p class="theme align-c discount">[[ discount ]]</p>
  </td>
  <td>
    <p class="theme align-c subtotal">[[ subtotal ]]</p>
  </td>
  <td>
    <p class="remark">[[ remark ]][[ #multi_pieces_discount ]]<br><span style="color: #e75280;">[多件優惠]</span><br>專屬折扣：[[ multi_pieces_discount ]][[ /multi_pieces_discount ]]</p>
  </td>
</tr>
</script>

<script id="ship_refund_order" type="x-tmpl-mustache">
<tr>
  <td>
    <label class="manage-checkbox">
      <input type="checkbox" class="order-checkbox" name="refund_orders" value="[[ id ]]" />
      <span class="manage-checkmark"></span>
    </label>
  </td>
  <td>
    <img src="[[ photo ]]" alt="" class="manage-table-cover "/>
  </td>
  <td>
    <h3>[[ name ]]</h3>
  </td>
  <td>
    <p class="theme align-c">[[ serial ]]</p>
    [[ #returnwarehousedate ]]
    <span>(已銷退)</span>
    [[ /returnwarehousedate ]]
  </td>
  <td>
    <p>[[ specification ]]</p>
  </td>
  <td>
    <span>[[ date ]]</span>
  </td>
  <td>
    <p class="theme align-c">[[ price ]]</p>
  </td>
  <td>
    <p class="theme align-c quantity">[[ quantity ]]</p>
  </td>
  <td>
    <p class="theme align-c discount">[[ discount ]]</p>
  </td>
  <td>
    <p class="theme align-c subtotal">[[ subtotal ]]</p>
  </td>
  <td>
    <p class="remark">[[ remark ]][[ #multi_pieces_discount ]]<br><span style="color: #e75280;">[多件優惠]</span><br>專屬折扣：[[ multi_pieces_discount ]][[ /multi_pieces_discount ]]</p>
  </td>
</tr>
</script>
</head>
<body>

<style>
.d-none {
  display: none;
}
.text-center {
  text-align: center;
}
#count a {
  text-decoration: underline;
}
.xdsoft_datetimepicker {
  margin-left: 106px;
  margin-top: -30px;
}
.account {
  font-size: 12px;
  line-height: 1.5;
}
.remark, .extra_remark, .system_remark {
  white-space: pre-wrap;
  overflow-wrap: break-word;
}
.break-word {
  overflow-wrap: break-word;
}
button:disabled {
  border: gray;
  background: gray;
}
.order-manage-bar {
  padding: 0;
}
.ui-widget.ui-widget-content {
  font-size: 14px;
  border: 1px solid #b7babf;
  border-radius: 0;
}
ul.tagit li.tagit-new {
  padding: 0;
  margin: 0;
}
.ui-menu.ui-widget-content {
  border: none;
}
.ui-menu-item {
  background: white;
  border: 1px solid #b7babf;
}
.ui-menu-item .ui-menu-item-wrapper.ui-state-active {
  background: yellow !important;
}
.tags li {
  padding-top: 0;
  padding-bottom: 0;
  margin-top: 0;
  margin-bottom: 0;
}
.loading-indicator {
  margin-top: 10px;
}
.ui-widget.ui-widget-content{
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    .ui-dialog .ui-dialog-buttonpane .ui-dialog-buttonset {
      float: none;
    }
    .ui-widget-content{
      border: 0;
    }
    .site-dialog-content a{
      color: -webkit-link;
      cursor: pointer;
      text-decoration: underline;
    }
    .ui-widget-overlay{
      opacity: 1;
      background-color: rgba(0,0,0,.7);
    }
    .highlight_row {
      border: 3px solid #e75280 !important;
    }
    .down-arrow {width: 15px; height: 15px; position: absolute; background-size: 15px; background-repeat: no-repeat; background-image: url(../../static/console2/img/common/down-arrow.png);}
    .up-arrow {width: 15px; height: 15px; position: absolute; transform: none !important; background-size: 15px; background-repeat: no-repeat; background-image: url(../../static/console2/img/common/up-arrow.png);}
    .account-info {
      text-align: center;
    }
    .account-photo-container {
      position: relative;
      padding-top: 8px;
      width:60px;
      left: 50%;
      transform: translateX(-50%);
    }
    .account-photo {
      text-align: center; width: 60px; height:60px;
      border: 3px solid #F08519;
    }
    .icon-jamboer {
      position: absolute; height: 40%; top: -4px; left: -29%;
      content: url("/static/images/icon/icon_jamboer.png");
    }
    .in-blacklist .account-photo {
      border: 3px solid #424242;
    }
    .in-blacklist .icon-jamboer {
      content: url("/static/images/icon/icon_jamboer_blacklist.png");
    }
    .is-new .account-photo {
      border: 3px solid #009B4C;
    }
    .is-new .icon-jamboer {
      content: url("/static/images/icon/icon_jamboer_new.png");
    }
    .is-vip .account-photo {
      border: 3px solid #E62129;
    }
    .is-vip .icon-jamboer {
      content: url("/static/images/icon/icon_jamboer_vip.png");
    }
    .account-ship-info {
      position: relative;
    }
    .icon-contact-in-blacklist {
      float:right;
      width: 20%;
      content: url("/static/images/icon/icon_warning.png");
    }
    .btn-click {
      background-color:#e75280 !important;
      color: white;
    }
    .pickup-point-city-selector select{
      border: 1px solid #e75280;
    }
    #orders_detail .down-arrow,
    #orders_detail .up-arrow {
      background-position: right;
      padding-right: 10px;
    }
    .no-wrap {
      white-space: nowrap;
    }
</style>




<!--fancybox.js-->
<script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/js/jquery.fancybox.min.js"></script>
<link href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/css/jquery.fancybox.min.css" rel='stylesheet'>
<link href="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/css/announcement.css?2" rel='stylesheet'>
<style>
  .hide { visibility: hidden; }
  .site-header-wrapper {
    width: 95%;
    margin: 0 auto;
  }
  .indicator {
    float: right;
    width:5px;
    height:5px;
  }
  .indicator-ongoing {
    border: 1px solid green;
  }
  .indicator-error {
    background-color: red;
  }
  .indicator-normal {
    background-color: green;
  }
  .indicator-good {
    background-color: blue;
  }
  /*使用指南-子選單*/
.dropdownmenu .guide .submenu li .more-sub-menu {
  position: absolute;
  top: 0;
  left: 100%;
  border-radius: 0 4px 4px 4px;
  z-index: 1;
  display: none;
  border-width:1px;
  border-style:solid;
  border-color:#DB5882;
  background-color: #fff;
}

.dropdownmenu .guide .submenu li  {
  position: absolute;
  top: 70px;
  left: 0;
  line-height: 40px;
  background: #3E8DA8;
  box-shadow: 0 1px 2px rgb(0 0 0 / 20%);
  border-radius: 0 0 4px 4px;
  display: none;
  z-index: 2;
}

.guide li {
  position: relative;
  list-style: none;
}
.arrow{
  /* background: red; */
  height: 100%;
  width: 100%;
  line-height: 70px;
  text-align: center;
  display: inline-block;
  color: #fff;
  transition: all 0.3s ease;
}
.more-arrow{
  line-height: 40px;
}
.more-sub-menu{
  position: absolute;
  top: 0;
  left: 100%;
  border-radius: 0 4px 4px 4px;
  z-index: 1;
  display: none;
  border-width: 1px;
  border-style: solid;
  border-color: #DB5882;
  background-color: #ffffff;
}
.more:hover .more-sub-menu{
  display: block;
}
.sub-menu>li:nth-last-child(1){
  border-bottom: none;
}

.more:hover .ic-forward{
  width: 12px;
  height: 12px;
  fill: #ffffff;
  padding-left: 3px;
  padding-top: 2px;
}
.ic-forward{
  width: 12px;
  height: 12px;
  fill: #DB5882;
  padding-left: 3px;
  padding-top: 2px;
}
.ic-forward:hover{
  width: 12px;
  height: 12px;
  fill: #ffffff;
  padding-left: 3px;
  padding-top: 2px;
}

.ic-download-center img{
  width: 25px !important;
  height: 25px !important;
}

.mediabuttons {
  position: fixed;
  z-index: 10;
  bottom: 2%;
  margin-left: -4px;
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: #ffffff;
  padding: 5px;
  box-shadow: 0px 3px 6px #00000029;
  border-radius: 5px;
}
.mediabuttons-item{
  margin-bottom: 3px;
}
.mediabuttons-item a{
  display: block;
  font-size: 20px;
  text-align: center;
  margin-top: 8px;
  cursor: pointer;
}
.mediabuttons-item p{
  display: block;
  font-size: 12px;
  color: #4C4C4C;
  text-align: center;
}
.mediabuttons-item  img {
  display: block;
  width: 20px;
  height: 20px;
  margin: 0 auto;
}
.package-alert{
  background:#d42f2f;
  border-radius: 50px;
  width: 15px;
  height: 15px;
  position: absolute;
  right: 0px;
}
.package-alert::before {
  content: "!";
  font-size: 12px;
  color: #ffffff;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
</style>

<div class="mb-hide">



<div class="mediabuttons">
  <!-- <div class="mediabuttons-item">
    <a class="ic-home" href="/console/setting/" target="_blank">
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-home.svg"><p>首頁</p>
    </a>
  </div> -->
  <div class="mediabuttons-item">
    <a class="ic-learning" href="/console/shipment/exceptions/" target="_blank">
      
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-package.png"><p>異常</p>
    </a>
  </div>
  
  <div class="mediabuttons-item">
    <a class="ic-store" href="/shop/27853/" target="_blank">
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-store.svg"><p>選品</p>
    </a>
  </div>
  
  
  <div class="mediabuttons-item">
    <a class="ic-faq" href="/link/faq/" target="_blank">
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-faq.svg"><p>FAQ</p>
    </a>
  </div>
  <div class="mediabuttons-item">
    <a class="ic-sop" href="/console/instructions/" target="_blank">
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-sop.svg"><p>指南</p>
    </a>
  </div>
  <div class="mediabuttons-item">
    <a class="ic-learning" href="/link/trick/" target="_blank">
      <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-learning.svg"><p>學堂</p>
    </a>
  </div>
  
  <div class="mediabuttons-item scrollToTop">
    <a class="ic-scroll-top">
    <img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/img/header/ic-scrolltop.svg"><p>Top</p>
  </a>
  </div>
</div>
</div>

<header class="site-header">
    <div class="site-header-wrapper clear">
      <h1 class="site-logo"><a href="/console/" target="_blank"><img src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/img/common/logo.png" alt="" title=""></a></h1>
      <nav id="btn-header" class="mb-hide">
        <ul class="owner_head-tool float-l align-c">
          
          <li>
            <a id="header-setting" href="/console/setting/" target="_blank" class="btn-pd btn-helper f-line helper-fn">商家設定</a>
          </li>
          
          
          <li>
            <a id="header-live" href="/console/live/" target="_blank" class="btn-pd btn-helper f-line helper-fn">直播小幫手</a>
          </li>
          
          
          <li>
            <a id="header-order" href="/console/order/" target="_blank"  class="btn-pd btn-helper f-line helper-fn">訂單小幫手</a>
          </li>
          
          
          <li>
            <a id="header-ship" href="/console/ship/" target="_blank"  class="btn-pd btn-helper f-line helper-fn">出貨小幫手</a>
          </li>
          
          
          <li>
            <a id="header-commodity" href="/console/commodity/" target="_blank"  target="_blank" class="btn-pd btn-helper f-line helper-fn">商品小幫手</a>
          </li>
          
          
          
          
          <li>
            <a id="header-fans" href="/console/fans/" target="_blank" class="btn-pd btn-helper f-line helper-fn">粉絲小幫手</a>
          </li>
          
          
          <li>
            <a id="header-campaign" href="/console/campaign/" target="_blank" class="btn-pd btn-helper f-line helper-fn">行銷小幫手</a>
          </li>
          
          
      </nav>
      <div class="account float-r align-r">
        <div class="store-name theme ellipsis" style="font-size: 150%; font-weight: bold; padding-right: 8px;">翰禹&nbsp;</div>
        <div>Hsu LaLa 您好（ <span id="fb" style="cursor: pointer; color: #e75280;">切換帳號</span>
           ）</div>
        <div id="fetch-comments-indicator" data-controller="indicator" data-action="fetch-comments->indicator#update">
          <span data-target="indicator.result" class="indicator indicator-normal hide"></span>
          <span data-target="indicator.ongoing" class="indicator indicator-ongoing hide"></span>
        </div>
      </div>
    </div>
</header>

<script>
var lng = 'zh'
if (lng == 'zh') {
  lng = 'zh-hant'
}
var load_png_list = function(pages, png_path){
  var png_list = []
  for(let i = 1; i <= pages; i++) {
    if(i.toString().length < 2){
      page = '000'+i;
    } else if (i.toString().length < 3){
      page = '00'+i;
    } else {
      page = '0'+i;
    }
    png_list.push({src: png_path + page + '.PNG?1',});
  }
  return png_list
}

$("#fancybox-customer").on('click', function() {
  var pages = 14;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Customer/'+lng+'/Customer';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Customer');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-ig-setting").on('click', function() {
  var pages = 17;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_IG_Setting/'+lng+'/IG_Setting';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_IG_Setting');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-inventory").on('click', function() {
  var pages = 21;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Inventory/'+lng+'/Inventory';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Inventory');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-line-setting").on('click', function() {
  var pages = 11;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Line_Setting/'+lng+'/Line_Setting';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Line_Setting');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-live").on('click', function() {
  var pages = 22;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Live/'+lng+'/Live';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Live');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-mall").on('click', function() {
  var pages = 23;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Mall/'+lng+'/Mall';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Mall');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-marketing").on('click', function() {
  var pages = 20;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Marketing/'+lng+'/Marketing';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Marketing');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-order").on('click', function() {
  var pages = 12;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Order/'+lng+'/Order';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Order');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-shipment").on('click', function() {
  var pages = 18;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Shipment/'+lng+'/Shipment';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Shipment');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-starup").on('click', function() {
  var pages = 50;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Starup/'+lng+'/Jambo_Starup';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Jambo_Starup');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-system-setting").on('click', function() {
  var pages = 32;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_System_Setting/'+lng+'/System_Setting';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_System_Setting');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-lucky").on('click', function() {
  var pages = 7;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Lucky/'+lng+'/Lucky';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Lucky');
  $.fancybox.open(png_list, {
    loop : true,
    thumbs : {
      autoStart : true
    }
  });
});


$("#fancybox-pchomepay").on('click', function () {
  var pages = 7;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Pchomepay/'+lng+'/Pchomepay';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Pchomepay');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});


$("#fancybox-receipt").on('click', function () {
  var pages = 30;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_receipt/'+lng+'/Receipt';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Receipt');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});


$("#fancybox-lottory").on('click', function () {
  var pages = 8;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Lottory/'+lng+'/Lottory';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Lottory');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});


$("#fancybox-pre-sale").on('click', function () {
  var pages = 12;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Pre_Sale/'+lng+'/Pre_Sale';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Pre_Sale');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});


$("#fancybox-sms-send").on('click', function () {
  var pages = 17;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_SMS_Send/'+lng+'/SMS_Send';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_SMS_Send');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});


$("#fancybox-replay-order").on('click', function () {
  var pages = 6;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Replay_Order/'+lng+'/Replay_Order';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_Replay_Order');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});

$("#fancybox-tw-sms-setting").on('click', function () {
  var pages = 7;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_TW_SMS/'+lng+'/TW_SMS';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_TW_SMS');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});

$("#fancybox-tw-711-BtoC").on('click', function () {
  var pages = 3;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_711_BtoC/'+lng+'/711_BtoC';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_711_BtoC');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});

$("#fancybox-checkot-robot").on('click', function () {
  var pages = 7;
  var png_path = 'https://jambolive.tv/upload/Consoles/Jambo_Checkot_Robot/'+lng+'/Checkot_Robot';
  var png_list = load_png_list(pages, png_path);
  $.get('/link/'+lng+'_checkot_robot');
  $.fancybox.open(png_list, {
    loop: true,
    thumbs: {
      autoStart: true
    }
  });
});

$('.scrollToTop').click(function(){
	$('html, body').animate({scrollTop : 0},800);
	return false;
});

$('.button_a').click(function(){
	$('html, body').animate({
		scrollTop: $('#sticky_table').position().top},300);
});

//關閉課程通知
function closeit(announcement_id){
  document.getElementById(announcement_id).setAttribute("style", "display:none");
}

$('#id_setting_user').click(function () {
  window.location.assign('/console/setting/user/');
});
</script>

<section class="main-content wrapper">
  <div class="content-area owner_content_area clear" style="padding-top: 10px;">
    <div id="dcalert" style="display: none;">重複操作導致搜尋失敗，請稍候再試</div>
    <div id="main" class="product-preview order-preview clear"
         data-controller="bills-loader user-remark"
         data-bills-loader-language-code="zh-hant"
         data-bills-loader-user-id="27733"
         data-bills-loader-kind="tobeshipped"
         data-bills-loader-provider=""
         data-bills-loader-search="fb"
         data-bills-loader-pickup=""
         data-bills-loader-merge=""
         data-bills-loader-check=""
         data-bills-loader-allot=""
         data-bills-loader-status=""
         data-bills-loader-notship_status=""
         data-bills-loader-payment_method=""
         data-bills-loader-unprinted="all"
         data-bills-loader-shipnote_status=""
         data-bills-loader-filter_shipnotes="all"
         data-bills-loader-filter_shipnotes_checkout="all"
         data-bills-loader-filter_refunds=""
         data-bills-loader-filter_refunds_download=""
         data-bills-loader-filter_refunds_purpose=""
         data-bills-loader-undownloaded=""
         data-bills-loader-invoice_method="all"
         data-bills-loader-invoice_status=""
         data-bills-loader-sms=""
         data-bills-loader-sessions=""
         data-bills-loader-commodities=""
         data-bills-loader-la="all"
         data-bills-loader-begin="2025/04/20 00:00"
         data-bills-loader-end="2025/04/23 00:00"
         data-bills-loader-pay_begin="2025/04/20 00:00"
         data-bills-loader-pay_end="2025/04/23 00:00"
         data-bills-loader-shipnotes_checkout_begin="2025/04/20 00:00"
         data-bills-loader-shipnotes_checkout_end="2025/04/23 00:00"
         data-bills-loader-refunds_refund_begin="2025/04/20 00:00"
         data-bills-loader-refunds_refund_end="2025/04/23 00:00"
         data-bills-loader-serial=""
         data-bills-loader-multi_from_name=""
         data-bills-loader-fb=""
         data-bills-loader-fb_from_name=""
         data-bills-loader-is_from_id=""
         data-bills-loader-commodity=""
         data-bills-loader-commodity_id=""
         data-bills-loader-search_style=""
         data-bills-loader-sn=""
         data-bills-loader-sn_id=""
         data-bills-loader-custom_ship_notes=""
         data-bills-loader-ship_name=""
         data-bills-loader-ship_contact=""
         data-bills-loader-remark=""
         data-bills-loader-extra_remark=""
         data-bills-loader-atm_postfix=""
         data-bills-loader-invoice_number=""
         data-bills-loader-completed="false"
         data-bills-loader-method="GET"
         data-bills-loader-default_order_by="asc"
         data-bills-loader-default_order_item="amount"
         data-bills-loader-amount_limit_lower=""
         data-bills-loader-amount_limit_upper=""
         data-bills-loader-has_shipped_time=""
         data-bills-loader-is_prepared=""
         data-bills-loader-ship_info_in_blacklist=""
         data-bills-loader-skip_check="False"
         data-bills-loader-csrf-token="RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee"
         data-bills-loader-perms_user="44448"
         data-user-remark-user-id="27733"
         data-user-remark-csrf-token="RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee"
         data-action="before-scrolling-to-page-bottom->bills-loader#load_more bills-loaded->user-remark#load">
      <form id="form_search" method="post" action=".">
        <input type='hidden' name='csrfmiddlewaretoken' value='RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee' />
        <div class="manage-form product-edit-tool order-manage-bar clear" style="padding-top: 10px; ">
          
            
            <select class="product-select" name="la" style="width: 30%;  margin-right: 15px;">
              
                <option selected value="all">全部物流API（預設：ZP-711(C2C)）</option>
              
              
                <option value="733">ZP-711(C2C)</option>
              
                <option value="746">ZP-711(B2C)</option>
              
                <option value="8126">翰禹-大榮</option>
              
              
              <option value="no">不支援物流API（自取/PC/蝦皮等）</option>
              <option value="not_use_home">不使用物流API出貨（宅配）</option>
              <option value="">不使用物流API出貨（全部商品）</option>
            </select>
            
          
          
          <select class="product-select" name="provider" style="width: 18%; margin-right: 15px;">
            <option value="">---- 選擇聯賣倉庫 ----</option>
            
            
            <option value="25523">&ensp;嚴選好物</option>
            
            
            
            <option value="47751">&ensp;東森直播Channel5(東森得易購股份有限公司)</option>
            
            
          </select>
          
          
          
          
          
          <select class="product-select" name="unprinted" style="width: 15%; margin-right: 15px;">
            <option value="all"  selected>---- 未列印 ----</option>
            <option value="ship" >未列印出貨單</option>
            <option value="ship_printed" >已列印出貨單</option>
          </select>
          <select class="product-select" name="filter_shipnotes" style="width: 15%; margin-right: 15px;">
            <option value="all"  selected>---- 托運單 ----</option>
            <option value="no_shipnote" >未建立托運單</option>
            <option value="has_shipnote" >已建立托運單</option>
          </select>
          
          
          
          
          
          <select class="product-select" name="invoice_method" style="width: 15%; margin-right: 15px;">
            <option value="all"  selected>---- 發票處理方式 ----</option>
            <option value="donate" >捐贈發票</option>
            <option value="ship" >隨貨寄出</option>
            
            <option value="vat" >統編發票</option>
            
            
            <option value="carruer" >電子載具</option>
            
            
          </select>
          
          
          
          
          
          
          
          
          
          
          <div style="width: 10%;display: none;">
            <input style="height: 30px;width: 49%;line-height: normal;padding: 3px;float: left;" name="amount_limit_lower" type="number" value="" placeholder="金額下限">
            <input style="margin-left: 2%;height: 30px;width: 49%;line-height: normal;padding: 3px;float: left;" name="amount_limit_upper" type="number" value="" placeholder="金額上限">
          </div>
          
          
          
          <a href="/console/export/" target="_blank" class="btn-reg btn-nr f-line f-min" style="float: right;">匯出訂單</a>
          
          <a id="show_sessions" class="btn-reg btn-nr f-line f-min" style="float: right;margin-right: 5px;">輸入場次</a>
          
          <a id="ship_info_in_blacklist" class="btn-reg btn-nr f-line f-min " style="float: right;margin-right: 5px;">黑名單(收件人)</a>
          
          
          <input type="hidden" name="ship_info_in_blacklist" value="False">
        </div>
        <div id="sessions" class="manage-form product-edit-tool order-manage-bar clear" style="padding-top: 5px;width: 100%;display: none;">
          <div style="line-height: 2.2;color: #878787;height:20px;width: 4%;text-align: right;">場次</div>
          <ul id="session_tags" class="tags" style="width: 89%;"></ul>
          <a id="submit_sessions" class="btn-reg btn-nr f-line f-min" style="float: right;margin-right: 5px;">完成</a>
        </div>
        
        <div class="product-preview-header inline-b">
          <div class="manage-form product-edit-tool order-manage-bar clear" style="padding-top: 5px;padding-bottom: 10px;">
            
            <select class="product-select" style="width: 15%; " name="action">
              <option value="default">---- 動作 ----</option>
              
              
                
                
                
                
                <option value="complex">下載出貨單</option>
                
                  
                    <option value="invoice_complex">下載出貨單（含開立發票）</option>
                  
                
                <option value="simple">下載簡易出貨單</option>
                <option value="list_simple">下載簡易出貨明細</option>
                <option value="warehouse">下載倉庫拋轉單</option>
                <option value="warehouse_kind_b">下載倉庫拋轉單(B)</option>
                
                  <option value="warehouse_combined">下載倉庫拋轉單(組合商品)</option>
                  <option value="warehouse_combined_presco">下載倉庫拋轉單(組合商品含數網B2C)</option>
                
                
                <option value="purchase">下載叫貨單</option>
                <option value="purchase_without_date">下載叫貨單（不含日期）</option>
                <option value="purchase_with_supplier">下載叫貨單（含供應商）</option>
                <option value="purchase_with_discount">下載叫貨單（含折扣）</option>
                <option value="purchase_pic">下載含商品圖叫貨單</option>
                <option value="purchase_without_date_pic">下載含商品圖叫貨單（不含日期）</option>
                <option value="purchase_with_supplier_pic">下載含商品圖叫貨單（含供應商）</option>
                <option value="purchase_with_discount_pic">下載含商品圖叫貨單（含折扣）</option>
                <option value="logistic">下載物流總表</option>
                
                
                
                <option value="a4">列印A4出貨單</option>
                
                
                
                
                
                  
                    <option value="invoice_a4">列印A4出貨單（含開立發票）</option>
                    
                  
                
                <option value="thermal">列印熱感出貨單</option>
                
                  
                  
                
                
                
                
                  
                    <option value="invoice_issue">開立（列印）電子發票</option>
                  
                  
                    <option value="invoice_print">列印已開立電子發票</option>
                  
                  
                    <option value="invoice_simple">下載電子發票列表</option>
                  
                
                
                <option value="shipnote_no_format">下載託運單號匯入表格</option>
                <option value="shipnote_no_import">匯入託運單號</option>
                <option value="batch_append_remark">批次新增消費者備註</option>
                <option value="batch_append_extra_remark">批次新增小幫手備註</option>
                
                  
                    <option value="batch_append_reward">批次發放紅利點數</option>
                  
                <option value="batch_append_giveaway">批次發放贈品</option>
                
              
              
              
            </select>
            <input id="shipnote_no_import" type="file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display: none;">
            
            <div style="width: 4.3%"><input id="maxselect" style="height: 30px;width: 100%;line-height: normal;padding: 3px; " type="number" placeholder="選量"></div>
            <div style="width: 10%;line-height: 2.2;color: #878787;height:20px" id="count"></div>
            
            <select class="product-select" style="width: 11%;" name="search">
              
              <option value="commodity">品項名稱</option>
              
              <option value="dates">成立日期</option>
              
              <option value="pay_date">付款日期</option>
              
              
              
              
              <option value="serial">付款單號</option>
              
              <option selected value="fb">FB帳號</option>
              
              
              
              <option value="sn_id">SN託運編號</option>
              
              
              <option value="custom_ship_notes">自建託運單號</option>
              
              <option value="ship_name">收件人姓名</option>
              <option value="ship_contact">收件人電話</option>
              <option value="remark">消費者備註</option>
              <option value="blank_remark">空白消費者備註</option>
              <option value="extra_remark">小幫手備註</option>
              
              
              <option value="invoice_number">發票號碼</option>
              
              
            </select>
            
            
            <input type="text" name="begin" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/20 00:00" placeholder="開始">
            <input type="text" name="end" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/23 00:00" placeholder="結束">
            <input type="text" name="pay_begin" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/20 00:00" placeholder="開始">
            <input type="text" name="pay_end" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/23 00:00" placeholder="結束">
            <input type="text" name="shipnotes_checkout_begin" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/20 00:00" placeholder="開始">
            <input type="text" name="shipnotes_checkout_end" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/23 00:00" placeholder="結束">
            <input type="text" name="refunds_refund_begin" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/20 00:00" placeholder="開始">
            <input type="text" name="refunds_refund_end" class="search order-manage-name" style="line-height: normal;width: calc(11% - 2.5px);display:none;" value="2025/04/23 00:00" placeholder="結束">
            <input type="text" name="serial" class="search order-manage-name" style="line-height: normal;width: 20%;display:none;" value="">
            <input type="text" name="fb" class="search order-manage-name" style="line-height: normal;width: 20%;display:initial;" value="" autocomplete="off">
            <input type="text" name="commodity" class="search order-manage-name" style="line-height: normal;width: 20%;display:none;" value="" autocomplete="off">
            
            
            <input type="text" name="sn" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="sn_id" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            
            <input type="text" name="custom_ship_notes" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="ship_name" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="ship_contact" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="remark" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="extra_remark" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="atm_postfix" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <input type="text" name="invoice_number" class="search order-manage-name" style="line-height: normal;width: 20%;display:none" value="">
            <button type="submit" class="btn-reg btn-nr f-line f-min btn-dark">搜尋</button>
            <button type="button" class="btn-reg btn-nr f-line f-min btn-dark" id="clear">清除</button>
             <!-- split -->
            <input type="hidden" name="fb_from_name" class="search" value="" />
            <input type="hidden" name="commodity_id" class="search" value="" />
            <input type="hidden" name="is_from_id" value="" />
            <style>.ui-menu-item .ui-menu-item-wrapper.ui-state-active {background: yellow !important;}</style>
            <input type="hidden" name="default_order_by" value="asc">
            <input type="hidden" name="default_order_item" value="amount">
            <input type="hidden" name="kind" value="tobeshipped">
            <input type="hidden" name="selected_bill" value="">
            <input type="hidden" name="skip_check" value= "False">
            <select class="product-select" style="width: 18%;float: right;" name="kind" id="switch">
              <option value="shipped">已出貨</option>
              
              <option value="tobepaid">付款待確認</option>
              
              <option value="tobearrived">通知到貨</option>
              
              <option selected value="tobeshipped">未出貨</option>
              
              
                <option value="tobeshipped_notisarrived">&ensp;未出貨未完全到貨</option>
                <option value="tobeshipped_isarrived">&ensp;未出貨已完全到貨</option>
              
              <option value="home">&ensp;未出貨(物流：宅配)</option>
              <option value="store">&ensp;未出貨(物流：超商取貨)</option>
              <option value="pickup">&ensp;未出貨(物流：自取)</option>
              
              <option value="pchomeshopee">&ensp;未出貨(物流：PC/蝦皮)</option>
              <option value="creditcard">&ensp;未出貨(金流：信用卡)</option>
              <option value="smartatm">&ensp;未出貨(金流：智慧轉帳)</option>
              
              <option value="atm">&ensp;未出貨(金流：ATM匯款)</option>
              
              <option value="cod">&ensp;未出貨(金流：貨到付款)</option>
              <option value="c2c">&ensp;未出貨(金流：超取付款)</option>
              <option value="cvscode">&ensp;未出貨(金流：超商代碼)</option>
              <option value="barcode">&ensp;未出貨(金流：超商條碼)</option>
              <option value="linepay">&ensp;未出貨(金流：LINE Pay)</option>
              <option value="fasneypay">&ensp;未出貨(金流：Fasney)</option>
              <option value="zingalapay">&ensp;未出貨(金流：銀角零卡)</option>
              <option value="pgtalkpay">&ensp;未出貨(金流：PGTalk)</option>
              <option value="stripe">&ensp;未出貨(金流：Stripe)</option>
              
              
              
              
                <option value="merge">合併訂單</option>
                <option value="split">指定商品拆單</option>
                
                  <option value="invoice_issue">已開立電子發票</option>
                  <option value="invoice_not_issue">未開立電子發票</option>
                  <option value="invoice_invalid">已作廢電子發票</option>
                  
                    <option value="claimed_invoice_issue">已取件已開立發票</option>
                    <option value="claimed_invoice_not_issue">已取件未開立發票</option>
                  
                
                
                  <option value="all">所有付款單</option>
                
                
              
            </select>
          </div>
        </div>
      </form>
      <table class="manage-table">
        <thead>
          <tr>
            <th>
              
              <input type="checkbox" class="selecctall" /><span class="f-o f-line">全選</span>
              
            </th>
            
            
            <th style="width: 85px;">付款單號</th>
            <th>FB帳號<span data-item="from_id" class="default_order_switch arrow up-arrow"></span></th>
            <th>
              <div>訂單筆數<span data-item="count" class="default_order_switch arrow up-arrow"></span></div>
              
            </th>
            <th>總金額<span data-item="amount" class="default_order_switch arrow up-arrow"></span></th>
            <th style="width: 13%">付款方式</th>
            <th style="width: 105px;">成立時間<span data-item="date" class="default_order_switch arrow up-arrow"></span></th>
            <th>收件人資訊</th>
            <th>備註<button type="button" class="demo-icon btn-icon indent icon-columna-open btn-remarks-more ship-table-remarks-more" data-display="open"></button></th>
            <th>系統備註<button type="button" class="demo-icon btn-icon indent icon-columna-open btn-remarks-more ship-table-remarks-more" data-display="open"></button></th>
            
            <th style="width: 170px;">託運單號<br>電子發票</th>
            
            <th>功能</th>
            
          </tr>
        </thead>
        <tbody data-target="bills-loader.container">
          
        </tbody>
      </table>
      <div class="loading-indicator text-center">
        <button type="button" id="load_more" class="btn-reg btn-nr f-line f-min btn-dark d-none" data-target="bills-loader.loadMore" data-action="click->bills-loader#load_more">
          <span>載入更多</span>
        </button>
        <span class="d-none" data-target="bills-loader.loading">載入中 ...</span>
        <span class="d-none" data-target="bills-loader.loadCompleted">載入完成！</span>
      </div>
    </div><!--order-preview end-->
  </div><!--content-area end-->
</section><!--main-content end-->

<div id="a4" style="display: none;"></div>
<div id="thermal" style="display: none;"></div>

<style>
.td1 {
  vertical-align: middle;
  padding-right: 10px;
  color: #29353f;
  font-weight: bold;
  width: 100px;
}
.input1 {
  border: 2px solid #e75280;
  border-radius: 3px;
  padding: 3px 20px;
  line-height: 1;
  color: #768082;
  resize: none;
  outline: 0;
  width: 100%;
  margin-bottom: 4px;
}
.input2 {
  border: 2px solid #e75280;
  border-radius: 3px;
  color: #768082;
  width: 100%;
  margin-bottom: 4px;
  font-size: inherit;
  text-indent: 10px;
}
.input3 {
  border: 2px solid #e75280;
  border-radius: 3px;
  color: #768082;
  width: 50%;
  padding: 5px 0px;
  margin-bottom: 20px;
  font-size: 16px !important;
  text-indent: 10px;
}
.input4 {
  width: 15px;
  height: 15px;
  vertical-align: middle;
}
.select1 {
  border: 2px solid #e75280;
  border-radius: 3px;
  width: 15%;
  height: 38px;
  padding: 5px 0px;
  line-height: 1.6;
}
.select2 {
  border: 2px solid #e75280;
  border-radius: 3px;
  color: #768082;
  width: 50%;
  padding: 5px 0px;
  margin-bottom: 10px;
  text-indent: 10px;
}
</style>

<div class="site-dialog manage-box edit-box-container">
  <header class="site-dialog-header">
    <h1>編輯付款單</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <table style="width: 100%">
      <tr>
        <td class="td1" align="left">收件人姓名</td>
        <td><input type="text" class="input1" id="ship_name"></td>
      </tr>
      <tr>
        <td class="td1" align="left">收件人電話</td>
        <td><input type="text" class="input1" id="ship_contact"></td>
      </tr>
      <tr>
        <td class="td1" align="left">收件人Email</td>
        <td><input type="text" class="input1" id="email"></td>
      </tr>
      <tr>
        <td class="td1" align="left">收件人地址</td>
        <td><input type="text" class="input1" id="ship_address"></td>
      </tr>
      <tr>
        <td class="td1" align="left">區碼</td>
        <td><input type="text" class="input1" maxlength="3" id="ship_zipcode"></td>
      </tr>
      <tr id="pm">
        <td class="td1" align="left">付款方式</td>
        <td>
          <select class="input2" id="payment_method">
            <option value="cod">貨到付款</option>
            
            <option value="atm">匯款</option>
            
            <option value="shopee">蝦皮</option>
            <option value="pchome">PC Home</option>
            <option value="pickup">自取</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="td1" align="left">運費</td>
        <td><input type="number" min=0 class="input1" id="shipping_fee"></td>
      </tr>
      
      <tr id="postfix">
        <td class="td1" align="left">後五碼</td endif >
        <td><input type="text" class="input1" id="atm_postfix"></td>
      </tr>
      <tr>
        <td class="td1" align="left">消費者備註</td>
        <td><textarea rows="5" class="input1" id="remark"></textarea></td>
      </tr>
      <tr>
        <td class="td1" align="left">小幫手備註</td>
        <td><textarea rows="12" class="input1" id="extra_remark"></textarea></td>
      </tr>
      <tr>
        <td class="td1" align="left">系統備註</td>
        <td><textarea rows="8" class="input1" id="system_remark"></textarea></td>
      </tr>
      <tr>
        <td class="td1" align="left">託運單號</td>
        <td><textarea rows="4" class="input1" id="custom_ship_notes"></textarea></td>
      </tr>
      <tr>
        <td class="td1" align="left">託運件數</td>
        <td><input type="number" min="1"  class="input1" id="logistic_number"></td>
      </tr>
      
      <tr>
        <td class="td1" align="left">託運指定日期</td>
        <td><input type="text" class="input1" id="logistic_date"></td>
      </tr>
      
      <tr>
        <td class="td1" align="left">發票處理方式</td>
        <td>
          <select class="input2" id="invoice_method">
            <option value="">----</option>
            <option value="donate">捐贈發票</option>
            <option value="ship">隨貨寄出</option>
            
            <option value="vat">統編發票</option>
            
            
            <option value="carruer">電子載具</option>
            
            
          </select>
        </td>
      </tr>
      <tr>
        <td class="td1" align="left">手機條碼載具 / 發票抬頭</td>
        <td><input type="text" class="input1" id="carruer_code"></td>
      </tr>
      <tr>
        <td class="td1" align="left">發票統編</td>
        <td><input type="text" class="input1" id="buyer_vat"></td>
      </tr>
      <tr>
        <td class="td1" align="left">發票捐贈碼</td>
        <td><input type="text" class="input1" id="love_code"></td>
      </tr>
      
    </table>
  </div>
</div>

<div class="site-dialog manage-box sinopac-refund-box-container">
  <header class="site-dialog-header">
    <h1>智慧轉帳退款</h1>
  </header>
  <div class="site-dialog-content" style="width: 100%; text-align: -webkit-center;">
    <select class="select2" name="sinopac_refund_type">
      <option value="all" selected>全額退款</option>
      <option value="part">部分退款</option>
    </select>
    <table class="manage-table" id="refund_orders_detail" style="display: none;">
      <thead>
        <tr>
          <th style="width: 2%;"></th>
          <th style="width: 10%;">圖片</th>
          <th style="width: 10%;">品項名稱</th>
          <th style="width: 10%;">訂單編號</th>
          <th style="width: 20%;">規格</th>
          <th style="width: 8%;">日期</th>
          <th style="width: 5%;">金額</th>
          <th style="width: 5%;">數量</th>
          <th style="width: 5%;">折扣</th>
          <th style="width: 5%;">小計</th>
          <th style="width: 15%;">備註</th>
        </tr>
      </thead>
      <tbody id="target_refund">
      </tbody>
    </table>
  </div>
</div>

<div class="site-dialog manage-box refund-box-container">
  <header class="site-dialog-header">
    <h1>編輯退款單</h1>
  </header>
  <div class="site-dialog-content" style="width: 100%; text-align: -webkit-center;">
    <table id="refund_table" style="width: 40%">
      <tr>
        <td class="td1" align="left">原因</td>
        <td>
          <select class="input1" id="refund_purpose">
            <option value="merge">併單 (無)</option>
            <option value="mergeshippingfee">併單 (需退運費)</option>
            <option value="split">拆單</option>
            <option value="other" selected>其他</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="td1" align="left">退款方式</td>
        <td>
          <select class="input1" id="refund_method">
            <option value="cash">退款</option>
            <option value="creditcard">退刷</option>
            <option value="linepay">退刷 (LINE Pay)</option>
            <option value="reward" selected>退紅利</option>
            <option value="other">其他</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="td1" align="left">退款金額</td>
        <td><input type="number" min=0 class="input1" id="refund_amount"></td>
      </tr>
      <tr>
        <td class="td1" align="left">銀行代號</td>
        <td><input type="text" class="input1" id="refund_bank_code"></td>
      </tr>
      <tr>
        <td class="td1" align="left">銀行帳號</td>
        <td><input type="text" class="input1" id="refund_bank_account"></td>
      </tr>
      <tr>
        <td class="td1" align="left">銀行戶名</td>
        <td><input type="text" class="input1" id="refund_bank_account_username"></td>
      </tr>
      <tr>
        <td class="td1" align="left">備註</td>
        <td><textarea rows="4" class="input1" id="refund_extra_remark"></textarea></td>
      </tr>
    </table>
    <div class="refund-btn">
      <button type="button" class="btn-reg btn-nr f-line f-min" id="refund_btn">新增</button>
      <button type="button" class="btn-reg btn-nr f-line f-min" id="refund_cancel_btn" style="display: none;">取消</button>
    </div>
    <table class="manage-table">
      <thead>
        <tr>
          <th style="width: 10%;">建立時間</th>
          <th style="width: 10%;">退款時間</th>
          <th style="width: 5%;">原因</th>
          <th style="width: 5%;">方式</th>
          <th style="width: 8%;">金額</th>
          <th style="width: 12%;">退款資訊</th>
          <th style="width: 15%;">敘述</th>
          <th style="width: 12%;">備註</th>
          <th style="width: 10%;">操作者</th>
          <th style="width: 8%;">功能</th>
        </tr>
      </thead>
      <tbody id="refund_detail">
      </tbody>
    </table>
  </div>
</div>

<div class="site-dialog manage-box force_merge-box-container">
  <header class="site-dialog-header">
    <h1>選擇主付款單</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <span>付款單編號</span>
    <select class="input1"  id="force_merge_main_bill"></select>
  </div>
</div>

<div class="site-dialog manage-box sms-box-container">
  <header class="site-dialog-header">
    <h1>輸入SMS簡訊內容</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <textarea id="sms_content" class="input1" style="height: 150px;"></textarea>
    <div>字數：<span id="sms_count">0</span>（每67個字算1則簡訊）</div>
    
  </div>
</div>

<div class="site-dialog manage-box pay-alert-box-container">
  <header class="site-dialog-header">
    <h1>未付款通知內容</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <textarea id="pay_alert_content" class="input1" style="height: 150px;">親愛的粉絲，您到目前為止還有付款單號：「{{ serial }}」尚未完成付款作業。請您儘速完成付款，避免您的權益受損。感謝您的支持。</textarea>
    <label><input type="checkbox" name="send_type" value="app" /><span></span> 以APP通知</label>
    
    
  </div>
</div>

<div class="site-dialog manage-box remark-box-container">
  <header class="site-dialog-header">
    <h1>批次新增消費者備註</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <textarea id="batch_append_remark_content" class="input1" style="height: 150px;"></textarea>
  </div>
</div>

<div class="site-dialog manage-box extra-remark-box-container">
  <header class="site-dialog-header">
    <h1>批次新增小幫手備註</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <textarea id="batch_append_extra_remark_content" class="input1" style="height: 150px;"></textarea>
  </div>
</div>

<div class="site-dialog manage-box reward-box-container">
  <header class="site-dialog-header">
    <h1>批次發放紅利點數</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <label style="display: block; text-align: center;">
      紅利點數 : 
      <input type="number" id="batch_append_reward_input" class="input1" style="width: 75%;" min="0">
    </label>
  </div>
</div>

<div class="site-dialog manage-box giveaway-box-container">
  <header class="site-dialog-header">
    <h1>批次發放贈品</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <label style="display: block; text-align: center;">
      商品 : 
      <input type="text" name="giveaway_search" class="input1" style="width: 75%;" placeholder="搜尋商品" value="" autocomplete="off">
      <input type="hidden" id="batch_append_giveaway_input" name="giveaway_id" value="">
    </label>
    <label style="display: block; text-align: center;">
      樣式 : 
      <input name="giveaway_style_search" class="input1" style="width: 75%;" placeholder="搜尋樣式" autocomplete="off">
      <input type="hidden" id="batch_append_giveaway_style_input" name="giveaway_style" value="">
      <input type="hidden" id="batch_append_giveaway_sub_style_input" name="giveaway_sub_style" value="">
    </label>
    <label style="display: block; text-align: center;">
      數量 : 
      <input type="number" id="batch_append_giveaway_quantity_input" class="input1" min="1" style="width: 75%;">
    </label>
  </div>
</div>

<div class="site-dialog manage-box shipnotes-checkout-box-container">
  <header class="site-dialog-header">
    <h1>出貨掃描</h1>
  </header>
  <div class="site-dialog-content">
    <label style="display: block; text-align: center;">
      託運單號或付款單號 : 
      <input type="text" class="input3" id="shipnote">
      <select class="select1" id="checkout_purpose" name="checkout_purpose">
        <option value="checkout">打包</option>
        <option value="ship">出貨</option>
      </select>
      
    </label>
    <table class="manage-table">
      <thead>
        <tr>
          <th style="width: 10%;">付款單號</th>
          <th style="width: 10%;">成立時間</th>
          <th style="width: 10%;">託運單號</th>
          <th style="width: 10%;">打包時間</th>
          <th style="width: 10%;">狀態</th>
        </tr>
      </thead>
      <tbody id="shipnotes_checkout_detail" style="text-align: center;">
      </tbody>
    </table>
  </div>
</div>

<div class="site-dialog manage-box commodities-checkout-box-container">
  <header class="site-dialog-header">
    <h1>掃描商品</h1>
  </header>
  <div class="site-dialog-content">
    <label style="display: block; text-align: center;">
      商品條碼 : 
      <input type="text" class="input3" id="commodity_barcode">
      數量 : 
      <input type="text" class="input3" style="width: 10%;" value="1" id="commodity_quantity">
      <span style="font-size: 14px;">
        <span id="rest_commodity_quantity"></span>/<span id="total_commodity_quantity"></span>
      </span>
    </label>
    <table class="manage-table">
      <thead>
        <tr>
          <th style="width: 10%;">訂單編號</th>
          <th style="width: 20%;">品項名稱</th>
          <th style="width: 5%;">數量</th>
          <th style="width: 5%;">狀態</th>
        </tr>
      </thead>
      <tbody id="commodities_checkout_detail" style="text-align: center;">
      </tbody>
    </table>
  </div>
</div>

<div id="enlarge" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    display: none;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 20px;
">
<img class="enlarge-photo">
</div>

<audio id="alert-sound" src="/static/audio/alert.wav" style="display:none; width:0px;"></audio>

<!--20181218 新增 出貨商品明細 start-->
<div class="site-dialog manage-box view-delivery-box-container">
  <header class="site-dialog-header">
    <h1>訂單明細</h1>
  </header>
  <div class="site-dialog-content">
    <table class="manage-table" id="orders_detail">
      <thead>
        <tr>
          <th style="width: 2%;"></th>
          <th style="width: 10%;">圖片</th>
          <th style="width: 10%;">品項名稱</th>
          <th style="width: 10%;">訂單編號</th>
          <th style="width: 20%;">規格</th>
          <th style="width: 8%;">日期</th>
          <th style="width: 5%;">金額</th>
          <th style="width: 5%;">數量</th>
          <th style="width: 5%;">折扣</th>
          <th style="width: 5%;">小計</th>
          <th style="width: 15%;">備註</th>
          <th style="width: 5%;">功能</th>
        </tr>
      </thead>
      <tbody id="target">
      </tbody>
    </table>
  </div>
</div>
<!--出貨商品明細 end-->

<!--未成立訂單明細 start-->
<div class="site-dialog manage-box view-add-order-box-container">
  <header class="site-dialog-header">
    <h1>未成立訂單明細</h1>
  </header>
  <div class="site-dialog-content">
    <table class="manage-table" id="add_orders_detail">
      <thead>
        <tr>
          <th style="width: 2%;">
            <input type="checkbox" class="select-all-orders" /><span class="f-o f-line">全選</span>
          </th>
          <th style="width: 10%;">圖片</th>
          <th style="width: 10%;">品項名稱</th>
          <th style="width: 10%;">訂單編號</th>
          <th style="width: 20%;">規格</th>
          <th style="width: 8%;">日期</th>
          <th style="width: 5%;">金額</th>
          <th style="width: 5%;">數量</th>
          <th style="width: 5%;">折扣</th>
          <th style="width: 5%;">小計</th>
          <th style="width: 15%;">備註</th>
        </tr>
      </thead>
      <tbody id="target_add">
      </tbody>
    </table>
  </div>
</div>
<!--未成立訂單明細 end-->

<!--2FA驗證 start-->
<div class="site-dialog verify-box report-2fa">
  <header class="site-dialog-header">
    <h1>驗證</h1>
  </header>
  <div class="site-dialog-content">
    <div class="dialog-notice theme admin-form">
      <div class="admin-form-item" style="width: 100%;" id="id_report_2fa">
        <label for="authenticator_code">請輸入 Google 驗證碼：</label>
        <input type="text" id="authenticator_code" name="authenticator_code" value="" required>
      </div>
    </div>
  </div>
</div>
<!--2FA驗證 end-->

<!--custom-invoice start-->
<div class="site-dialog manage-box custom-invoice-container">
  <header class="site-dialog-header">
    <h1>編輯自訂發票號碼</h1>
  </header>
  <div class="site-dialog-content" style="padding: 30px; width: 70%;">
    <table style="width: 100%">
      <tr>
        <td class="td1" align="left">發票號碼</td>
        <td><input type="text" class="input1" id="custom_invoice_number"></td>
      </tr>
    </table>
  </div>
</div>
<!--custom-invoice end-->

<div class="site-dialog manage-box issue-allowance-box-container">
  <header class="site-dialog-header">
    <h1><span id="allowance_invoice_number"></span>開立折讓</h1>
  </header>
  <div class="site-dialog-content">
    <table class="manage-table">
      <thead>
        <tr>
          <th></th>
          <th>品項名稱</th>
          <th>數量</th>
          <th>單價</th>
        </tr>
      </thead>
      <tbody id="orders_to_be_allowanced">
      </tbody>
    </table>
  </div>
</div>

<div class="site-dialog manage-box show-allowance-box-container">
  <header class="site-dialog-header">
    <h1>折讓明細</h1>
  </header>
  <div class="site-dialog-content">
    <table class="manage-table">
      <thead>
        <tr>
          <th>折讓編號</th>
          <th>名稱</th>
          <th>開立時間</th>
          <th>作廢時間</th>
          <th>金額</th>
          <th>功能</th>
        </tr>
      </thead>
      <tbody id="allowance_list">
      </tbody>
    </table>
  </div>
</div>

<script id="allowances_template" type="x-tmpl-mustache">
  <tr>
    <td>
      <h3>[[ number ]]</h3>
    </td>
    <td>
      <h3>[[ name ]]</h3>
    </td>
    <td>
      <span>[[ issued_time ]]</span>
    </td>
    <td>
      <span>[[ invalid_time ]]</span>
    </td>
    <td>
      <p class="theme align-c">[[ amount ]]</p>
    </td>
    <td>
      [[ #issued_time ]]
      [[ ^invalid_time ]]
      <div class="product-edit-tool order-manage-edit inline-b align-c">
        <button type="button" class="btn-icon icon-o icon-trash btn-theme indent btn-invalid-allowance" title="作廢" data-bill_id="[[ bill_id ]]" data-number="[[ number ]]"><span>作廢</span></button>
      </div>
      [[ /invalid_time ]]
      [[ /issued_time ]]
    </td>
  </tr>
</script>








<script id="select_page_cu_template" type="x-tmpl-mustache">
  [[ #has_cus ]]
  <select class="product-select" id="select_page_cu">
    <option value="">--請選擇訊息來源--</option>
    [[ #cus ]]
    <option value='[[ id ]]' data-from_id='[[ from_id ]]' data-from_name='[[ from_name ]]' data-from_picture='[[ from_picture ]]' data-page_name='[[ page_name ]]' data-line_messaging_channel_token='[[ line_messaging_channel_token ]]'>[[ page_name ]]</option>
    [[ /cus ]]
  </select>
  [[ /has_cus ]]
  [[ ^cus ]]
  <span>無可回覆私訊</span>
  [[ /cus ]]
</script>

<script id="chat_template" type="x-tmpl-mustache">
  [[ #messages ]]
  <div class="chat-message [[ #is_cu ]]left[[ /is_cu ]][[ ^is_cu ]]right[[ /is_cu ]][[ #is_temp ]] temp[[ /is_temp ]]">
    [[ #is_cu ]]
    <div class="chat-avatar">
      <img src="[[ from_picture ]]" alt="Avatar">
      <div class="chat-name">[[ from_name ]]</div>
    </div>
    [[ /is_cu ]]
    <div class="chat-content">
      <div class="chat-text chat-[[ #is_cu ]]buyer[[ /is_cu ]][[ ^is_cu ]]seller[[ /is_cu ]]">
        [[ #text ]]
        <span class="message message-text-[[ #is_cu ]]buyer[[ /is_cu ]][[ ^is_cu ]]seller[[ /is_cu ]]" style="white-space: pre-wrap">[[ text ]]</span>
        [[ /text ]]
        [[ #is_image ]]
        <div><img style="width: 30%" src="[[ attachment_url ]]"></div>
        [[ /is_image ]]
        [[ #is_video ]]
        <div><video style="width: 30%" src="[[ attachment_url ]]"></div>
        [[ /is_video ]]
      </div>
      <div class="chat-time clear">
        [[ #is_temp ]]
        <span class="temp_text">傳送中...</span>
        [[ /is_temp ]]
        [[ ^is_temp ]]
        <span>[[ created_time ]]</span>
        [[ /is_temp ]]
      </div>
    </div>
    [[ ^is_cu ]]
    <div class="chat-avatar">
      <div class="chat-name">[[ from_name ]]</div>
    </div>
    [[ /is_cu ]]
  </div>
  [[ /messages ]]
</script>
<!-- 私訊 start -->
<div class="site-dialog manage-box mesg-box-container fan_message">
  <header class="site-dialog-header mesg-dialog-header">
    <h1>對話訊息</h1>
  </header>
  <div class="messenger-container">
    <div class="select_page_area" style="text-align: center; margin-top: 10px">
    </div>
    <div class="chat_area">
      <div class="chat-container">
      </div>
      <div class="theme">系統僅會保留7日內訊息 <span style="float: right" id="connect_status"></span></div>
      <div class="messenger-footer">
        <textarea rows="1" placeholder="輸入訊息" class="message-input" id="fan_message_text"></textarea>
        <button style="right: 10px" class="send-button" id="fan_message_send" data-cu_id="">
          <svg class="messenger-send" id="Icon_ionic-ios-send" data-name="Icon ionic-ios-send" xmlns="http://www.w3.org/2000/svg" width="33.064" height="33.062" viewBox="0 0 33.064 33.062">
            <path id="Icon_ionic-ios-send-2" data-name="Icon ionic-ios-send" d="M26.147.06.335,11.31a.592.592,0,0,0,.021,1.076l6.982,3.945A1.126,1.126,0,0,0,8.625,16.2L22.392,4.335c.091-.077.309-.225.394-.141s-.049.3-.127.394L10.748,18a1.122,1.122,0,0,0-.113,1.343l4.563,7.32a.594.594,0,0,0,1.069-.014L26.941.841A.592.592,0,0,0,26.147.06Z" transform="matrix(0.966, 0.259, -0.259, 0.966, 6.987, 0)"/>
          </svg>
        </button>
        <!-- <button class="add-shopping-cart">
          <svg class="ic-add-shopping-cart" id="shopping-cart-arrow-up" xmlns="http://www.w3.org/2000/svg" width="35.636" height="33.816" viewBox="0 0 35.636 33.816">
            <path id="Union_41" data-name="Union 41" d="M-7238.61-6392.185a2.5,2.5,0,0,1,2.5-2.5,2.5,2.5,0,0,1,2.5,2.5,2.5,2.5,0,0,1-2.5,2.5A2.5,2.5,0,0,1-7238.61-6392.185Zm-17,0a2.5,2.5,0,0,1,2.5-2.5,2.5,2.5,0,0,1,2.5,2.5,2.5,2.5,0,0,1-2.5,2.5A2.5,2.5,0,0,1-7255.611-6392.185Zm.359-4.507a1.219,1.219,0,0,1-1.194-.981l-4.679-23.391H-7265v-2.436h4.875a1.217,1.217,0,0,1,1.194.979l3.216,16.08h21.42l2.434-10.967h2.5l-2.764,12.449a1.219,1.219,0,0,1-1.188.956h-21.911l.976,4.874h20.935v2.438Zm3.656-19.5,1.723-1.721,4.371,4.369v-9.957h2.436v9.957l4.37-4.369,1.723,1.721-7.312,7.311Z" transform="translate(7265 6423.499)"/>
          </svg>
        </button> -->
      </div>
    </div>
  </div>
</div>
<!-- 私訊 end -->

<script>
var socket = null;
var chat_cu = null;

function checkConnection() {
  if (socket && socket.readyState === WebSocket.OPEN) {
    $('#connect_status').html('連線中');
  } else {
    $('#connect_status').html('連線已中斷 <span style="cursor: pointer" onclick="reconnect()">&#8634;</span>');
  }
}

setInterval(checkConnection, 3000);

function reconnect() {
  $('#select_page_cu').trigger('change');
}

const fetchLineContents = (messages, accessToken) => {
  const imagePromises = [];
  messages.forEach(message => {
    const promise = new Promise((resolve, reject) => {
      if (message.source === 'line' && (message.is_image || message.is_video)) {
        fetch(message.attachment_url, {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        })
        .then((response) => {
          if (!response.ok) {
            console.log('Fetch Line content fail!');
          }
          resolve(message);
        })
        .catch(error => {
          console.log(error);
          resolve(message);
        })
      } else {
        resolve(message);
      }
    });
    imagePromises.push(promise);
  });
  return Promise.all(imagePromises);
}

function fanMessage(from_id) {
  
  alert('權限尚未開啟，請聯繫您的直播顧問。');
  return;
  
  $('.chat_area').hide();
  $('.select_page_area').html('');
  $.post('/console/api/messages/', { 'from_id': from_id }, function(data) {
    Mustache.tags = ['[[', ']]'];
    data.has_cus = data.cus.length;
    var template = document.getElementById('select_page_cu_template').innerHTML;
    var rendered = Mustache.render(template, data);
    $('.select_page_area').html(rendered);
    $('.select_page_area').show();
    var dialog = $('.fan_message');
    dialog.dialog({
      width: 600,
      maxHeight: 660,
    });
    dialog.dialog('open');
    if (data.cus.length == 1) {
      $('#select_page_cu').find('option').eq(1).prop('selected', true).parent().trigger('change');
    }
  });
}

$(document).on('change', '#select_page_cu', function() {
  var cu_id = $('#select_page_cu').val();
  $('.select_page_area').hide('');
  if (socket && socket.readyState == WebSocket.OPEN && chat_cu && cu_id === chat_cu.id) {
    $('.chat_area').show();
    $(".fan_message").dialog("option", "position", {my: "center", at: "center", of: window});
    $('.chat-container').scrollTop($('.chat-container').prop('scrollHeight'));
    return;
  }
  if (!cu_id) {
    return;
  }
  if (socket) {
    socket.close();
  }
  $('.chat-container').html('');
  var option = $('#select_page_cu option:selected');
  chat_cu = {
    'id': cu_id,
    'from_id': option.attr('data-from_id'),
    'from_name': option.attr('data-from_name'),
    'from_picture': option.attr('data-from_picture'),
    'page_name': option.attr('data-page_name'),
    'line_messaging_channel_token': option.attr('data-line_messaging_channel_token'),
  }
  $('#fan_message_send').attr('data-cu_id', cu_id);
  socket = new WebSocket("wss://" + window.location.host + "/ws/chat/" + cu_id + "/");
  socket.onmessage = function(e) {
    var content = JSON.parse(e.data);
    if (content.action === 'enter' || content.action === 'update') {
      $('.chat-container').find('.temp').remove();
      fetchLineContents(content.messages.filter(message => message.source === 'line' && (message.is_image || message.is_video)), chat_cu.line_messaging_channel_token).finally(() => {
        for (var i=0; i<content.messages.length; i++) {
          if (content.messages[i].sender_id === chat_cu.from_id) {
            content.messages[i].is_cu = true;
            content.messages[i].from_name = chat_cu.from_name;
            content.messages[i].from_picture = chat_cu.from_picture;
          } else {
            content.messages[i].is_cu = false;
            content.messages[i].from_name = chat_cu.page_name;
          }
        }
        var template = document.getElementById('chat_template').innerHTML;
        var rendered = Mustache.render(template, content);
        if (content.action === 'enter') {
          $('.chat-container').html(rendered);
          $('.chat_area').show();
          checkConnection();
        } else {
          $('.chat-container').append(rendered);
        }
        $('.chat-container').scrollTop($('.chat-container').prop('scrollHeight'));
      });
    } else if (content.action === 'send') {
      if (content.result) {
        $('#fan_message_text').val('');
      } else {
        $('.chat-container').find('.temp .temp_text').html('發送失敗')
        if (content.error) {
          alert(JSON.stringify(content.error));
        } else {
          alert('fail');
        }
      }
      $('#fan_message_send').removeAttr('disabled');
    }
    $(".fan_message").dialog("option", "position", {my: "center", at: "center", of: window});
  }
  socket.onopen = function() {
    socket.send(JSON.stringify({'action': 'enter'}));
  }
  // Call onopen directly if socket is already open
  if (socket.readyState == WebSocket.OPEN) socket.onopen();
});

$(document).on('click', '#fan_message_send', function() {
  const text = $('#fan_message_text').val();
  const cu_id = $('#fan_message_send').attr('data-cu_id');
  if (!cu_id || !text) {
    return;
  }
  $('#fan_message_send').attr('disabled', 'disabled');
  socket.send(JSON.stringify({'action': 'send', 'text': text}));
  var template = document.getElementById('chat_template').innerHTML;
  var content = {'messages': [{
    'is_temp': true,
    'text': text,
    'is_cu': false,
    'from_name': chat_cu.page_name,
  }]}
  var rendered = Mustache.render(template, content);
  $('#fan_message_text').val('');
  $('.chat-container').append(rendered);
  $('.chat-container').scrollTop($('.chat-container').prop('scrollHeight'));
});
$('#fan_message_text').keydown(function(event) {
  if ((event.which === 13 || event.keyCode === 13) && !event.shiftKey) {
    $('#fan_message_send').trigger('click');
  }
});
</script>


<!--網站公告 start -->



<input id="user_id" class="user_id" type="hidden" value="44448">
<input name="is_read" id="is_read" type="hidden" value="false">


<script>
  function pop_dialog(billboard_queue=[],content_queue=[]){
    if (billboard_queue.length) {
      const dialog_class = billboard_queue.pop();
      const dialog_content = content_queue.pop();
      var dialog = $(`.${dialog_class}`);
      dialog.dialog({
        autoOpen: false,
        modal: true,
        closeText: ' ',
        width: 850,
        minHeight: 300,
        dialogClass: "site-box",
      });
      var user_id = document.getElementById('user_id');
      dialog.dialog({
        dialogClass: "item-notice-box",
        buttons: {
          "OK": function () {
            if ($('.billboard_read').is(":checked")) {
              $.post(`/console/api/billboard/update/${user_id.value}/`, {csrfmiddlewaretoken: 'RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee',}, function (response) {});
              $('input[name="is_read"]').val("true");
            };
            dialog.dialog("close");
            dialog.find("iframe").attr("src", "");
            dialog.find('video, source').each(function () {$(this).attr('src', '')})
            dialog.find('video').each(function () {this.load()})
          }
        },
        open: function() {
          $(`.${dialog_class} .site-dialog-content`).html(dialog_content)
        }
      });
      dialog.dialog("open");
      $(".ui-dialog-buttonset").find("button").show();
    } else {
      setTimeout(function(){show_billboard()},1000*60*30);
    }
  }

  function show_billboard(first=false){
    var check = document.getElementById('is_read').value;
    if (check == 'true') {
      return
    }
    var billboard_queue = [];
    var content_queue = [];
    
    pop_dialog(billboard_queue,content_queue);
    $('.site-dialog').on('dialogclose', function (event) {
      setTimeout(() => {
        pop_dialog(billboard_queue,content_queue);
      }, 100);
    });
  }

  $(document).ready(function() {
    
    setTimeout(function(){show_billboard()},1000*60*30);
    
  });

  

  
</script>

<!-- 網站公告 end-->


<script>
document.getElementById("header-ship").className += " btn-helper-active";
$('#header-ship').removeAttr('target');
$(window).scroll(_.throttle(function() {
  var el = $(this);
  var scrollTop = el.scrollTop();
  var height = el.height();
  var documentHeight = $(document).height();

  if (scrollTop + height >= documentHeight - documentHeight / 5) {
    document.getElementById("main").dispatchEvent(new Event('before-scrolling-to-page-bottom'))
  }
}, 100));

(() => {
  const application = Stimulus.Application.start()

  application.register("bills-loader", BillsLoaderController)
  application.register("user-remark", UserRemarkController)
})()

var lazyLoadInstance = new LazyLoad();

document.getElementById("main").addEventListener("bills-list-loading", function(event) {
  $("#count .loading").show()
})
document.getElementById("main").addEventListener("bills-list-loaded", function(event) {
  $("#count .loading").hide()
  showCount();
})
document.getElementById("main").addEventListener("bills-loading", function(event) {
  // do nothing, for now
})
document.getElementById("main").addEventListener("bills-loaded", function(event) {
  lazyLoadInstance.update();
  let remarksDisplay = localStorage.getItem("remarksDisplay");
  if (remarksDisplay == "close") {
    $(".ship-table-remarks-more").attr("data-display", "close");
    $(".ship-table-remarks-more").removeClass("icon-columna-open");
    $(".ship-table-remarks-more").addClass("icon-columna-close");
    $(".remark_info").removeClass("remark-close");
    $(".ship-table-remark-more").removeClass("rotate");
    $(".remark_info").toggleClass("remark-close");
    $(".ship-table-remark-more").toggleClass("rotate");
  }
})
document.getElementById("main").addEventListener("bills-all-loaded", function(event) {
  // do nothing, for now
})
</script>
<script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/js/plugin.js"></script>
<script src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/console2/js/manage.js"></script>
<script>
function csrfSafeMethod(method) {
		// these HTTP methods do not require CSRF protection
		return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

var csrftoken = "RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee";
$.ajaxSetup({
	beforeSend: function (xhr, settings) {
		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
			xhr.setRequestHeader("X-CSRFToken", csrftoken);
		}
	}
});
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"933eba305faae3a0","serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.4.0-1-g37f21b1","token":"c4c597f16d8e410b92a752d248622898"}' crossorigin="anonymous"></script>
</body>
</html>

<script>
var is_multi_from_name = false;
var multi_from_name_length = 0;
var current_checkout_bill_id = null;
var child_shipnote_window = null;
var has_refunds = false;
var checkouted_order_ids = []

$('input[name="multi_from_name"]').click(function() {
  is_multi_from_name = is_multi_from_name ? false : true;
  multi_from_name_length = 0;
  $('input[name="fb"]').val('');
  $('input[name="fb_from_name"]').val('');
});

$("#ship_info_in_blacklist").click(function() {
  if ($("input[name='ship_info_in_blacklist']").val() === "False") {
    $("input[name='ship_info_in_blacklist']").val("True");
    $("#ship_info_in_blacklist").addClass("btn-click");
  } else {
    $("input[name='ship_info_in_blacklist']").val("False");
    $("#ship_info_in_blacklist").removeClass("btn-click");
  }
  $("#form_search").submit();
});

function toCommas(value) {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

$('#fb').click(function() {
  window.location.assign('/console/logout/?next=/console/ship/');
});

$('#show_sessions').click(function() {
  $('#sessions').show();
});

$('#submit_sessions').click(function() {
  $("#form_search").submit();
});

$('#submit_commodities').click(function() {
  $("#form_search").submit();
});

function clearSinopacRefundDialog() {
  $("select[name='sinopac_refund_type']").val("all");
  $("#refund_orders_detail").hide();
}

function closeSinopacRefundDialog() {
  clearSinopacRefundDialog();
  $(".sinopac-refund-box-container").dialog("close");
}

function lockRefundDialog(is_merge_shipping_fee=false) {
  if (is_merge_shipping_fee) {
    $("#refund_purpose").attr("disabled", true);
    $("#refund_amount").attr("disabled", true);
  } else {
    $("#refund_purpose").attr("disabled", true);
    $("#refund_method").attr("disabled", true);
    $("#refund_amount").attr("disabled", true);
    $("#refund_bank_code").attr("disabled", true);
    $("#refund_bank_account").attr("disabled", true);
    $("#refund_bank_account_username").attr("disabled", true);
  }
}

function unlockRefundDialog() {
  $("#refund_purpose").attr("disabled", false);
  $("#refund_method").attr("disabled", false);
  $("#refund_amount").attr("disabled", false);
  $("#refund_bank_code").attr("disabled", false);
  $("#refund_bank_account").attr("disabled", false);
  $("#refund_bank_account_username").attr("disabled", false);
}

function clearRefundDialog() {
  $("#refund_purpose").val("other");
  $("#refund_method").val("reward");
  $("#refund_amount").val("");
  $("#refund_bank_code").val("");
  $("#refund_bank_account").val("");
  $("#refund_bank_account_username").val("");
  $("#refund_extra_remark").val("");
  unlockRefundDialog();
}

function closeRefundDialog() {
  clearRefundDialog();
  switchRefundButton();
  $('#refund_detail').html("");
  $(".refund-box-container").dialog("close");
}

function switchRefundButton() {
  $("#refund_btn").text("新增");
  $("#refund_btn").attr("data-action", 'add');
  $("#refund_cancel_btn").hide();
}

function editRefund() {
  let refund_id = $(this).attr("data-id");
  let purpose = $(this).attr("data-purpose");
  let refund_method = $(this).attr("data-refund_method");
  let amount = $(this).attr("data-amount");
  let bank_code = $(this).attr("data-bank_code");
  let bank_account = $(this).attr("data-bank_account");
  let bank_account_username = $(this).attr("data-bank_account_username");
  let extra_remark = $(this).attr("data-extra_remark");
  let refund_table = document.getElementById("refund_table");
  let refund_lock = $(this).attr("data-lock");

  $("#refund_purpose").val(purpose);
  $("#refund_method").val(refund_method);
  $("#refund_amount").val(amount);
  $("#refund_bank_code").val(bank_code);
  $("#refund_bank_account").val(bank_account);
  $("#refund_bank_account_username").val(bank_account_username);
  $("#refund_extra_remark").val(extra_remark);

  $("#refund_btn").text("更新");
  $("#refund_btn").attr("data-refund_id", refund_id);
  $("#refund_btn").attr("data-action", 'update');
  $("#refund_cancel_btn").show();

  unlockRefundDialog();

  if (refund_lock) {
    lockRefundDialog();
  } else if (purpose == 'mergeshippingfee') {
    
  }

  refund_table.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
}

function updateRefundShippingFee(bill_id, refund_amount, refund_method) {
  let target_bill = $("tr[data-id='" + bill_id + "']");
  let target_amount = target_bill.find(".amount");
  let target_shipping_fee = target_bill.find(".shipping_fee");
  let target_reward_discount = target_bill.find(".reward_discount");
  let target_refund_shipping_fee = target_bill.find(".refund_shipping_fee");

  let current_amount = target_amount.attr('data-amount');
  let current_shipping_fee = target_shipping_fee.attr('data-shipping_fee');
  let current_reward_discount = target_reward_discount.attr('data-reward_discount');
  let current_refund_shipping_fee = target_refund_shipping_fee.attr('data-refund_shipping_fee');

  if (refund_method === 'reward') {
    let new_reward_discount = (parseInt(current_reward_discount) || 0) - (parseInt(refund_amount) || 0);
    target_reward_discount.html(toCommas(new_reward_discount));
    target_reward_discount.attr('data-reward_discount', new_reward_discount);
  } else {
    let new_amount = (parseInt(current_amount) || 0) - (parseInt(refund_amount) || 0);
    target_amount.html(toCommas(new_amount));
    target_amount.attr('data-amount', new_amount);
  }

  let new_shipping_fee = (parseInt(current_shipping_fee) || 0) - (parseInt(refund_amount) || 0);
  target_shipping_fee.html(toCommas(new_shipping_fee));
  target_shipping_fee.attr('data-shipping_fee', new_shipping_fee);
  target_bill.find(".btn-edit").attr('data-shipping_fee', new_shipping_fee);

  let new_refund_shipping_fee = (parseInt(current_refund_shipping_fee) || 0) + (parseInt(refund_amount) || 0);
  target_refund_shipping_fee.html(toCommas(new_refund_shipping_fee));
  target_refund_shipping_fee.attr('data-refund_shipping_fee', new_refund_shipping_fee);
  target_bill.find(".refund_shipping_fee_area").show();
}

function checkCommodityCheckoutStatus() {
  let result = true;
  $(".checkout_status").each(function(i, td) {
    if ($(td).text() != "完成") {
      result = false;
    }
  });
  return result;
}

function openShipnotesCheckoutDialog() {
  $( ".shipnotes-checkout-box-container" ).dialog({
    width: 1100,
    open: function() {
      $('.ui-widget-overlay').click(function(e) {
        e.preventDefault();
        return false;
      });
      let checkout_purpose = localStorage.getItem("checkoutPurpose");
      let commodity_checkout = localStorage.getItem("commodityCheckout");
      if (checkout_purpose) {
        $("#checkout_purpose").val(checkout_purpose);
      } else {
        $("#checkout_purpose").val("checkout");
      }
      if (commodity_checkout) {
        $("#commodity_checkout").prop("checked", true);
      } else {
        $("#commodity_checkout").prop("checked", false);
      }
    },
    buttons : {
      "完成" : function() {
        $("#form_search").submit();
        $(this).dialog("close");
      }
    },
  });
  $(".shipnotes-checkout-box-container").dialog("open");
}

function closeCommoditiesCheckoutDialog() {
  checkouted_order_ids = [];
  $('#commodities_checkout_detail').html("");
  $(".commodities-checkout-box-container").dialog("close");
}

function switchShipnotesCheckoutDialog() {
  openShipnotesCheckoutDialog();
  closeCommoditiesCheckoutDialog();
}

function switchCommoditiesCheckoutDialog() {
  $( ".commodities-checkout-box-container" ).dialog({
    width: 1100,
    open: function() {
      $('.ui-widget-overlay').click(function(e) {
        e.preventDefault();
        return false;
      });
    },
    buttons : {
      "取消" : function() {
        checkouted_order_ids = [];
        $("#shipnote").val('');
        $(".shipnotes-checkout-box-container").dialog("open");
        $(this).dialog("close");
      }
    },
  });
  $(".commodities-checkout-box-container").dialog("open");
  $(".shipnotes-checkout-box-container").dialog("close");
}

function shipnoteCheckout(is_commodity_checkout=false) {
  current_checkout_bill_id = null;
  $.post('/console/api/shipnote/checkout/27733/', {sn: $("#shipnote").val(), la_kind: '', purpose: $("#checkout_purpose").val(), is_commodity_checkout: is_commodity_checkout} , function(data) {
    if (is_commodity_checkout) {
      let orders = data['orders'];
      let total_commodity_quantity = 0
      current_checkout_bill_id = data['bill_id'];
      for (i=0; i<orders.length; i++) {
        total_commodity_quantity += orders[i].quantity;
        $('#commodities_checkout_detail').append(`<tr><td>${orders[i].order}</td><td>${orders[i].name}</td><td><span id=current_quantity_${orders[i].order_id}>0</span>/<span id=total_quantity_${orders[i].order_id}>${orders[i].quantity}</span></td><td id=checkout_status_${orders[i].order_id} class=checkout_status></td></tr>`);
      }
      $('#rest_commodity_quantity').text(0);
      $('#total_commodity_quantity').text(total_commodity_quantity);
      switchCommoditiesCheckoutDialog();
    } else {
      let newData = `<tr><td>${data.bill}</td><td>${data.established_time}</td><td>${data.sn}</td><td>${data.checkouted_time}</td><td>${data.purpose}</td></tr>`;
      $('#shipnotes_checkout_detail').append(newData);
      $("#shipnote").val('');
    }
  })
  .fail(function(error) {
    let errorResponse = JSON.parse(error.responseText);
    $('#alert-sound')[0].play().then(() => {
        setTimeout(() => {
          alert(errorResponse.message);
          $("#shipnote").val('');
        }, 30);
      }).catch(error => {
      console.error("play sound error:", error);
    });
  });
}

$('#shipnotes_checkout').click(function() {
  openShipnotesCheckoutDialog();
});

$("#commodity_checkout").change(function() {
  if ($(this).is(":checked")) {
    localStorage.setItem("commodityCheckout", $(this).is(":checked"));
  } else {
    localStorage.removeItem("commodityCheckout")
  }
});

$('#shipnote').keypress(function(event) {
  if ((event.which === 13 || event.keyCode === 13) && !event.shiftKey) {
    if ($("#commodity_checkout").is(":checked")) {
      is_commodity_checkout = true;
    } else {
      is_commodity_checkout = false;
    }
    closeCommoditiesCheckoutDialog();
    shipnoteCheckout(is_commodity_checkout);
  }
});

$('#commodity_barcode').keypress(function(event) {
  if ((event.which === 13 || event.keyCode === 13) && !event.shiftKey) {
    $.post('/console/api/commodity/checkout/27733/', {bill_id: current_checkout_bill_id, barcode: $("#commodity_barcode").val(), checkouted_order_ids: checkouted_order_ids} , function(data) {
      let order_id = data['order_id'];
      let current_quantity = parseInt($(`#current_quantity_${order_id}`).text()) || 0;
      let total_quantity = parseInt($(`#total_quantity_${order_id}`).text()) || 0;
      let commodity_quantity = parseInt($("#commodity_quantity").val()) || 1;
      let rest_commodity_quantity = parseInt($("#rest_commodity_quantity").text()) || 0;

      if (current_quantity >= total_quantity || (current_quantity + commodity_quantity) > total_quantity) {
        $('#alert-sound')[0].play().then(() => {
          setTimeout(() => {
            alert("揀貨數量不吻合");
            $("#commodity_barcode").val('');
          }, 30);
        }).catch(error => {
          console.error("play sound error:", error);
        });
      } else {
        current_quantity += commodity_quantity;
        $(`#current_quantity_${order_id}`).text(current_quantity);
        $('#rest_commodity_quantity').text(rest_commodity_quantity + commodity_quantity);
      }
      if (current_quantity == total_quantity) {
        checkouted_order_ids.push(order_id);
        $(`#checkout_status_${order_id}`).text("完成");
      }
      if (checkCommodityCheckoutStatus()) {
        shipnoteCheckout();
        switchShipnotesCheckoutDialog();
      }
      $("#commodity_barcode").val('');
    })
    .fail(function(error) {
      let errorResponse = JSON.parse(error.responseText);
      $('#alert-sound')[0].play().then(() => {
        setTimeout(() => {
          alert(errorResponse.message);
          $("#commodity_barcode").val('');
        }, 30);
      }).catch(error => {
        console.error("play sound error:", error);
      });
    });
  }
});

$(document).on("click", ".atm-photo-cover", function(e) {
  $("#enlarge img").attr('src', $(this).attr('src'));
  $("#enlarge").css('display', 'flex');
});
$("#enlarge").click(function() {
  $("#enlarge").css('display', 'none');
});



$(document).on("click", ".btn-edit", function(e) {
  let from = $(this).attr("data-from");
  var id = $(this).attr("data-id");
  var target = $("tr[data-id='" + id + "']");
  var enable_edit_shipping_fee = target.find(".btn-edit").attr("data-enable_edit_shipping_fee");
  var shipping_fee = target.find(".btn-edit").attr("data-shipping_fee");
  var has_shipped_time = target.find(".btn-edit").attr("data-has_shipped_time");
  var is_prepared = target.find(".btn-edit").attr("data-is_prepared");
  var is_erp_sync = target.find(".btn-edit").attr("data-is_erp_sync");
  var disable_general_cod = target.find(".btn-edit").attr("data-disable_general_cod");
  var amount = target.find(".amount");
  var ship_name = target.find(".ship_name");
  var ship_contact = target.find(".ship_contact");
  var ship_address = target.find(".ship_address");
  var ship_zipcode = target.find(".ship_zipcode");
  var payment_method = target.find(".payment_method");
  var atm_postfix = target.find(".atm_postfix");
  var custom_ship_notes = target.find(".custom_ship_notes");
  var remark = target.find(".remark");
  var extra_remark = target.find(".extra_remark");
  var system_remark = target.find(".system_remark");
  var pickup_point_name = target.find(".pickup_point_name");
  var email = target.find(".email");
  var invoice_method = target.find(".invoice_method");
  var love_code = target.find(".love_code");
  var carruer_code = target.find(".carruer_code");
  var buyer_vat = target.find(".buyer_vat");
  var invoice_valid = target.find(".invoice_valid");
  if (invoice_valid.html() == "valid") {
    $("#invoice_method").attr("disabled", true);
    $("#love_code").attr("disabled", true);
    $("#carruer_code").attr("disabled", true);
  } else {
    $("#invoice_method").attr("disabled", false);
    $("#love_code").attr("disabled", false);
    $("#carruer_code").attr("disabled", false);
  }

  $("#ship_name").val(ship_name.html());
  $("#ship_contact").val(ship_contact.attr('data-content'));
  $("#ship_address").val(ship_address.text());
  $("#ship_zipcode").val(ship_zipcode.html().replace('(', '').replace(')', ''));
  var pm = payment_method.attr("data-pm");
  var sm = payment_method.attr("data-sm");
  $("#payment_method").attr("data-sm", sm);
  if (disable_general_cod === 'True') {
    $("#payment_method option[value=cod]").hide();
    $("#payment_method option[value=pickup]").hide();
  } else {
    $("#payment_method option[value=cod]").show();
    $("#payment_method option[value=pickup]").show();
  }
  if (has_shipped_time === 'True') {
    $("#payment_method").attr('disabled', 'disabled');
  }
  $("#shipping_fee").val(shipping_fee);
  if (enable_edit_shipping_fee === 'True') {
    $("#shipping_fee").removeAttr('disabled');
  } else {
    $("#shipping_fee").attr('disabled', 'disabled');
  }
  
  if (pm == "ecpaycreditcard" || pm == "pchomecreditcard" || pm == "sinopaccreditcard" || pm == "taishincreditcard" || pm == "cathaycreditcard" || pm == "ctbccreditcard" || pm == "sinopacatm" || pm == "ecpaybarcode" || pm == "ecpaycvs" || pm == "linepay" || pm == "fasneypay" || pm == "zingalapay" || pm == "pgtalkpay" || pm == "stripe" || pm == 'authorize' || pm == "c2c") {
    $("#pm").hide();
    $("#postfix").hide();
  } else if (pm == "atm") {
    $("#payment_method").val("atm");
    $("#pm").show();
    
    $("#postfix").show();
    
  } else {
    $("#payment_method").val(pm);
    $("#pm").show();
    $("#postfix").hide();
  }
  if (pm == "pickup" || sm == "pickup") {
    var ppn = $("#pickup_point").find('option:contains("' + pickup_point_name.html() + '")').val();
    if (ppn) {
      $("#pickup_point").val(ppn);
    }
    $("#pickup_points").show();
    $("#pickup_point").show();
  } else {
    $("#pickup_points").hide();
    $("#pickup_point").hide();
  }
  $("#atm_postfix").val(atm_postfix.html());
  $("#custom_ship_notes").val(custom_ship_notes.html());
  $("#remark").val(remark.html());
  $("#extra_remark").val(extra_remark.html());
  $("#system_remark").val(system_remark.html());
  $("#logistic_number").val(target.attr("data-logistic_number"));
  $("#logistic_date").val(target.attr("data-logistic_date"));
  $("#logistic_size").val(target.attr("data-logistic_size"));
  $("#size").val(target.attr("data-size"));
  $("#carruer_code").val(target.attr("data-carruer_code"));
  $("#buyer_vat").val(target.attr("data-buyer_vat"));
  $("#email").val(email.html());
  $("#invoice_method").val(invoice_method.html());
  $("#love_code").val(love_code.html());

  $( ".edit-box-container" ).dialog({
    width: 600,
    buttons : {
      "確認" : function() {
        var params = {
          kind: "tobeshipped",
          ship_name: $("#ship_name").val(),
          ship_contact: $("#ship_contact").val(),
          ship_address: $("#ship_address").val(),
          ship_zipcode: $("#ship_zipcode").val(),
          atm_postfix: $("#atm_postfix").val(),
          custom_ship_notes: $("#custom_ship_notes").val(),
          remark: $("#remark").val(),
          extra_remark: $("#extra_remark").val(),
          system_remark: $("#system_remark").val(),
          logistic_number: $("#logistic_number").val(),
          logistic_date: $("#logistic_date").val(),
          logistic_size: $("#logistic_size").val(),
          size: $("#size").val(),
          carruer_code: $("#carruer_code").val(),
          
          buyer_vat: $("#buyer_vat").val(),
          pickup_point: $("#pickup_point").val(),
          email: $("#email").val(),
          invoice_method: $("#invoice_method").val(),
          love_code: $("#love_code").val(),
          shipping_fee: $("#shipping_fee").val(),
        };
        if (pm == "cod" || pm == "atm" || pm == "shopee" || pm == "pchome" || pm == "pickup") {
          params.payment_method = $("#payment_method").val();
          
        };
        $(this).dialog("close");
        var originalText = $("tr[data-id='" + id + "']").find('.payment_method').text();
        var isShipSelf = false;
        if (originalText.indexOf('親自送貨') > -1) {
          isShipSelf = true;
        }
        $.post('/console/api/bill/edit/' + id + '/', params, function() {
          var ppm = params.payment_method;
          payment_method.attr("data-pm", ppm);
          if (ppm == "cod") {
            payment_method.html("貨到付款");
          } else if (ppm == "atm") {
            payment_method.html("匯款");
          } else if (ppm == "shopee") {
            payment_method.html("蝦皮");
          } else if (ppm == "pchome") {
            payment_method.html("PC Home");
          } else if (ppm == "pickup") {
            payment_method.html("自取");
          }
          if (sm == "pickup" && !params.pickup_point && isShipSelf) {
            var originalPm = payment_method.text();
            payment_method.html(originalPm + '（親自送貨）');
          }
          target.find(".btn-edit").attr('data-shipping_fee', params.shipping_fee);
          target.find(".shipping_fee").html(toCommas(parseInt(params.shipping_fee) || 0));
          amount.html(toCommas((parseInt(amount.attr("data-amount")) || 0) - (parseInt(shipping_fee) || 0) + (parseInt(params.shipping_fee) || 0)));
          ship_name.html(params.ship_name);
          ship_contact.html(params.ship_contact);
          ship_contact.attr('data-content', params.ship_contact);
          ship_address.html(params.ship_address);
          ship_zipcode.html(params.ship_zipcode ? '(' + params.ship_zipcode + ')' : '');
          atm_postfix.html(params.atm_postfix);
          custom_ship_notes.html(params.custom_ship_notes);
          remark.html(params.remark);
          extra_remark.html(params.extra_remark);
          system_remark.html(params.system_remark);
          invoice_method.html(params.invoice_method);
          target.attr("data-logistic_number", params.logistic_number);
          target.attr("data-logistic_date", params.logistic_date);
          target.attr("data-logistic_size", params.logistic_size);
          target.attr("data-size", params.size);
          target.attr("data-carruer_code", params.carruer_code);
          carruer_code.html(params.carruer_code);
          target.attr("data-buyer_vat", params.buyer_vat);
          buyer_vat.html(params.buyer_vat);
          if (params.extra_remark) {
            $("tr[data-id='" + id + "']").find(".extra_remark_text").show();
          } else {
            $("tr[data-id='" + id + "']").find(".extra_remark_text").hide();
          }
          if (ppm != "atm" && pm != "sinopacatm") {
            atm_postfix.hide();
          } else {
            
            atm_postfix.show();
            
          }
          if (params.pickup_point) {
            pickup_point_name.show();
            pickup_point_name.html($('select[name="pickup_point"] :selected').text());
            
          } else {
            if (!isShipSelf) {
              pickup_point_name.html('');
            }
          }
          var kind = "tobeshipped";
          if (kind == "tobeshipped") {
            if (pm != "atm" && ppm == "atm") {
              $("tr[data-id='" + id + "']").remove();
            }
          } else if (kind == "tobepaid") {
            if (ppm == "cod" || ppm == "shopee" || ppm == "pchome" || ppm == "pickup") {
              $("tr[data-id='" + id + "']").remove();
            }
          } else if (kind == "cod") {
            if (ppm != "cod") {
              $("tr[data-id='" + id + "']").remove();
            }
          } else if (kind == "pickup") {
            if (ppm != "pickup" && sm != "pickup") {
              $("tr[data-id='" + id + "']").remove();
            }
          } else if (kind == "pchomeshopee") {
            if (ppm != "pchome" || ppm != "shopee") {
              $("tr[data-id='" + id + "']").remove();
            }
          }
          if (from == "shipnote") {
            if (child_shipnote_window && !child_shipnote_window.closed) {
              window.open("", child_shipnote_window.name);
              child_shipnote_window.focus();
              child_shipnote_window.uploadShipnote(id);
            }
          }
        }).fail(function () {
          alert('fail');
        });
      },
      "取消" : function() {
        $(this).dialog("close");
      }
    },
  });
  $("#ntcfa_edit").attr("data-id", id);
  $(".edit-box-container").dialog( "open" );
});

$("#ntcfa_edit").click(function() {
  var id = $(this).attr("data-id");
  window.open('/console/order/?ntcfa=1&kind=established&search_field=bill_id&search=' + id, '_blank');
});

$(document).on("click", ".btn-edit-more", function (e) {
  var id = $(this).attr("data-id");
  var la_id = '';
  
  var request_items = encodeURIComponent(document.getElementById("main").dataset['request_items']);
  var url = '/console/ship/bill/edit/?bill_id=' + id + '&request_items=' + request_items + '&la='+la_id;
  window.location.replace(url);
});

function validateEmail(email) {
  var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
  return re.test(email);
}

$("#payment_method").change(function(e) {
  var pm = $(this).val();
  var sm = $(this).attr('data-sm');
  if (pm == "atm") {
    
    $("#postfix").show();
    
  } else {
    $("#postfix").hide();
  }
  if (pm == "pickup" || sm == "pickup") {
    $("#pickup_points").show();
    $("#pickup_point").show();
  } else {
    $("#pickup_points").hide();
    $("#pickup_point").hide();
  }
});

$(".default_order_switch").click(function() {
  var item =  $(this).attr("data-item");
  var originalOrderBy = $("input[name='default_order_by']").val();
  $("input[name='default_order_by']").val(originalOrderBy === 'asc' ? 'desc' : 'asc');
  $("input[name='default_order_item']").val(item);
  $("input[name='skip_check']").val('True');
  $("#form_search").submit();
})


$(document).on("click", ".btn-view-delivery", function(e) {
  var bill = $(this).attr("data-id");
  var sm = $(this).attr("data-sm");
  var ts = $("#orders_detail").tablesorter({sortList: [[2, 0]]});
  var refundable = $(this).attr("data-retreatable");
  
  
  $.post('/console/api/ship/orders/27733/', {bill: bill} , function(data) {
  
    var template = document.getElementById('ship_order').innerHTML;
    Mustache.tags = ['[[', ']]'];
    var i;
    var rendered = '';
    for (i=0; i<data.length; i++) {
      var order = {
        id: data[i].id,
        photo: data[i].photo,
        name: data[i].name,
        serial: data[i].serial,
        specification: data[i].specification,
        date: data[i].date,
        price: toCommas(data[i].price),
        quantity: toCommas(data[i].quantity),
        discount: toCommas(data[i].discount),
        multi_pieces_discount: data[i].multi_pieces_discount ? toCommas(data[i].multi_pieces_discount) : 0,
        subtotal: toCommas(data[i].subtotal),
        remark: data[i].remark,
        returnwarehousedate: data[i].returnwarehousedate,
        
        refundable: refundable,
        
        
        exchangeable: true,
        
        
        quantity_editable: data[i].quantity_editable,
        
        order_split: data[i].quantity > 1,
      };
      
      rendered += Mustache.render(template, order);
    };
    $("#target").html(rendered);
    ts.trigger("update");
    var order_has_refunded = 0
    $(function() {
      $(".btn-icon:not(#target .btn-icon)").tooltip({track: true});
      $("#target .btn-icon").tooltip({track: true, tooltipClass: "no-wrap", position: { within: '#target' } });
      $(".btn-refund").bind('click', function() {
        if (!confirm("請注意，您將要進行退單。\n退回之後將無法回復。")) {
          return;
        }
        var target = $(this);
        $.post('/console/api/order/refund/27733/' + $(this).attr('data-id') + '/', function(data) {
          if (data.succeed.length) {
            let _data = data.succeed[0]
            var sbs = target.parent().parent().siblings();
            order_has_refunded += parseInt(sbs.find("p.quantity").text(), 10)
            sbs.find("p.quantity").html(toCommas(_data.quantity));
            sbs.find("p.discount").html(toCommas(_data.discount));
            sbs.find("p.subtotal").html(toCommas(_data.subtotal));
            sbs.find("p.remark").html(_data.remark);
            $("tr[data-id='" + _data.bill_id + "']").find("p.amount").html(toCommas(_data.bill_amount));
          }
          if (data.failure.length) {
            let _data = data.failure[0];
            alert(`error: ${_data.error_msg}`);
          }
        });
      });
      $(".btn-exchange").bind('click', function() {
        window.open(`/console/order/exchange/${$(this).attr('data-id')}/`, 'target', 'height=600,width=1200');
      });
      $(".btn-quantity_edit").bind('click', function() {
        window.open(`/console/order/edit/${$(this).attr('data-id')}/?quantity_editable=1`, 'target', 'height=600,width=1200');
      });
      $(".btn-order_split").bind('click', function() {
        var quantity = prompt("請輸入要拆分的數量");
        if (isNaN(parseInt(quantity)) || parseInt(quantity) === 0) {
          alert('請輸入正整數');
          return;
        }
        quantity = parseInt(quantity)
        var target = $(this);
        $.post('/console/api/order/split/27733/', {'order_id': $(this).attr('data-id'), 'quantity': quantity}, function(response) {
          if (response.result) {
            alert('訂單拆分成功！');
            $(".view-delivery-box-container").dialog( "close" );
          }
          else {
            if (response.error_msg) {
              alert(response.error_msg);
            } else {
              alert('失敗！');
            }
          }
        });
      });
    });
    $( ".view-delivery-box-container" ).dialog({
      width: 600,
      dialogClass: "view-delivery-box",
      buttons : {
        
        
        "拆單" : {text: "拆單", class: 'split-order-btn', click: function() {
          const orders = $('input[name="orders"]:checked').map((index, elem) => elem.value).get();

          if(sm == 'notship') {
            alert("暫不出貨付款單無法拆單");
            return;
          }

          if (data.length <= 1) {
            alert("訂單數需大於 1 方能拆單！");
            return;
          }

          if (orders.length < 1) {
            alert("請至少選擇 1 張訂單！")
            return;
          }

          if (orders.length >= data.length) {
            alert("無法將全部訂單拆出！");
            return;
          }

          const $this = $(this);
          const $button = $this.parent().find('.split-order-btn');
          $button.prop("disabled", true);

          $.ajax({
            type: "POST",
            url: `/console/api/bill/split/27733/${bill}/`,
            data: JSON.stringify({ orders, request_user_id: '44448' }),
            contentType: "application/json",
            dataType: 'json',
          })
          .done(function(response) {
            const { error, error_code, bill_id, new_bill_str, orders_split_out_count, transfer_reward_discount } = response;

            if (error) {
              const reason_map = {
                'error_bill_spilit_bad_status': '此付款單狀態無法拆單',
                'error_bill_spilit_bad_orders_count': '不合法的訂單數量',
                'error_bill_spilit_payment_method_not_supported': '此種付款方式暫不支援拆單',
                'error_prepayment_not_enough': '預付款不足，請儲值',
              }
              const reason = reason_map[error_code] || '';
              alert(`拆單失敗！(${reason})`);
              return;
            }
            if (transfer_reward_discount > 0) {
              alert(`拆單成功！(拆出訂單數： ${orders_split_out_count}，新付款單： ${new_bill_str}，轉移紅利折扣： ${transfer_reward_discount})`);
            } else {
              alert(`拆單成功！(拆出訂單數： ${orders_split_out_count}，新付款單： ${new_bill_str})`);
            }
            $('input[name="skip_check"]').val("True");
            $("#form_search").submit();
            // window.location.reload();
          })
          .fail(function(error) {
            alert("拆單失敗！");
          }).always(function() {
            $(".view-delivery-box-container").dialog( "close" );
          });
        }},
        
        
        "關閉" : function() {
          $(this).dialog("close");
        }
      },
      close: function(event, ui) {
        const total_order_quantity = data.reduce((acc,cur)=>acc+cur.quantity,0)
        !!order_has_refunded && total_order_quantity - order_has_refunded === 0 && $("#form_search").submit()
        order_has_refunded = 0
      }
    });
    $(".view-delivery-box-container").dialog( "open" );
  });
});

function printA4(bills, note=false, order_by_origin=false, photo_length=60) {
  $.post('/console/api/ship/bills/', {bills: bills,
                                      note: note,
                                      order_by_origin: order_by_origin,
                                      sub: 'true'
                                      
                                      , order_by_session: 'true'
                                      , order_by_id: 'true'
                                      
                                      
                                      
                                    } ,function(data) {
    Mustache.tags = ['[[', ']]'];
    var template = document.getElementById('ship_a4').innerHTML;
    var rendered = '';
    for (var i=0; i<data.length; i++) {
      var bill = data[i];
      var pm = bill.payment_method;
      var sm = bill.shipping_method;
      if (pm == 'sinopacatm') {
        bill.payment_method = '智慧轉帳';
      } else if (pm == 'ecpaycreditcard' || pm == 'pchomecreditcard' || pm == 'sinopaccreditcard' || pm == 'taishincreditcard' || pm == 'cathaycreditcard' || pm == 'ctbccreditcard') {
        bill.payment_method = '信用卡';
      } else if(pm == 'ecpaybarcode') {
        bill.payment_method = '超商條碼';
      } else if(pm == 'ecpaycvs') {
        bill.payment_method = '超商代碼';
      } else if(pm == 'linepay') {
        bill.payment_method = 'LINE Pay';
      } else if (pm == 'fasneypay') {
        bill.payment_method = 'Fasney';
      } else if (pm == 'zingalapay') {
        bill.payment_method = '銀角零卡';
      } else if (pm == 'pgtalkpay') {
        bill.payment_method = 'PGTalk';
      } else if (pm == 'stripe') {
        bill.payment_method = 'Stripe';
      } else if (pm == 'authorize') {
        bill.payment_method = 'Authorize';
      } else if (pm == 'fugo') {
        bill.payment_method = '東森支付';
      } else if(pm == 'cod') {
        bill.payment_method = '貨到付款';
      } else if(pm == 'atm') {
        bill.payment_method = '匯款';
      } else if (pm == 'shopee') {
        bill.payment_method = '蝦皮';
      } else if (pm == 'pchome') {
        bill.payment_method = 'PC Home';
      } else if (pm == 'pickup') {
        bill.payment_method = '自取';
        if (bill.pickup_point_name && bill.pickup_point_name != '親自送貨') {
          bill.ship_address = '自取點-' + bill.pickup_point_name;
        } else {
          bill.ship_address = '自取';
        }
      } else if (pm == 'c2c') {
        bill.payment_method = '超商付款取貨';
      } else if (pm == 'rewardpoint') {
        bill.payment_method = '紅利支付';
      }
      if (bill.pickup_point_name == '親自送貨') {
        bill.payment_method = bill.payment_method + '(親自送貨)';
      }
      if (sm == 'pickup' && bill.pickup_point_name != '親自送貨') {
        if (bill.pickup_point_name) {
          bill.ship_address = '自取點-' + bill.pickup_point_name;
        } else {
          bill.ship_address = '自取';
        }
      } else if (sm == 'ecpayfamic2c' || sm == 'ecpayunimartc2c' || sm == 'ecpayhilifec2c' || sm == 'prescoc2c' || sm == 'prescob2c' || sm == 'sudab2c' || sm == 'prescob2ccold' || sm == 'fmec2c' || sm == 'fmeb2c' || sm == 'xdfami') {
        bill.ship_zipcode = ''
        bill.ship_address = bill.cvs_ship_info.replaceAll('\n', '<br>');
      }
      var k = 1;
      var commodity_total_quantity = 0;
      var is_sub = false;
      for (var j=0; j<bill.orders.length; j++) {
          commodity_total_quantity = commodity_total_quantity + bill.orders[j].quantity;
          bill.orders[j].bold = false;
          if (bill.orders[j].serial) {
            is_sub = false;
            bill.orders[j].index = k;
            k++;
            bill.orders[j].specification = bill.orders[j].specification.replaceAll('\n', '<br>')
          } else {
            bill.orders[j].serial = '子品項';
            bill.orders[j].bold = true;
            if (!is_sub && j-1 >= 0) {
              commodity_total_quantity -= bill.orders[j-1].quantity;
              is_sub = true;
            }
          }
          
          bill.orders[j].photo = '';
          
      }
      bill.commodity_total_quantity = commodity_total_quantity;
      bill.photo_length = photo_length;
      if (bill.invoice_method == 'donate') {
        bill.invoice_method = '捐贈發票';
      } else if (bill.invoice_method == 'ship') {
        bill.invoice_method = '隨貨寄出';
      } else if (bill.invoice_method == 'vat') {
        bill.invoice_method = '統編發票';
      } else if (bill.invoice_method == 'carruer') {
        bill.invoice_method = '電子載具';
      } else if (bill.invoice_method == 'cloud') {
        bill.invoice_method = '雲端發票';
      }
      bill.is_a4 = 'true';
      rendered += Mustache.render(template, bill);
    };
    $("#a4").html(rendered);
    printElem("a4");
  });
  $.post('/console/api/bills/print/', {kind: 'a4', bills: bills} , function(data) {
    bills.forEach(function(id) {
      var system_remark = $("tr[data-id='" + id + "']").find(".system_remark");
      html = system_remark.html();
      if (html) {
        system_remark.html(data + '\n\n' + html);
      } else {
        system_remark.html(data);
      }
    });
  });
}
function printThermal(bills) {
  Mustache.tags = ['[[', ']]'];
  var template = document.getElementById('ship_thermal').innerHTML;
  $.post('/console/api/ship/bills/', {bills: bills
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                  }, function(data) {
    var i;
    var rendered = '';
    for (i=0; i<data.length; i++) {
      var bill = data[i];
      var pm = bill.payment_method;
      var sm = bill.shipping_method;
      var commodity_total_quantity = 0;
      var is_sub = false;
      for (var j = 0; j < bill.orders.length; j++) {
        commodity_total_quantity = commodity_total_quantity + bill.orders[j].quantity;
        bill.orders[j].bold = false;
        if (bill.orders[j].serial) {
          is_sub = false;
          bill.orders[j].specification = bill.orders[j].specification.replaceAll('\n', '<br>')
        } else {
          bill.orders[j].serial = '子品項';
          bill.orders[j].bold = true;
          if (!is_sub && j-1 >= 0) {
            commodity_total_quantity -= bill.orders[j-1].quantity;
            is_sub = true;
          }
        }
      }
      bill.commodity_total_quantity = commodity_total_quantity;
      if (pm == 'sinopacatm') {
        bill.payment_method = '智慧轉帳';
      } else if (pm == 'ecpaycreditcard' || pm == 'pchomecreditcard' || pm == 'sinopaccreditcard' || pm == 'taishincreditcard' || pm == 'cathaycreditcard' || pm == 'ctbccreditcard') {
        bill.payment_method = '信用卡';
      } else if(pm == 'ecpaybarcode') {
        bill.payment_method = '超商條碼';
      } else if(pm == 'ecpaycvs') {
        bill.payment_method = '超商代碼';
      } else if(pm == 'linepay') {
        bill.payment_method = 'LINE Pay';
      } else if (pm == 'fasneypay') {
        bill.payment_method = 'Fasney';
      } else if (pm == 'zingalapay') {
        bill.payment_method = '銀角零卡';
      } else if (pm == 'pgtalkpay') {
        bill.payment_method = 'PGTalk';
      } else if (pm == 'stripe') {
        bill.payment_method = 'Stripe';
      } else if (pm == 'authorize') {
        bill.payment_method = 'Authorize';
      } else if (pm == 'fugo') {
        bill.payment_method = '東森支付';
      } else if(pm == 'cod') {
        bill.payment_method = '貨到付款';
      } else if(pm == 'atm') {
        bill.payment_method = '匯款';
      } else if (pm == 'shopee') {
        bill.payment_method = '蝦皮';
      } else if (pm == 'pchome') {
        bill.payment_method = 'PC Home';
      } else if (pm == 'pickup' && bill.pickup_point_name != '親自送貨') {
        bill.payment_method = '自取';
        if (bill.pickup_point_name) {
          bill.ship_address = '自取點-' + bill.pickup_point_name;
        } else {
          bill.ship_address = '自取';
        }
      } else if (pm == 'c2c') {
        bill.payment_method = '超商付款取貨';
      }
      if (sm == 'pickup' && bill.pickup_point_name != '親自送貨') {
        if (bill.pickup_point_name) {
          bill.ship_address = '自取點-' + bill.pickup_point_name;
        } else {
          bill.ship_address = '自取';
        }
      } else if (sm == 'ecpayfamic2c' || sm == 'ecpayunimartc2c' || sm == 'ecpayhilifec2c' || sm == 'prescoc2c' || sm == 'prescob2c' || sm == 'sudab2c' || sm == 'prescob2ccold' || sm == 'fmec2c' || sm == 'fmeb2c' || sm == 'xdfami') {
        bill.ship_zipcode = ''
        bill.ship_address = bill.cvs_ship_info.replaceAll('\n', '<br>');
      }
      let currentDate = new Date();
      bill.print_time = `${currentDate.getMonth() + 1}/${currentDate.getDate()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;
      rendered += Mustache.render(template, bill);
    };
    $("#thermal").html(rendered);
    printElem("thermal");
  });
  $.post('/console/api/bills/print/', {kind: 'thermal', bills: bills} , function(data) {
    bills.forEach(function(id) {
      var system_remark = $("tr[data-id='" + id + "']").find(".system_remark");
      html = system_remark.html();
      if (html) {
        system_remark.html(data + '\n\n' + html);
      } else {
        system_remark.html(data);
      }
    });
  });
}



$(document).on("click", ".btn-add-order", function(e) {
  var bill = $(this).attr("data-id");
  var ts = $("#add_orders_detail").tablesorter({sortList: [[2, 0]]});
  $.post(`/console/api/orders/get/notestablished/${bill}/`, function(data) {
    let template = document.getElementById('ship_add_order').innerHTML;
    let i;
    let rendered = '';
    Mustache.tags = ['[[', ']]'];

    if (data.length == 0) {
      alert("目前尚無未成立訂單!");
      return;
    }

    for (i=0; i<data.length; i++) {
      let order = {
        id: data[i].id,
        photo: data[i].photo,
        name: data[i].name,
        serial: data[i].serial,
        specification: data[i].specification,
        date: data[i].date,
        price: toCommas(data[i].price),
        quantity: toCommas(data[i].quantity),
        discount: toCommas(data[i].discount),
        multi_pieces_discount: data[i].multi_pieces_discount ? toCommas(data[i].multi_pieces_discount) : 0,
        subtotal: toCommas(data[i].subtotal),
        remark: data[i].remark
      };
      rendered += Mustache.render(template, order);
    };
    $("#target_add").html(rendered);
    ts.trigger("update");
    $(".select-all-orders").change(function() {
      $('input[name="add_orders"]').not(this).prop('checked', this.checked);
    });
    $( ".view-add-order-box-container" ).dialog({
      width: 600,
      dialogClass: "view-add-order-box",
      buttons : {
        "加單" : function() {
          const orders = $('input[name="add_orders"]:checked').map((index, elem) => elem.value).get();

          if (orders.length < 1) {
            alert("請至少選擇 1 張訂單！");
            return;
          }

          $.ajax({
            type: "POST",
            url: `/console/api/bill/add/${bill}/`,
            data: JSON.stringify({ orders }),
            contentType: "application/json",
            dataType: 'json',
          })
          .done(function(response) {
            const { order_select_count, order_shift_count } = response;
            alert(`加單成功！(選擇訂單數: ${order_select_count}, 加入訂單數: ${order_shift_count})`);
            window.location.reload();
          })
          .fail(function(error) {
            let errorResponse = JSON.parse(error.responseText)
            alert(errorResponse.message);
            $(".view-add-order-box-container").dialog( "close" );
          });
        },
        "關閉" : function() {
          $(this).dialog("close");
        }
      },
    });
    $(".view-add-order-box-container").dialog( "open" );
  })
  .fail(function(error) {
    let errorResponse = JSON.parse(error.responseText)
    alert(errorResponse.message);
  });
});



$(document).on("click", "button[data-action='sinopac_refund']", function() {
  var bill = $(this).attr("data-id");
  var ts = $("#refund_orders_detail").tablesorter({sortList: [[2, 0]]});
  
  $.post('/console/api/ship/orders/27733/', {bill: bill} , function(data) {
  
    let template = document.getElementById('ship_refund_order').innerHTML;
    let i;
    let rendered = '';
    Mustache.tags = ['[[', ']]'];
    for (i=0; i<data.length; i++) {
      let order = {
        id: data[i].id,
        photo: data[i].photo,
        name: data[i].name,
        serial: data[i].serial,
        specification: data[i].specification,
        date: data[i].date,
        price: toCommas(data[i].price),
        quantity: toCommas(data[i].quantity),
        discount: toCommas(data[i].discount),
        multi_pieces_discount: data[i].multi_pieces_discount ? toCommas(data[i].multi_pieces_discount) : 0,
        subtotal: toCommas(data[i].subtotal),
        remark: data[i].remark,
        returnwarehousedate: data[i].returnwarehousedate
      };
      rendered += Mustache.render(template, order);
    };

    $("#target_refund").html(rendered);
    ts.trigger("update");

    $( ".sinopac-refund-box-container" ).dialog({
      width: 1000,
      open: function() {
        $('.ui-widget-overlay').click(function(e) {
          e.preventDefault();
          return false;
        });
      },
      buttons : {
        "退款" : function() {
          let sinopac_refund_type = $("select[name='sinopac_refund_type']").val()
          let orders = $('input[name="refund_orders"]:checked').map((index, elem) => elem.value).get();

          if (sinopac_refund_type == 'part') {
            if (orders.length < 1) {
              alert("請至少選擇 1 張訂單！");
              return;
            }
          }

          let r = confirm("請注意，您將要進行退款。");
          if (r) {
            $(event.target).attr('disabled', 'disabled');
            $(event.target).html('處理中');

            $.ajax({
              type: "POST",
              url: `/console/api/bill/sinopac_refund/${bill}/`,
              data: JSON.stringify({ orders, refund_type: sinopac_refund_type, request_user_id: '44448' }),
              contentType: "application/json",
              dataType: 'json',
            })
            .done(function(response) {
              alert('執行退款成功！');
              closeSinopacRefundDialog();
              if (sinopac_refund_type == 'all') {
                $("tr[data-id='" + bill + "']").remove();
                showCount();
              } else {
                window.location.reload();
              }
            })
            .fail(function(error) {
              let errorResponse = JSON.parse(error.responseText)
              alert(errorResponse.message);
              closeSinopacRefundDialog();
            });
          }
        },
        "取消" : function() {
          closeSinopacRefundDialog();
        }
      }
    });
    $(".sinopac-refund-box-container").dialog( "open" );
  });
});


function printElem(divId) {
  var content = document.getElementById(divId).innerHTML;
  var mywindow = window.open('', 'Print', 'height=600,width=800');

  mywindow.document.write('<html><head><title>Print</title>');
  mywindow.document.write('</head><body >');
  mywindow.document.write(content);
  mywindow.document.write('<script>window.onload = function() { window.print(); }<\/script>');
  mywindow.document.write('</body></html>');
  mywindow.document.close();
  mywindow.focus();
}
$('#shipnote_no_import').change(function(event) {
  const files = event.target.files;
  if (files.length <= 0) {
    alert("未選擇檔案！");
    return;
  }
  let formData = new FormData();
  formData.append('file', files[0]);
  formData.append('csrfmiddlewaretoken', 'RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee')
  return fetch('/console/ship/shipnote/import/', {
    method: 'POST',
    body: formData,
  })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Upload photo failed: status=${response.status}`);
      }
      response.json().then(r => {
        if (r.ok) {
          alert(`匯入成功，更新：${r.updated_rows}筆訂單`);
        } else {
          alert(`匯入失敗！（Error=${r.error}）`);
        }
      })
    });
});
function download(ids, kind, email=false, authenticator_pass=false, edc=false) {
  

  let edc_cache_value = "";
  let is_fire_callback = false;

  $.post("/console/api/export/check/27733/", {request_user_id: '44448', edc: edc, file_type: `ship_${kind}`, bill_ids: ids.join('-')}, function(data) {
    if (data.edc_cache_value) {
      edc_cache_value = data.edc_cache_value;
    }
    if (data.duplicated) {
      is_fire_callback = true;
      alert('相同報表處理中，請至報表下載中心檢視');
    } else if (data.exceed) {
      is_fire_callback = true;
      alert('匯出其它報表中，請稍後再試！');
    } else {
      var targetForm = document.createElement("form");
      if (edc || email) {
          targetForm.target = "target";
      } else {
          targetForm.target = "_self";
      }
      targetForm.method = "post";
      if (kind == 'complex') {
        targetForm.action = "/console/ship/export/complex/";
      } else if (kind == 'simple' || kind == 'invoice_simple') {
        targetForm.action = "/console/ship/export/simple/";
      } else if (kind == 'list_simple') {
        targetForm.action = "/console/ship/export/list/simple/";
      } else if (kind == 'purchase' || kind == 'purchase_without_date' || kind == 'purchase_with_supplier' || kind == 'purchase_with_discount' || kind == 'purchase_pic' || kind == 'purchase_without_date_pic' || kind == 'purchase_with_supplier_pic' || kind == 'purchase_with_discount_pic') {
        targetForm.action = "/console/ship/export/purchase/";
      } else if (kind == 'warehouse' || kind == 'warehouse_combined' || kind == 'warehouse_kind_b' || kind == 'warehouse_combined_presco') {
        targetForm.action = "/console/ship/export/warehouse/";
      } else if (kind == 'refunds') {
        targetForm.action = "/console/ship/export/refund/";
      } else if (kind == 'erp_sales') {
        targetForm.action = "/console/ship/export/erp/sales/";
      } else if (kind == 'logistic') {
        targetForm.action = "/console/ship/export/logistic/";
      } else if (kind == 'size') {
        targetForm.action = "/console/ship/export/size/";
      } else if (kind == 'custom_home' || kind == 'custom_cvs') {
        targetForm.action = "/console/ship/export/custom1/";
      } else if (kind == 'custom_cost') {
        targetForm.action = "/console/ship/export/custom2/";
      } else if (kind == 'shipnote_no_format') {
        targetForm.action = "/console/ship/export/shipnote/format/";
      } else if (kind == 'shipnote_view_download') {
        targetForm.action = "/console/ship/export/shipnote/view/";
      } else if (kind == 'tcat' || kind == 'tcat_car') {
        targetForm.action = "/console/ship/export/ship/tcat/ship/";
      }
      var csrfInput = document.createElement("input");
      csrfInput.type = "hidden";
      csrfInput.name = "csrfmiddlewaretoken";
      csrfInput.value = "RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee";
      targetForm.appendChild(csrfInput);
      var targetInput = document.createElement("input");
      targetInput.type = "hidden";
      targetInput.name = "bills";
      targetInput.value = ids.join('-');
      targetForm.appendChild(targetInput);
      if (kind == 'invoice_simple') {
        var invoiceInput = document.createElement("input");
        invoiceInput.type = "hidden";
        invoiceInput.name = "invoice";
        
        invoiceInput.value = "1";
        
        targetForm.appendChild(invoiceInput);
      }
      if (kind.startsWith('purchase_without_date')) {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "without_date";
        purchaseInput.value = "1";
          console.log('appendChild: without_date')
        targetForm.appendChild(purchaseInput);
      }
      if (kind.startsWith('purchase_with_supplier')) {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "with_supplier";
        purchaseInput.value = "1";
        targetForm.appendChild(purchaseInput);
      }
      if (kind.startsWith('purchase_with_discount')) {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "with_discount";
        purchaseInput.value = "1";
        targetForm.appendChild(purchaseInput);
      }
      if (kind.startsWith('purchase') && kind.endsWith('_pic')) {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "with_picture";
        purchaseInput.value = "1";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'warehouse_combined') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "combined";
        purchaseInput.value = "1";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'warehouse_kind_b') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "b";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'warehouse_combined_presco') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "combined";
        purchaseInput.value = "presco";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'shipnote_view_download') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "sns";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'refunds') {
        var purchaseInput = document.createElement("input");
        var purchaseFilterInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "refunds";
        purchaseFilterInput.type = "hidden";
        purchaseFilterInput.name = "filter_kind";
        
        targetForm.appendChild(purchaseInput);
        targetForm.appendChild(purchaseFilterInput);
      }
      if (kind == 'erp_sales') {
        var purchaseInput = document.createElement("input");
        var purchaseFilterInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "sales";
        purchaseFilterInput.type = "hidden";
        purchaseFilterInput.name = "filter_kind";
        
        targetForm.appendChild(purchaseInput);
        targetForm.appendChild(purchaseFilterInput);
      }
      if (kind == 'custom_home') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "home";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'custom_cvs') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "cvs";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'custom_cost') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "cost";
        targetForm.appendChild(purchaseInput);
      }
      if (kind == 'tcat_car') {
        var purchaseInput = document.createElement("input");
        purchaseInput.type = "hidden";
        purchaseInput.name = "kind";
        purchaseInput.value = "car";
        targetForm.appendChild(purchaseInput);
      }
      if (!edc && email) {
        var emailInput = document.createElement("input");
        emailInput.type = "hidden";
        emailInput.name = "email";
        emailInput.value = "1";
        targetForm.appendChild(emailInput);
      }
      document.body.appendChild(targetForm);
      if (edc) {
        var edcCacheValueInput = document.createElement("input");
        edcCacheValueInput.type = "hidden";
        edcCacheValueInput.name = "edc_cache_value";
        edcCacheValueInput.value = edc_cache_value;
        targetForm.appendChild(edcCacheValueInput);
        alert("匯出處理中，請至報表下載中心檢視");
      }
      if (edc || email) {
        target = window.open("", "target", "scrollbars=yes,resizable=yes,width=10,height=10");
      }
      targetForm.submit();
      is_fire_callback = true;
      document.body.removeChild(targetForm);
      if (edc || email) {
        setTimeout(function () {
          target.close();
        }, 1000);
      }
    }
  }).fail(function(error) {
    if (edc_cache_value) {
      $.post("/console/api/export/cache/delete/27733/", {request_user_id: '44448', file_type: `ship_${kind}`, edc_cache_value: edc_cache_value});
    }
  }).always(function() {
    if (!is_fire_callback && edc_cache_value) {
      $.post("/console/api/export/cache/delete/27733/", {request_user_id: '44448', file_type: `ship_${kind}`, edc_cache_value: edc_cache_value});
    }
  })
}
function openTarget(ids, upload=false, reupload=false, edit=true, la='') {
  var targetForm = document.createElement("form");
  targetForm.target = "target";
  targetForm.method = "post";
  targetForm.action = "/console/ship/notes/";
  var csrfInput = document.createElement("input");
  csrfInput.type = "hidden";
  csrfInput.name = "csrfmiddlewaretoken";
  csrfInput.value = "RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee";
  targetForm.appendChild(csrfInput);
  
  if(!la) {
    la = $("select[name='la']").val();
  }
  if (la) {
    var uploadInput = document.createElement("input");
    uploadInput.type = "hidden";
    uploadInput.name = "la";
    uploadInput.value = la;
    targetForm.appendChild(uploadInput);
  }
  if (upload) {
    var uploadInput = document.createElement("input");
    uploadInput.type = "hidden";
    uploadInput.name = "upload";
    uploadInput.value = "1";
    targetForm.appendChild(uploadInput);
  } else if (reupload) {
    var uploadInput = document.createElement("input");
    uploadInput.type = "hidden";
    uploadInput.name = "reupload";
    uploadInput.value = "1";
    targetForm.appendChild(uploadInput);
  }
  if (edit) {
    var editInput = document.createElement("input");
    editInput.type = "hidden";
    editInput.name = "edit";
    editInput.value = "1";
    targetForm.appendChild(editInput);
  }
  
  ids.forEach(function (id) {
    var targetInput = document.createElement("input");
    targetInput.type = "hidden";
    targetInput.name = "bills";
    targetInput.value = id;
    targetForm.appendChild(targetInput);
  });
  document.body.appendChild(targetForm);
  if (upload || reupload) {
    $.post('/console/api/upload/counts/', {user_id: 44448, la_id: la, bill_ids: ids} , function(data) {
      if (data.result) {
        target = window.open("", "target", "scrollbars=yes,resizable=yes,width=500,height=400");
        if (target) {
          targetForm.submit();
          document.body.removeChild(targetForm);
          child_shipnote_window = target;
          
        } else {
          alert("請開啟彈跳視窗");
        }
      } else {
        alert(data.description);
      }
    });
  } else {
    target = window.open("", "target", "scrollbars=yes,resizable=yes,width=500,height=400");
    if (target) {
      targetForm.submit();
      document.body.removeChild(targetForm);
      if (!upload && !reupload) {
        $.post('/console/api/bills/print/', {kind: 'ship_note', bills: ids, user_id: 44448} , function(data) {
          ids.forEach(function(id) {
            var system_remark = $("tr[data-id='" + id + "']").find(".system_remark");
            html = system_remark.html();
            if (html) {
              system_remark.html(data + '\n\n' + html);
            } else {
              system_remark.html(data);
            }
          });
        });
      }
    } else {
      alert("請開啟彈跳視窗");
    }
  }
}
function openInvoice(ids, action='print') {
  var targetForm = document.createElement("form");
  targetForm.target = "target";
  targetForm.method = "post";
  targetForm.action = "/console/invoices/";
  var csrfInput = document.createElement("input");
  csrfInput.type = "hidden";
  csrfInput.name = "csrfmiddlewaretoken";
  csrfInput.value = "RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee";
  targetForm.appendChild(csrfInput);
  var actionInput = document.createElement("input");
  actionInput.type = "hidden";
  actionInput.name = "action";
  actionInput.value = action;
  targetForm.appendChild(actionInput);
  ids.forEach(function (id) {
    var targetInput = document.createElement("input");
    targetInput.type = "hidden";
    targetInput.name = "bills";
    targetInput.value = id;
    targetForm.appendChild(targetInput);
  });
  document.body.appendChild(targetForm);
  target = window.open("", "target", "scrollbars=yes,resizable=yes,width=500,height=400");
  if (target) {
    targetForm.submit();
    document.body.removeChild(targetForm);
  } else {
    alert("請開啟彈跳視窗");
  }
}
function openPrint(ids, action='a4') {
  var targetForm = document.createElement("form");
  targetForm.target = "target";
  targetForm.method = "post";
  targetForm.action = "/console/print/";
  var csrfInput = document.createElement("input");
  csrfInput.type = "hidden";
  csrfInput.name = "csrfmiddlewaretoken";
  csrfInput.value = "RiJirLpMjhJj6N9yKthaHXqFzLRgo1fb6kqr2IDqVXe8dcxZdar5ITkgNYuZlEee";
  targetForm.appendChild(csrfInput);
  var actionInput = document.createElement("input");
  actionInput.type = "hidden";
  actionInput.name = "action";
  actionInput.value = action;
  targetForm.appendChild(actionInput);
  ids.forEach(function (id) {
    var targetInput = document.createElement("input");
    targetInput.type = "hidden";
    targetInput.name = "bills";
    targetInput.value = id;
    targetForm.appendChild(targetInput);
  });
  var userInput = document.createElement("input");
  userInput.type = "hidden";
  userInput.name = "pc_user";
  userInput.value = "27733";
  targetForm.appendChild(userInput);
  document.body.appendChild(targetForm);
  target = window.open("", "target", "scrollbars=yes,resizable=yes,width=180,height=10");
  if (target) {
    targetForm.submit();
    document.body.removeChild(targetForm);
  } else {
    alert("請開啟彈跳視窗");
  }
}
function showCount() {
  var count = $(".order-checkbox:checked").length;
  var total = document.getElementById("main").dataset['total'] || '--'
  if (count > 0) {
    $("#count").html("選取 " + count + " / " + total);
  } else {
    $("#count").html("總數 " + $(".bill-item").length + " / " + total);
  }
  $("#count").append(" <span class=\"loading d-none\">（載入中 ...）</span>")
}
var print_count_per_page = 100;
$("select[name='action']").change(function() {
  var selectElements = document.getElementsByName('search');
  var order_by_origin = false;
  for (var i = 0; i < selectElements.length; i++) {
    var selectElement = selectElements[i];
    var selectedValue = selectElement.value;
    if (selectedValue === 'pay_date') {
      console.log('here');
      order_by_origin = true;
    }
  }
  var edc = false;
  
  var kind = $(this).val();
  if (kind == 'default') {
    return;
  }
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0 && kind != 'shipnote_no_import' && kind != 'shipnote_no_format') {
    alert("請選擇付款單");
    $(this).val('default');
    return;
  }
  if (kind == 'complex') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 50) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, 'complex', email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
    
  } else if (kind == 'simple') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, 'simple', email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
    
  } else if (kind == 'list_simple') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, 'list_simple', email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'purchase' || kind == 'purchase_without_date' || kind == 'purchase_with_supplier' || kind == 'purchase_with_discount' || kind == 'purchase_pic' || kind == 'purchase_without_date_pic' || kind == 'purchase_with_supplier_pic' || kind == 'purchase_with_discount_pic') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
    
  } else if (kind == 'warehouse' || kind == 'warehouse_combined' || kind == 'warehouse_kind_b' || kind == 'warehouse_combined_presco') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 200) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
    
  } else if (kind == 'shipnote_view_download') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'refunds') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 200) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'erp_sales') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 200) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'logistic') {
    download(bills, 'logistic');
    $(this).val('default');
  } else if (kind == 'size') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, 'size', email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'custom_home' || kind == 'custom_cvs') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'custom_cost') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 200) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'a4') {
    if (bills.length > print_count_per_page) {
      openPrint(bills, action='a4')
    } else {
      printA4(bills, note=false, order_by_origin=order_by_origin);
    }
    $(this).val('default');
  } else if (kind == 'a4_2') {
    if (bills.length > print_count_per_page) {
      openPrint(bills, action='a4_2')
    } else {
      printA4(bills, note=false, order_by_origin=order_by_origin, photo_length=120);
    }
    $(this).val('default');
  } else if (kind == 'a4_home') {
    if (bills.length > print_count_per_page) {
      openPrint(bills, action='a4_home')
    } else {
      printA4(bills, note=true, order_by_origin=order_by_origin);
    }
    $(this).val('default');
  } else if (kind == 'thermal') {
    printThermal(bills);
    $(this).val('default');
  } else if (kind == 'export') {
    var logistic_str = '';
    
    
    
    var r = confirm("請注意，您將把付款單狀態改成已出貨。" + logistic_str);
    if (!r) {
      $(this).val('default');
      return;
    }
    $.post("/console/api/ship/shift/shipped/27733/", {'bills': bills}, function(data) {
      if (data.success) {
        data.success.forEach(function(id) {
          $("tr[data-id='" + id + "']").remove();
        });
        showCount();
        
        if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home') {
          openTarget(bills, upload=true, reupload=false, edit=false);
        }
        
      }
    });
    $(this).val('default');
  } else if (kind == 'prepare') {
    var r = confirm("請注意，您將把付款單移至出貨準備區。");
    if (!r) {
      $(this).val('default');
      return;
    }
    $.post("/console/api/ship/shift/prepared/27733/", {'bills': bills}, function(data) {
      if (data.success) {
        data.success.forEach(function(id) {
          $("tr[data-id='" + id + "']").remove();
        });
        showCount();
      }
    });
    $(this).val('default');
  } else if (kind == 'unprepare') {
    var r = confirm("請注意，您將把付款單退回待出貨區。");
    if (!r) {
      $(this).val('default');
      return;
    }
    $.post("/console/api/ship/shift/tobeshipped/27733/", {'bills': bills, from_prepared: true}, function(data) {
      if (data.success) {
        data.success.forEach(function(id) {
          $("tr[data-id='" + id + "']").remove();
        });
        showCount();
      }
    });
    $(this).val('default');
  } else if (kind == 'refund') {
    var r = confirm("請注意，您將要進行退款。");
    if (!r) {
      $(this).val('default');
      return;
    }
    $.post("/console/api/bills/refund/", {'request_user_id': '44448', 'bills': bills}, function(data) {
      
      showCount();
      alert('執行退款成功！');
    })
    .fail(function(error) {
      let errorResponse = JSON.parse(error.responseText);
      alert(errorResponse.message);
    })
    $(this).val('default');
  } else if (kind == 'upload') {
    var r = confirm("請注意，已上傳過的託運單將無法再次上傳。");
    if (!r) {
      $(this).val('default');
      return;
    }
    
    if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home') {
      openTarget(bills, upload=true);
    }
    
    $(this).val('default');
  } else if (kind == 'note') {
    openTarget(bills);
    $(this).val('default');
  } else if (kind == 'invoice_complex') {
    openInvoice(bills, action='complex');
    $(this).val('default');
  } else if (kind == 'invoice_issue') {
    openInvoice(bills, action='issue');
    $(this).val('default');
    
  } else if (kind == 'invoice_invalid') {
    openInvoice(bills, action='invalid');
    $(this).val('default');
    
  } else if (kind == 'invoice_print') {
    openInvoice(bills, action='print');
    $(this).val('default');
  } else if (kind == 'invoice_simple') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, 'invoice_simple', email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'invoice_a4') {
    openInvoice(bills, action='a4');
    $(this).val('default');
  } else if (kind == 'shipnote_no_format') {
    download(bills, 'shipnote_no_format');
    $(this).val('default');
  } else if (kind == 'shipnote_no_import') {
    $('#shipnote_no_import').trigger('click');
    $(this).val('default');
  } else if (kind == 'invoice_a4_home') {
    openInvoice(bills, action='a4_home');
    $(this).val('default');
  } else if (kind == 'check') {
    $.post("/console/api/bills/check/", {'bills': bills}, function(data) {
      data.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    })
  } else if (kind == 'allot') {
    $.post("/console/api/bills/allot/", {'bills': bills}, function(data) {
      data.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    })
  } else if (kind == 'batch_append_remark') {
    $( ".remark-box-container" ).dialog({
      width: 600,
      buttons : {
        "確認" : function(event) {
          var message = $("#batch_append_remark_content").val().trim();
          if (message.length > 0){
            $(event.target).attr('disabled', 'disabled');
            $(event.target).html('處理中');
            $.post("/console/api/bill/batch/edit/27733/", {'bills': bills, 'remark': message}, function(data) {
              if (data.success || data.queue_process) {
                data.success.forEach(function( {id, remark, extra_remark}) {
                  var target = $("tr[data-id='" + id + "']").find('.remark');
                  if (target) {
                    target.html(remark);
                  }
                });
                $("#batch_append_remark_content").val('');
                if (bills.length > 30) {
                  alert('批次更新需求已送出，請稍後再進行資料確認。');
                } else {
                  alert('成功');
                }
                $(".remark-box-container").dialog( "close" );
              }
            })
          }
        },
        "取消" : function() {
          $(this).dialog("close");
        }
      },
    });
    $(".remark-box-container").dialog( "open" );
  } else if (kind == 'batch_append_extra_remark') {
    $( ".extra-remark-box-container" ).dialog({
      width: 600,
      buttons : {
        "確認" : function(event) {
          var message = $("#batch_append_extra_remark_content").val().trim();
          if (message.length > 0){
            $(event.target).attr('disabled', 'disabled');
            $(event.target).html('處理中');
            $.post("/console/api/bill/batch/edit/27733/", {'bills': bills, 'extra_remark': message}, function(data) {
              if (data.success || data.queue_process) {
                data.success.forEach(function( {id, remark, extra_remark}) {
                  var target = $("tr[data-id='" + id + "']").find('.extra_remark');
                  if (target) {
                    target.html(extra_remark);
                  }
                });
                $("#batch_append_extra_remark_content").val('');
                if (bills.length > 30) {
                  alert('批次更新需求已送出，請稍後再進行資料確認。');
                } else {
                  alert('成功');
                }
                $(".extra-remark-box-container").dialog( "close" );
              }
            })
          }
        },
        "取消" : function() {
          $(this).dialog("close");
        }
      },
    });
    $(".extra-remark-box-container").dialog( "open" );
  } else if (kind == 'batch_append_reward') {
    $( '.reward-box-container' ).dialog({
      width: 600,
      buttons : {
        '確認' : function(event) {
          let reward = $('#batch_append_reward_input').val();
          if (reward > 0) {
            $(event.target).attr('disabled', 'disabled');
            $(event.target).html('處理中');
            $.post('/console/api/bill/batch/reward/27733/', {'bills': bills, 'reward': reward, 'request_user_id': '44448'}, function(data) {
              alert('批次發放需求已送出，請稍後再進行資料確認。');
              $('#batch_append_reward_input').val('');
              $('.reward-box-container').dialog( 'close' );
            })
          }
        },
        '取消' : function() {
          $(this).dialog('close');
        }
      },
    });
    $('.reward-box-container').dialog( 'open' );
  } else if (kind == 'batch_append_giveaway') {
    $( '.giveaway-box-container' ).dialog({
      width: 600,
      buttons : {
        '確認' : function(event) {
          let giveaway_id = $('#batch_append_giveaway_input').val();
          let giveaway_style = $('#batch_append_giveaway_style_input').val();
          let giveaway_sub_style = $('#batch_append_giveaway_sub_style_input').val();
          let giveaway_quantity = $('#batch_append_giveaway_quantity_input').val();
          if (giveaway_id) {
            $(event.target).attr('disabled', 'disabled');
            $(event.target).html('處理中');
            $.post('/console/api/bill/batch/giveaway/27733/', {'bills': bills, 'giveaway_id': giveaway_id, 'giveaway_style': giveaway_style, 'giveaway_sub_style': giveaway_sub_style, 'giveaway_quantity': giveaway_quantity, 'request_user_id': '44448'}, function(data) {
              alert('批次發放需求已送出，請稍後再進行資料確認。');
              $('input[name="giveaway_search"]').val('');
              $('input[name="giveaway_style_search"]').val('');
              $('#batch_append_giveaway_input').val('');
              $('#batch_append_giveaway_style_input').val('');
              $('#batch_append_giveaway_sub_style_input').val('');
              $('#batch_append_giveaway_quantity_input').val('');
              $('.giveaway-box-container').dialog( 'close' );
            })
          }
        },
        '取消' : function() {
          $(this).dialog('close');
        }
      },
    });
    $('.giveaway-box-container').dialog( 'open' );
  } else if (kind == 'tcat' || kind == 'tcat_car') {
    var count = $(".order-checkbox:checked").length;
    var email = false;
    if (!edc && count >= 500) {
      
      alert("匯出檔案過大，將直接寄到您的信箱：bigcity_21@yahoo.com.tw,sunyad4007@yahoo.com,helen.abn52@gmail.com,zhenpaidress@gmail.com,haslala072608@gmail.com,hanyu28112343@gmail.com,sunyad4019@gmail.com");
      email = true;
      
    }
    download(bills, kind, email=email, authenticator_pass=false, edc=edc);
    $(this).val('default');
  } else if (kind == 'sms_notisarrived') {
    $( ".sms-box-container" ).dialog({
      width: 600,
      buttons : {
        "確認" : function() {
          var message = $("#sms_content").val().trim();
          if (message.length > 0) {
            var r = confirm("請注意，確認後會發出SMS簡訊通知。");
            if (r) {
              $.post("/console/api/bills/sms/notisarrived/", {'bills': bills, message: message}, function(data) {
              })
            }
          }
          $(".sms-box-container").dialog( "close" );
        },
        "取消" : function() {
          $(this).dialog("close");
        }
      },
    });
    $("#sms_count").html($("#sms_content").val().length);
    $(".sms-box-container").dialog( "open" );
  } else if (kind == 'one_shot_pay'){
    var target = $(this);
    var r = confirm("請注意，您將確認付款並移至未出貨區。");
    if (!r) {
      $(this).val('default');
      return;
    }
    target.attr('disabled', true);
    $.post("/console/api/ship/shift/paid/27733/", {'bills': bills, '_user_id': '44448'}, function(data) {
      if (data.success) {
        data.success.forEach(function(id) {
          $("tr[data-id='" + id + "']").remove();
        });
        showCount();
      } else if (data.error_code && data.error_code == 'CONFIRM_PAYMENT_NOT_ALLOWED') {
        alert("無確認付款權限，無法進行該操作！")
      }
    })
    .always(function() {
      target.attr('disabled', false);
    });
  } else if (kind == 'pay_notification'){
    $( ".pay-alert-box-container" ).dialog({
      width: 600,
      buttons : {
        "確認" : function() {
          var send_type = [];
          $("input[name='send_type']:checked").each(function() {
            send_type.push($(this).val());
          });
          if (send_type.length == 0) {
            alert("請選擇要傳送通知的方式");
          } else {
            var message = $("#pay_alert_content").val().trim();
            if (message.length > 0){
              var r = confirm("請注意，確認後會發出未付款通知。");
              if (r) {
                $.post("/console/api/notify/notpaid/27733/", {'bills': bills, message: message, 'type': send_type}, function(data) {
                })
              }
            }
            $(".pay-alert-box-container").dialog( "close" );
          }
        },
        "取消" : function() {
          $(this).dialog("close");
        }
      },
    });
    $(".pay-alert-box-container").dialog( "open" );
  } else if (kind == 'split_notisarrived'){
    var target = $(this);
    var r = confirm("請注意，只有內含部分未到貨訂單的付款單才會進行拆單。");
    if (!r) {
      $(this).val('default');
      return;
    }
    target.attr('disabled', true);
    $.post("/console/api/bills/split/27733/", {'kind': 'notarrived', 'bills': bills, 'request_user_id': '44448'}, function(data) {
      data.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
      alert("完成拆單");
    })
    .always(function() {
      target.attr('disabled', false);
    });
  }
  $(this).val('default');
});
$("#sms_content").on("keyup", function () {
  $("#sms_count").html($(this).val().length);
});
$("#one_shot_merge").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要合併的付款單");
  } else {
    var r = confirm("請注意，只有同買家且同付款方式的付款單可以合併。\n請自行處理與線上金流相關的後續動作。");
    if (!r) {
      return;
    }
    target.attr('disabled', true);
    $.post("/console/api/bills/merge/27733/", {'bills': bills, 'request_user_id': '44448'}, function(data) {
      if (data.success) {
        data.success.forEach(function(id) {
          $("tr[data-id='" + id + "']").remove();
        });
        showCount();
      } else if (data.invalid) {
        alert('無執行權限！');
      } else if (data.is_merging) {
        alert('此帳號正在執行合併動作，請稍後再試！');
      } else if (data.prepayment_not_enough) {
        alert('預付款餘額不足，請儲值！');
      }
    })
    .always(function() {
      target.attr('disabled', false);
    });
  }
});
$("#one_shot_split").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要拆單的付款單");
  } else {
    var r = confirm("請注意，確認後會將付款單拆分。");
    if (!r) {
      return;
    }
    target.attr('disabled', true);
    let commodities = []
    ''.split(',,,').forEach(e => {
      let c = e.split('@@@')[0]
      if (c) {
        commodities.push(c)
      }
    })
    $.post("/console/api/bills/split/27733/", {'kind': 'commodities', 'bills': bills, 'commodities': commodities, 'request_user_id': '44448'}, function(data) {
      data.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    })
    .always(function() {
      target.attr('disabled', false);
    });
  }
});
$("#one_shot_force_merge").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要合併的付款單");
  } else {
    var r = confirm("請注意，您可能合併不同買家的訂單。\n請自行處理與線上金流相關的後續動作。");
    if (!r) {
      return;
    }
    target.attr('disabled', true);
    $("#force_merge_main_bill").html('');
    bills.forEach(function(id) {
      $("#force_merge_main_bill").append(new Option(id, id))
    });
    $(".force_merge-box-container").dialog({
      width: 600,
      buttons: {
        "確認": function(e) {
          $(e.target).attr('disabled', true);
          $.post("/console/api/bills/merge/27733/", {'bills': bills, 'request_user_id': '44448', 'main_id':  $("#force_merge_main_bill").val()}, function(data) {
            if (data.alert) {
              if (data.alert == 1){
                alert("訂單包含不一致的付款方式或付款狀態");
                return;
              }
            }
            if (data.success) {
              data.success.forEach(function(id) {
                $("tr[data-id='" + id + "']").remove();
              });
              showCount();
            } else if (data.invalid) {
              alert('無執行權限！');
            } else if (data.prepayment_not_enough) {
              alert('預付款餘額不足，請儲值！');
            }
          })
          .always(function() {
            target.attr('disabled', false);
            $(".force_merge-box-container").dialog( "close" );
          });
        },
        "取消" : function() {
          $(this).dialog("close");
          target.attr('disabled', false);
          $(".force_merge-box-container").dialog( "close" );
        }
      }
    });
    $(".force_merge-box-container").dialog( "open" );
  }
});
$("#one_shot_arrive").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要通知到貨的付款單");
  } else {
    var r = confirm("請注意，您將付款單狀態設成已到貨。");
    if (!r) {
      return;
    }
    target.attr('disabled', true);
    $.post("/console/api/bills/arrive/", {'bills': bills}, function(data) {
      data.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    })
    .always(function() {
      target.attr('disabled', false);
    });
  }
});
$("#one_shot_sms").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要SMS簡訊通知的付款單");
  } else {
    target.attr('disabled', true);
    $( ".sms-box-container" ).dialog({
      width: 600,
      buttons : {
        "確認" : function() {
          var message = $("#sms_content").val().trim();
          var remark = $("#sms-add-remark").val();
          if (message.length > 0) {
            var r = confirm("請注意，確認後會發出SMS簡訊通知。");
            if (r) {
              $.post("/console/api/bills/sms//", {'bills': bills, message: message, 'remark': remark}, function(data) {
                data.forEach(function(id) {
                  $("tr[data-id='" + id + "']").remove();
                });
                showCount();
              })
              .always(function() {
                target.attr('disabled', false);
              });
            }
          }
          target.attr('disabled', false);
          $(".sms-box-container").dialog( "close" );
        },
        "取消" : function() {
          $(this).dialog("close");
          target.attr('disabled', false);
        }
      },
      close: function() {
        target.attr('disabled', false);
      },
    });
    $("#sms_count").html($("#sms_content").val().length);
    $(".sms-box-container").dialog( "open" );
  }
});
$('#one_shot_default').click(function() {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇付款單");
    return;
  }
  var r = confirm("請注意，您將把付款單移至未出貨區。");
  if (!r) {
    return;
  }
  target.attr('disabled', true);
  $.post("/console/api/ship/shift/default/27733/", {'bills': bills}, function(data) {
    if (data.success) {
      data.success.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    }
  })
  .always(function() {
    target.attr('disabled', false);
  });
})
$("#one_shot_jsterp").click(function () {
  var target = $(this);
  bills = [];
  $("input[name='bills']:checked").each(function() {
    bills.push($(this).val());
  });
  if (bills.length == 0) {
    alert("請選擇要上傳JSTERP的付款單");
  } else {
    var r = confirm("請注意，確認後會上傳到JSTERP。");
    if (!r) {
      return;
    }
    target.attr('disabled', true);
    $.post("/console/api/bills/jsterp/27733/", {'bills': bills, '_user_id': '44448'}, function(data) {
      alert("上傳程序進行中，請至JSTERP後台查詢");
    })
    .always(function() {
      target.attr('disabled', false);
    });
  }
});
function selectSearch() {
  var search = $("select[name='search']").val();
  $(".order-style").hide();
  if(search == "serial") {
    $("input[name='serial']").show();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == "fb") {
    $("input[name='fb']").show();
    $("#multi_from_name_area").show();
    $("input[name='commodity']").hide();
    $("input[name='serial']").hide();
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == "commodity") {
    $("input[name='commodity']").show();
    $("input[name='commodity_2']").show();
    $("#append").show();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='serial']").hide();
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
    $(".order-style").show();
  } else if(search == 'sn') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").show();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'sn_id') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").show();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'custom_ship_notes') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").show();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'ship_name') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").show();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'ship_contact') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").show();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if (search == 'remark') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").show();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if (search == 'blank_remark') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
    $("button[id='clear']").hide();
  } else if (search == 'extra_remark') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").show();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'atm_postfix') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    
    $("input[name='atm_postfix']").show();
    
    $("input[name='invoice_number']").hide();
  } else if(search == 'invoice_number') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").show();
  } else if(search == 'pay_date') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").show();
    $("input[name='pay_end']").show();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='commodity_2']").hide();
    $("#search_style_2").hide();
    $("#append").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'shipnotes_checkout_date') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").show();
    $("input[name='shipnotes_checkout_end']").show();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else if(search == 'refunds_refund_date') {
    $("input[name='begin']").hide();
    $("input[name='end']").hide();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").show();
    $("input[name='refunds_refund_end']").show();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  } else {
    $("input[name='begin']").show();
    $("input[name='end']").show();
    $("input[name='pay_begin']").hide();
    $("input[name='pay_end']").hide();
    $("input[name='shipnotes_checkout_begin']").hide();
    $("input[name='shipnotes_checkout_end']").hide();
    $("input[name='refunds_refund_begin']").hide();
    $("input[name='refunds_refund_end']").hide();
    $("input[name='serial']").hide();
    $("input[name='fb']").hide();
    $("#multi_from_name_area").hide();
    $("input[name='commodity']").hide();
    $("input[name='sn']").hide();
    $("input[name='sn_id']").hide();
    $("input[name='custom_ship_notes']").hide();
    $("input[name='ship_name']").hide();
    $("input[name='ship_contact']").hide();
    $("input[name='remark']").hide();
    $("input[name='extra_remark']").hide();
    $("input[name='atm_postfix']").hide();
    $("input[name='invoice_number']").hide();
  }
}
function search_sessions(request, response) {
  $.post('/console/api/sessions/27733/', { search: request.term } ,
    function(data) {
      response($.map(data.data, function(item) {
        return {
          value: item.name,
        }
      }));
    }
  );
}
function search_from_names(request, response) {
  $.post('/console/api/fromnames/27733/', { search: request.term, name_only: 'true' },
    function(data) {
      $('input[name="is_from_id"]').val("");
      if (data.is_from_id) {
        $('input[name="is_from_id"]').val("True");
        $("#form_search").submit();
      }
      response($.map(data.data, function(item) {
        return {
          value: item,
        }
      }));
    });
}
function search_commodities(request, response, shelf) {
  $.post('/console/api/commodities/27733/', { all_providers: 0, search: request.term, shelf: shelf, limit: 10, include_share_commodity_provider_commodity: 0 },
    function(data) {
      response($.map(data, function(item) {
        return {
          id: item.id,
          value: item.name,
          styles: item.styles,
        }
      }));
    });
}
function order_exchange_success({ bill_id }) {
  $(".view-delivery-box-container").dialog( "close" );
  $(`.btn-view-delivery[data-id=${bill_id}]`).click();
}
function refresh() {
  location.reload();
}
function append_ship_note({ bill_id, content}) {
  var appended_ship_notes = $(`tr[data-id=${bill_id}]`).find(".appended_ship_notes");
  var old_content = appended_ship_notes.html();
  var new_content;
  if (old_content && !old_content.includes(content)) {
    new_content = `${old_content}<br>${content}`;
  } else {
    new_content = content;
  }
  appended_ship_notes.html(new_content);
}
$(document).ready(function() {
  let search = $("select[name='search']").val();
  if (search == 'blank_remark') {
    $("button[id='clear']").hide();
  }
  $("#session_tags").tagit({
    allowSpaces: true,
    fieldName: 'sessions',
    autocomplete: {
      autoFocus: true,
      minLength: 0,
      source: function(request, response) {
        search_sessions(request, response);
      }
    },
  });
  
  $("#commodity_tags").tagit({
    allowSpaces: true,
    fieldName: 'commodities',
    autocomplete: {
      autoFocus: true,
      minLength: 0,
    },
  });
  
  $('input[name="fb"]').autocomplete({
    autoFocus: true,
    delay: 500,
    minLength: 0,
    source: function(request, response) {
      const idx = $("input[name='fb']").val().lastIndexOf(';');
      multi_from_name_length = idx + 1;
      request.term = request.term.substring(multi_from_name_length);
      search_from_names(request, response);
    },
    select: function(event, ui) {
      if (is_multi_from_name) {
        const _fb = $("input[name='fb']").val().substring(0, multi_from_name_length) + ui.item.value + ";";
        $("input[name='fb']").val(_fb);
        $('input[name="fb_from_name"]').val(_fb);
        multi_from_name_length = _fb.length;
        event.preventDefault();
      } else {
        $("input[name='fb']").val(ui.item.value);
        $('input[name="fb_from_name"]').val(ui.item.value);
        $('input[name="skip_check"]').val("True");
        $("#form_search").submit();
      }
    },
    change: function(event, ui) {
      if (is_multi_from_name) {
        $("input[name='fb_from_name']").val($("input[name='fb']").val());
      } else if (!ui.item || $("input[name='fb']").val() !== ui.item.value) {
        $("input[name='fb_from_name']").val("");
      }
    },
    focus: function(event, ui) {
      var inputTerm = $('input[name="fb"]').val()
      var focusItem = $('.ui-menu-item-wrapper').html();
      if (!is_multi_from_name && inputTerm.toLowerCase() === focusItem.toLowerCase()) {
        $("input[name='fb']").val(ui.item.value);
        $('input[name="fb_from_name"]').val(ui.item.value);
        // $("#form_search").submit();
      }
    }
  })
  $('input[name="commodity"]').autocomplete({
    autoFocus: true,
    delay: 500,
    minLength: 0,
    source: function(request, response) {
      
      search_commodities(request, response, shelf = 'on');
      
    },
    select: function(event, ui) {
      $("button[type='submit']").attr('disabled', false);
      $("input[name='commodity']").val(ui.item.value);
      $("input[name='commodity_id']").val(ui.item.id);
      $("select[name='search_style']").val("");
      $("#form_search").submit();
    },
    change: function(event, ui) {
      $("button[type='submit']").attr('disabled', true);
      if (!ui.item || $("input[name='commodity']").val() !== ui.item.value) {
        $("input[name='commodity_id']").val("");
        $("select[name='search_style']").val("");
      }
    },
    focus: function(event, ui) {
      var inputTerm = $('input[name="commodity"]').val()
      var focusItem = $('.ui-menu-item-wrapper').html();
      if (inputTerm.toLowerCase() === focusItem.toLowerCase()) {
        $("button[type='submit']").attr('disabled', false);
        $("input[name='commodity']").val(ui.item.value);
        $("input[name='commodity_id']").val(ui.item.id);
        $("#form_search").submit();
      }
    }
  })
  $('input[name="commodity_2"]').autocomplete({
    autoFocus: true,
    delay: 500,
    minLength: 0,
    source: function(request, response) {
      
      search_commodities(request, response, shelf = 'on');
      
    },
    select: function(event, ui) {
      $("input[name='commodity_2']").val(ui.item.value);
      $("input[name='commodity_id_2']").val(ui.item.id);
      $("select[name='search_style_2']").hide();
      $("select[name='search_style_2']").children().remove().end().append($('<option>', {value: '', text: "-- 樣式 --"}));
      $.map(ui.item.styles, function(item) {
        let value, text;
        if (item.sub_keyword) {
          text = item.keyword + ' ' + item.sub_keyword
        } else {
          text = item.keyword
        }
        $("select[name='search_style_2']").append($('<option>', {value: item.id, text: text}));
        $("select[name='search_style_2']").show();
      })
    },
    change: function(event, ui) {
      if (!ui.item || $("input[name='commodity_2']").val() !== ui.item.value) {
        $("input[name='commodity_2']").val('');
        $("input[name='commodity_id_2']").val('');
        $("select[name='search_style_2']").val("");
        $("select[name='search_style_2']").children().remove().end().append($('<option>', {value: '', text: "-- 樣式 --"}));
        $("select[name='search_style_2']").hide();
      }
    },
    focus: function(event, ui) {
      var inputTerm = $('input[name="commodity_2"]').val()
      var focusItem = $('.ui-menu-item-wrapper').html();
      if (inputTerm.toLowerCase() === focusItem.toLowerCase()) {
        $("input[name='commodity_2']").val(ui.item.value);
        $("input[name='commodity_id_2']").val(ui.item.id);
      }
    }
  })
  $('input[name="giveaway_search"]').autocomplete({
    autoFocus: true,
    delay: 500,
    minLength: 0,
    source: function(request, response) {
      
      search_commodities(request, response, shelf = 'on');
      
    },
    select: function(event, ui) {
      $("input[name='giveaway_search']").val(ui.item.value);
      $("input[name='giveaway_id']").val(ui.item.id);
      $("input[name='giveaway_style_search']").autocomplete(
        "option", "source",
        ui.item.styles.map(function(style) {
          return {
            label: ui.item.value + ': ' + style.keyword + (style.sub_keyword ? '-' + style.sub_keyword : ''),
            value: style.keyword + ' ' + style.sub_keyword,
          }
      }));
    },
    change: function(event, ui) {
      if (!ui.item || $("input[name='giveaway_search']").val() !== ui.item.value) {
        $("input[name='giveaway_id']").val("");
      }
    },
    focus: function(event, ui) {
      var inputTerm = $('input[name="giveaway_search"]').val()
      var focusItem = $('.ui-menu-item-wrapper').html();
      if (inputTerm.toLowerCase() === focusItem.toLowerCase()) {
        $("input[name='giveaway_search']").val(ui.item.value);
        $("input[name='giveaway_id']").val(ui.item.id);
      }
    }
  })
  $('input[name="giveaway_style_search"]').autocomplete({
    minLength: 0,
    delay: 0,
    source: [],
    select: function(event, ui) {
      var newValue = ui.item.value.split(' ');
      var newStyle = newValue[0].trim();
      var newSubStyle = newValue.length > 1 ? newValue[1].trim() : '';
      $("input[name='giveaway_style']").val(newStyle);
      $("input[name='giveaway_sub_style']").val(newSubStyle);
    },
    change: function () {
      if (!ui.item || $("input[name='giveaway_style_search']").val() !== ui.item.value) {
        $("input[name='giveaway_style']").val("");
        $("input[name='giveaway_sub_style']").val("");
      }
    }
  })
  .focus(function() {
    $(this).autocomplete("search", "");
  })
  $("#append").click(function() {
    let c_name = $("input[name='commodity_2']").val()
    let c_id = $("input[name='commodity_id_2']").val()
    let s_name = $("select[name='search_style_2'] option:selected").text()
    let s_id = $("select[name='search_style_2']").val()
    if (c_name && c_id) {
      let tag;
      if (s_name && s_id) {
        tag = c_id + '_' + s_name + '@@@' + c_name
      } else {
        tag = c_id + '@@@' + c_name
      }
      $("#commodity_tags").tagit("createTag", tag);
      $("input[name='commodity_2']").val('');
      $("input[name='commodity_id_2']").val('');
      $("select[name='search_style_2']").val("");
      $("select[name='search_style_2']").children().remove().end().append($('<option>', {value: '', text: "-- 樣式 --"}));
      $("select[name='search_style_2']").hide();
    }
  });
  jQuery.datetimepicker.setLocale('zh-TW');
  $("input[name='begin']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='end']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='pay_begin']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='pay_end']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='shipnotes_checkout_begin']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='shipnotes_checkout_end']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='refunds_refund_begin']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("input[name='refunds_refund_end']").datetimepicker({format: "Y/m/d H:i", step:15});
  $("#logistic_date").datetimepicker({format: "Y/m/d", timepicker:false});
  showCount();

  
  var selected_bill = $('input[name=selected_bill]').val();
  if (selected_bill !== ''){
    check_bill_exist();
  }

  
});
$("input[name='begin']").change(function() {
  var end = $("input[name='end']");
  if($(this).val() && !end.val()) {
    end.val($(this).val());
  } else if(!$(this).val()) {
    end.val("");
  }
});
$("input[name='pay_begin']").change(function() {
  var pay_end = $("input[name='pay_end']");
  if($(this).val() && !pay_end.val()) {
    pay_end.val($(this).val());
  } else if(!$(this).val()) {
    pay_end.val("");
  }
});
$("input[name='shipnotes_checkout_begin']").change(function() {
  var shipnotes_checkout_end = $("input[name='shipnotes_checkout_end']");
  if($(this).val() && !shipnotes_checkout_end.val()) {
    shipnotes_checkout_end.val($(this).val());
  } else if(!$(this).val()) {
    shipnotes_checkout_end.val("");
  }
});
$("input[name='refunds_refund_begin']").change(function() {
  var refunds_refund_end = $("input[name='refunds_refund_end']");
  if($(this).val() && !refunds_refund_end.val()) {
    refunds_refund_end.val($(this).val());
  } else if(!$(this).val()) {
    refunds_refund_end.val("");
  }
});
$("input[name='logistic']").change(function() {
  $("#form_search").submit();
});
$("select[name='la']").change(function() {
  $("#form_search").submit();
});
$("select[name='provider']").change(function() {
  var _provider = $(this).val();
  if (_provider) {
    location.href = "/console/ship/?kind=" + $('#switch').val() + "&provider=" + $(this).val();
  } else {
    location.href = "/console/ship/?kind=" + $('#switch').val();
  }
});
$("select[name='pickup']").change(function() {
  $("#form_search").submit();
});
$("select[name='merge']").change(function() {
  $("#form_search").submit();
});
$("select[name='check']").change(function() {
  $("#form_search").submit();
});
$("select[name='allot']").change(function() {
  $("#form_search").submit();
});
$("select[name='status']").change(function() {
  $("#form_search").submit();
});
$("select[name='notship_status']").change(function() {
  $("#form_search").submit();
});
$("select[name='payment_method']").change(function() {
  $("#form_search").submit();
});
$("select[name='unprinted']").change(function() {
  $("#form_search").submit();
});
$("select[name='shipnote_status']").change(function() {
  $("#form_search").submit();
});
$("select[name='filter_shipnotes']").change(function() {
  $("#form_search").submit();
});
$("select[name='filter_shipnotes_checkout']").change(function() {
  $("#form_search").submit();
});
$("select[name='filter_refunds']").change(function() {
  $("#form_search").submit();
});
$("select[name='filter_refunds_download']").change(function() {
  $("#form_search").submit();
});
$("select[name='filter_refunds_purpose']").change(function() {
  $("#form_search").submit();
});
$("select[name='undownloaded']").change(function() {
  $("#form_search").submit();
});
$("select[name='invoice_method']").change(function() {
  $("#form_search").submit();
});
$("select[name='invoice_status']").change(function() {
  $("#form_search").submit();
});
$("select[name='sms']").change(function() {
  $("#form_search").submit();
});
$("select[name='search']").change(function() {
  selectSearch();
});
$("select[name='search_style']").change(function() {
  $("#form_search").submit();
});
$("select[name='checkout_purpose']").change(function() {
  localStorage.setItem("checkoutPurpose", $(this).val());
});
$("select[name='sinopac_refund_type']").change(function() {
  let sinopac_refund_type = $("select[name='sinopac_refund_type']").val()
  if (sinopac_refund_type == 'part') {
    $("#refund_orders_detail").show();
  } else {
    $("#refund_orders_detail").hide();
  }
});
$("#clear").click(function() {
  $("input[name='begin']").val("");
  $("input[name='end']").val("");
  $("input[name='pay_begin']").val("");
  $("input[name='pay_end']").val("");
  $("input[name='shipnotes_checkout_begin']").val("");
  $("input[name='shipnotes_checkout_end']").val("");
  $("input[name='refunds_refund_begin']").val("");
  $("input[name='refunds_refund_end']").val("");
  $("input[name='serial']").val("");
  $("input[name='fb']").val("");
  $("input[name='fb_from_name']").val("");
  $("input[name='commodity']").val("");
  $("input[name='commodity_id']").val("");
  $("input[name='remark']").val("");
  $("input[name='extra_remark']").val("");
  $("input[name='ship_info_in_blacklist']").val("False");
  $("select[name='pickup']").val("");
  
  $("input[name='sn']").val("");
  $("input[name='sn_id']").val("");
  
  $("input[name='custom_ship_notes']").val("");
  $("input[name='ship_name']").val("");
  $("input[name='ship_contact']").val("");
  $("input[name='atm_postfix']").val("");
  $("input[name='default_order_item']").val("date");
  $("input[name='default_order_by']").val("desc");
  $("#form_search").submit();
});
$("#switch").change(function() {
  var _provider = $('select[name="provider"]').val();
  if (_provider) {
    location.href = "/console/ship/?kind=" + $(this).val() + "&provider=" + $('select[name="provider"]').val();
  } else {
    location.href = "/console/ship/?kind=" + $(this).val();
  }
});
$("#refund_btn").click(function() {
  $("#refund_btn").attr("disabled", true);
  let action = $(this).attr("data-action");
  let bill_id = $(this).attr("data-bill_id");
  let refund_id = $(this).attr("data-refund_id");
  let refund_purpose = $("#refund_purpose").val();
  let refund_method = $("#refund_method").val();
  let refund_amount = $("#refund_amount").val();
  let refund_bank_code = $("#refund_bank_code").val();
  let refund_bank_account = $("#refund_bank_account").val();
  let refund_bank_account_username = $("#refund_bank_account_username").val();
  let refund_extra_remark = $("#refund_extra_remark").val();

  if (action === 'add' && has_refunds) {
    if (!confirm("已有退款單，確認新增退款單?")) {
      $("#refund_btn").attr("disabled", false);
      return;
    }
  }

  if (!refund_amount) {
    alert("請輸入退款金額");
    $("#refund_btn").attr("disabled", false);
    return;
  }

  if (!confirm(`請確認以下退款資訊\n\n原因 : ${$('#refund_purpose option:selected').text()}\n退款方式 : ${$('#refund_method option:selected').text()}\n退款金額 : ${$('#refund_amount').val()}\n銀行代號 : ${$('#refund_bank_code').val()}\n銀行帳號 : ${$('#refund_bank_account').val()}\n銀行戶名 : ${$('#refund_bank_account_username').val()}`)) {
    $("#refund_btn").attr("disabled", false);
    return;
  }

  if (action == 'add') {
    $.post(`/console/api/bill/refund/${bill_id}/`, {
      action: 'add',
      request_user_id: '44448',
      refund_purpose: refund_purpose,
      refund_method: refund_method,
      refund_amount: refund_amount,
      refund_bank_code: refund_bank_code,
      refund_bank_account: refund_bank_account,
      refund_bank_account_username: refund_bank_account_username,
      refund_extra_remark: refund_extra_remark
    } , function(data) {
      let newData = `<tr id="refund_${data.id}" class="refund-table-item"><td>${data.created_time}</td><td style="white-space: pre-wrap;">${data.refund_info}</td><td>${data.purpose}</td><td>${data.refund_method}</td><td>${data.currency}${data.amount}</td><td style="white-space: pre-wrap;">${data.bank_info}</td><td style="white-space: pre-wrap;">${data.description}</td><td style="white-space: pre-wrap;">${data.extra_remark}</td><td>${data.editor}</td><td><button type="button" class="btn-admin btn-pink" onclick="editRefund.bind(this)()" data-id="${data.id}" data-purpose="${data.purpose_value}" data-refund_method="${data.refund_method_value}" data-amount="${data.amount}" data-bank_code="${data.bank_code}" data-bank_account="${data.bank_account}" data-bank_account_username="${data.bank_account_username}" data-extra_remark="${data.extra_remark}">編輯</button></td></tr>`;
      $('#refund_detail').append(newData);
      clearRefundDialog();
      has_refunds = true;
      if (refund_purpose == 'mergeshippingfee') {
        
      }
      $("#refund_btn").attr("disabled", false);
    })
    .fail(function(error) {
      let errorResponse = JSON.parse(error.responseText);
      alert(errorResponse.message);
      $("#refund_btn").attr("disabled", false);
    });
  } else if (action == 'update') {
    $.post(`/console/api/bill/refund/${bill_id}/`, {
      action: 'update',
      request_user_id: '44448',
      refund_id: refund_id,
      refund_purpose: refund_purpose,
      refund_method: refund_method,
      refund_amount: refund_amount,
      refund_bank_code: refund_bank_code,
      refund_bank_account: refund_bank_account,
      refund_bank_account_username: refund_bank_account_username,
      refund_extra_remark: refund_extra_remark
    } , function(data) {
      let original_purpose = $(`#refund_edit_${data.id}`).attr("data-purpose");
      let newData = `<td>${data.created_time}</td><td style="white-space: pre-wrap;">${data.refund_info}</td><td>${data.purpose}</td><td>${data.refund_method}</td><td>${data.currency}${data.amount}</td><td style="white-space: pre-wrap;">${data.bank_info}</td><td style="white-space: pre-wrap;">${data.description}</td><td style="white-space: pre-wrap;">${data.extra_remark}</td><td>${data.editor}</td><td><button type="button" id="refund_edit_${data.id}" class="btn-admin btn-pink" onclick="editRefund.bind(this)()" data-id="${data.id}" data-purpose="${data.purpose_value}" data-refund_method="${data.refund_method_value}" data-amount="${data.amount}" data-bank_code="${data.bank_code}" data-bank_account="${data.bank_account}" data-bank_account_username="${data.bank_account_username}" data-extra_remark="${data.extra_remark}">編輯</button></td>`;
      $(`#refund_${data.id}`).html(newData);
      clearRefundDialog();
      switchRefundButton();
      if (data.is_refund || data.is_download || data.is_shipped) {
        $(`#refund_edit_${data.id}`).attr("data-lock", true);
      }
      if (refund_purpose == 'mergeshippingfee') {
        
      }
      $("#refund_btn").attr("disabled", false);
    })
    .fail(function(error) {
      let errorResponse = JSON.parse(error.responseText);
      alert(errorResponse.message);
      $("#refund_btn").attr("disabled", false);
    });
  }
});
$("#refund_cancel_btn").click(function() {
  clearRefundDialog();
  switchRefundButton();
})
$(document).on("click", "button[data-action='prepare']", function() {
  var bills = [$(this).attr("data-id")];
  var r = confirm("請注意，您將把付款單移至出貨準備區。");
  if (!r) {
    return;
  }
  $.post("/console/api/ship/shift/prepared/27733/", {'bills': bills}, function(data) {
    if (data.success) {
      data.success.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    }
  });
});
$(document).on("click", "button[data-action='unprepare']", function() {
  var bills = [$(this).attr("data-id")];
  var r = confirm("請注意，您將把付款單退回待出貨區。");
  if (!r) {
    return;
  }
  $.post("/console/api/ship/shift/tobeshipped/27733/", {'bills': bills, 'from_prepared': true}, function(data) {
    if (data.success) {
      data.success.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    }
  });
});
$(document).on("click", "button[data-action='export']", function() {
  var bills = [$(this).attr("data-id")];
  var pm = $(this).attr("data-pm");
  var sm = $(this).attr("data-sm");
  var la = $(this).attr("data-la");
  var logistic_str = '';
  
  
  if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home' && pm != 'pickup' && pm != 'pchome' && pm != 'shopee' && sm != 'pickup' && sm != 'express') {
    logistic_str = '\n請您務必列印託運單，並列印託運總表。'
  }
  
  
  var r = confirm("請注意，您將把付款單狀態改成已出貨。" + logistic_str);
  if (!r) {
    return;
  }
  $.post("/console/api/ship/shift/shipped/27733/", {'bills': bills}, function(data) {
    if (data.success) {
      data.success.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
      
      if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home' && pm != 'pickup' && pm != 'pchome' && pm != 'shopee' && sm != 'pickup' && sm != 'express') {
        
        if (!la) {
          la = '733';
        }
        openTarget(bills, upload=true, reupload=false, edit=false, la=la);
        
      }
      
    }
  });
});
$(document).on("click", "button[data-action='refund_info']", function() {
  let bill_id = $(this).attr("data-id");
  $( ".refund-box-container" ).dialog({
    width: 1200,
    open: function() {
      $('.ui-widget-overlay').click(function(e) {
        e.preventDefault();
        return false;
      });
      $.post(`/console/api/bill/refund/${bill_id}/`, {action: 'get', request_user_id: '44448'}, function(data) {
        if (data.length > 0) {
          has_refunds = true;
          data.forEach(function(refund) {
            let newData = `<tr id="refund_${refund.id}" class="refund-table-item"><td>${refund.created_time}</td><td style="white-space: pre-wrap;">${refund.refund_info}</td><td>${refund.purpose}</td><td>${refund.refund_method}</td><td>${refund.currency}${refund.amount}</td><td style="white-space: pre-wrap;">${refund.bank_info}</td><td style="white-space: pre-wrap;">${refund.description}</td><td style="white-space: pre-wrap;">${refund.extra_remark}</td><td>${refund.editor}</td><td><button type="button" id="refund_edit_${refund.id}" class="btn-admin btn-pink" onclick="editRefund.bind(this)()" data-id="${refund.id}" data-purpose="${refund.purpose_value}" data-refund_method="${refund.refund_method_value}" data-amount="${refund.amount}" data-bank_code="${refund.bank_code}" data-bank_account="${refund.bank_account}" data-bank_account_username="${refund.bank_account_username}" data-extra_remark="${refund.extra_remark}">編輯</button></td></tr>`;
            $('#refund_detail').append(newData);
            if (refund.is_refund || refund.is_download || refund.is_shipped) {
              $(`#refund_edit_${refund.id}`).attr("data-lock", true);
            }
          })
        } else {
          has_refunds = false;
        }
      })
      .fail(function(error) {
        let errorResponse = JSON.parse(error.responseText);
        alert(errorResponse.message);
        closeRefundDialog();
      })
    },
    buttons : {
      "關閉" : function() {
        closeRefundDialog();
      }
    }
  });
  $(".refund-box-container").dialog( "open" );
  $("#refund_btn").attr("data-bill_id", bill_id);
  $("#refund_btn").attr("data-action", 'add');
});
$(document).on("click", "button[data-action='refund']", function() {
  let target = $(this);
  let bills = [$(this).attr("data-id")];
  let r = confirm("請注意，您將要進行退款。");
  if (r) {
    $.post(`/console/api/bills/refund/`, {request_user_id: '44448', 'bills': bills}, function(data) {
      
      target.hide();
      showCount();
      alert('執行退款成功！');
    })
    .fail(function(error) {
      let errorResponse = JSON.parse(error.responseText);
      alert(errorResponse.message);
    })
  }
});
$(document).on("click", "button[data-action='upload']", function() {
  var bills = [$(this).attr("data-id")];
  var pm = $(this).attr("data-pm");
  var sm = $(this).attr("data-sm");
  var la = $(this).attr("data-la");
  if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home' && pm != 'pickup' && pm != 'pchome' && pm != 'shopee' && sm != 'pickup' && sm != 'express') {
    
    if (!la) {
      la = '733';
    }
    openTarget(bills, upload=true, reupload=false, edit=true, la=la);
    
  }
});
$(document).on("click", "button[data-action='reupload']", function() {
  var bills = [$(this).attr("data-id")];
  var pm = $(this).attr("data-pm");
  var sm = $(this).attr("data-sm");
  var la = $(this).attr("data-la");
  if ($("select[name='la']").val() && $("select[name='la']").val() !== 'not_use_home' && pm != 'pickup' && pm != 'pchome' && pm != 'shopee' && sm != 'pickup' && sm != 'express') {
    
    if (!la) {
      la = '733';
    }
    openTarget(bills, upload=false, reupload=true, edit=true, la=la);
    
  }
});
$(document).on("click", "button[data-action='update']", function() {
  var bill_id = $(this).attr("data-id");
  
});
$(document).on("click", "button[data-action='delete']", function() {
  var r = confirm("請注意，您將刪除託運單。\n刪除之後將無法回復。");
  if (!r) {
    return;
  }
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var target = $(this);
  $.post("/console/api/bills/delete/ship/notes/", {'bills': bills}, function(data) {
    target.hide();
  })
});
$(document).on("click", "button[data-action='download']", function() {
  var bill = $(this).attr("data-id");
  $(".download-area[data-id='" + bill + "']").slideToggle( "fast", function() {});
});
$(document).on("click", "button[data-action='complex']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var edc = false;
  
  download(bills, 'complex', email=false, authenticator_pass=false, edc=edc);
  $(".download-area[data-id='" + bill + "']").hide();
  $(".print-area[data-id='" + bill + "']").hide();
  
});
$(document).on("click", "button[data-action='simple']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var edc = false;
  
  download(bills, 'simple', email=false, authenticator_pass=false, edc=edc);
  $(".download-area[data-id='" + bill + "']").hide();
  $(".print-area[data-id='" + bill + "']").hide();
  
});
$(document).on("click", "button[data-action='purchase']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var edc = false;
  
  download(bills, 'purchase', email=false, authenticator_pass=false, edc=edc);
  $(".download-area[data-id='" + bill + "']").hide();
  $(".print-area[data-id='" + bill + "']").hide();
  
});
$(document).on("click", "button[data-action='print']", function() {
  var bill = $(this).attr("data-id");
  $(".print-area[data-id='" + bill + "']").slideToggle( "fast", function() {});;
});
$(document).on("click", "button[data-action='a4']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  $(".print-area[data-id='" + bill + "']").hide();
  $(".download-area[data-id='" + bill + "']").hide();
  printA4(bills);
});
$(document).on("click", "button[data-action='thermal']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  $(".print-area[data-id='" + bill + "']").hide();
  $(".download-area[data-id='" + bill + "']").hide();
  printThermal(bills);
});
$(document).on("click", "button[data-action='note']", function() {
  var bill = $(this).attr("data-id")
  var bills = [bill];
  var pm = $(this).attr("data-pm");
  var sm = $(this).attr("data-sm");
  var la = $(this).attr("data-la");
  if (pm != 'pickup' && pm != 'pchome' && pm != 'shopee' && sm != 'pickup' && sm != 'express') {
    
    if (!la) {
      la = '733';
    }
    openTarget(bills, upload=false, reupload=false, edit=true, la=la);
    
  }
  $(".print-area[data-id='" + bill + "']").hide();
  $(".download-area[data-id='" + bill + "']").hide();
});
$(document).on("click", "button[data-action='arrive']", function() {
  var r = confirm("請注意，您將付款單狀態設成已到貨。");
  if (!r) {
    return;
  }
  bill = $(this).attr("data-id");
  $.post("/console/api/bills/arrive/", {'bills': [bill]}, function(data) {
    data.forEach(function(id) {
      $("tr[data-id='" + bill + "']").remove();
    });
    showCount();
  });
});
$(document).on("click", "button[data-action='sms']", function() {
  bill = $(this).attr("data-id");
  $( ".sms-box-container" ).dialog({
    width: 600,
    buttons : {
      "確認" : function() {
        var message = $("#sms_content").val().trim();
        var remark = $("#sms-add-remark").val();
        if (message.length > 0) {
          var r = confirm("請注意，確認後會發出SMS簡訊通知。");
          if (r) {
            $.post("/console/api/bills/sms//", {'bills': [bill], message: message, 'remark': remark}, function(data) {
              
            })
          }
        }
        $(".sms-box-container").dialog( "close" );
      },
      "取消" : function() {
        $(this).dialog("close");
      }
    },
  });
  $("#sms_count").html($("#sms_content").val().length);
  $(".sms-box-container").dialog( "open" );
});
$(document).on("click", "button[data-action='unestablish']", function() {
  var r = confirm("請注意，您將把付款單退回購物車。\n退回之後將無法回復。\n請自行處理與線上金流相關的後續動作。");
  if (!r) {
    return;
  }
  bill = $(this).attr("data-id");
  $.post("/console/api/ship/shift/notestablished/27733/", {'bill': bill}, function(data) {
    if (data.result) {
      $("tr[data-id='" + bill + "']").remove();
      showCount();
    } else if (data.error_code && data.error_code == 'REWARD_ORDER') {
      alert("該筆付款單已付款且包含紅利商品訂單，不得退回購物車。")
    }
  });
});
$(document).on("click", "button[data-action='unship']", function() {
  var r = confirm("請注意，您將把付款單退回待出貨。\n退回之後將無法回復。");
  if (!r) {
    return;
  }
  bill = $(this).attr("data-id");
  $.post("/console/api/ship/shift/tobeshipped/27733/", {'bill': bill}, function(data) {
    if (data.result) {
      $("tr[data-id='" + bill + "']").remove();
      showCount();
    } else if (data.error_code && data.error_code == 'REWARD_ORDER') {
      alert("該筆付款單已付款且包含紅利商品訂單，不得退回待出貨。")
    }
  });
});
$(document).on("click", "button[data-action='check']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var target = $(this);
  $.post("/console/api/bills/check/", {'bills': bills}, function(data) {
    data.forEach(function(id) {
      
      target.hide();
      
    });
    showCount();
  })
});
$(document).on("click", "button[data-action='allot']", function() {
  var bill = $(this).attr("data-id");
  var bills = [bill];
  var target = $(this);
  $.post("/console/api/bills/allot/", {'bills': bills}, function(data) {
    data.forEach(function(id) {
      
      target.hide();
      
    });
    showCount();
  })
});
$(document).on("click", "button[data-action='trash']", function() {
  var r = confirm("請注意，您將丟棄付款單。\n丟棄之後將無法回復。\n請自行處理與線上金流相關的後續動作。");
  if (!r) {
    return;
  }
  bill = $(this).attr("data-id");
  $.post("/console/api/ship/shift/trashed/27733/", {'bill': bill}, function(data) {
    if (data.result) {
      $("tr[data-id='" + bill + "']").remove();
      showCount();
    } else if (data.error_code && data.error_code == 'REWARD_ORDER') {
      alert("該筆付款單已付款且包含紅利商品訂單，不得棄單。")
    }
  });
});
$(document).on("click", "button[data-action='ship_self']", function() {
  var r = confirm("請注意，您將把付款方式改為親自送貨。\n改變之後將無法回復。\n請自行處理與線上金流相關的後續動作。");
  if (!r) {
    return;
  }
  bill = $(this).attr("data-id");
  $.post(`/console/api/ship/self/27733/${bill}/`, function(response) {
    if (!response.result) {
      alert('fail');
    } else {
      var originalText = $("tr[data-id='" + bill + "']").find('.payment_method').text();
      if (originalText.indexOf('（親自送貨）') === -1) {
        $("tr[data-id='" + bill + "']").find('.payment_method').html(originalText + '（親自送貨）');
      }
      $("tr[data-id='" + bill + "']").find('.payment_method').attr("data-sm", "pickup")
      alert('完成');
    }
  });
});
$(document).on("click", "button[data-action='pay']", function() {
  var id = $(this).attr("data-id");
  var target = $("tr[data-id='" + id + "']").find(".atm_postfix");
  
  var postfix = prompt("請輸入銀行帳號後五碼，若不輸入請按取消", target.html());
  if (postfix == null) {
    postfix = '';
  } else {
    if(postfix.length != 5 || !(/^\d+$/.test(postfix))) {
      alert("輸入錯誤");
      return;
    }
  }
  
  var r = confirm("請注意，您將確認付款並移至未出貨區。");
  if (!r) {
    return;
  }
  bills = [id];
  $.post("/console/api/ship/shift/paid/27733/", {'bills': bills, 'postfix': postfix, '_user_id': '44448'}, function(data) {
    if (data.success) {
      data.success.forEach(function(id) {
        $("tr[data-id='" + id + "']").remove();
      });
      showCount();
    } else if (data.error_code && data.error_code == 'CONFIRM_PAYMENT_NOT_ALLOWED') {
      alert("無確認付款權限，無法進行該操作！")
    }
  });
});
$(document).on("click", "button[data-action='rebuild_lottery']", function() {
  var r = confirm("請注意，您將重新發送現在進行中抽獎活動之抽獎券。");
  if (!r) {
    return;
  }
  var bill = $(this).attr("data-id");
  var bills = [bill];
  $.post("/console/api/bills/rebuild/lottery/", {'bills': bills}, function(data) {
    alert('成功');
  })
});
$(document).on("click", "button[data-action='custom_invoice']", function() {
  const bill = $(this).attr("data-id");
  const data_invoice_number = $(this).attr("data-invoice_number");
  $("#custom_invoice_number").val(data_invoice_number);
  $(".custom-invoice-container").dialog({
    width: 600,
    buttons : {
      "確認" : function() {
        const invoice_number = $("#custom_invoice_number").val().trim();
        if (!invoice_number) {
          alert('請輸入發票號碼!');
          return;
        }
        if (invoice_number && invoice_number.length > 10) {
          alert('發票號碼超過10個字元，請重新輸入!');
          return;
        }
        $.post("/console/api/custom/invoice/issue/27733/", {'bill': bill, 'invoice_number': invoice_number}, function(data) {
          if (data.meassge) {
            alert(`${data.meassge}`);
          }
          if (data.result) {
            $("button[data-action='custom_invoice']").attr("data-invoice_number", invoice_number);
          } else {
            $("#custom_invoice_number").val(data_invoice_number);
          }
        });
        $(".custom-invoice-container").dialog( "close" );
      },
      "取消" : function() {
        $(this).dialog("close");
      }
    },
  });
  $(".custom-invoice-container").dialog( "open" );
});
$(document).on("change", ".order-checkbox", function() {
  showCount();
});
$(".selecctall").change(function() {
  setTimeout(function() {
    showCount();
  }, 100);
});
$("#form_search").submit(function(e) {
  var search = $("select[name='search']").val();
  var is_from_id = $('input[name="is_from_id"]').val();
  if (search == "fb" && !is_from_id) {
    if ($('input[name="fb"]').val() && !$('input[name="fb_from_name"]').val()) {
      if (!confirm("模糊搜尋僅會列出最近 30 天內之資料，建議點選搜尋建議以完整 FB 帳號搜尋，仍要繼續模糊搜尋？")) {
        e.preventDefault();
        return;
      }
    }
  }
  $("button[type='submit']").attr('disabled', true);
});
$('#maxselect').change(function () {
  var maxselect = parseInt($('#maxselect').val());
  if (maxselect) {
    $('.order-checkbox').each(function (index) {
      if (index < maxselect) {
        $(this).prop('checked', true);
      } else {
        $(this).prop('checked', false);
      }
    });
  } else {
    $(this).prop('checked', false);
    $('.order-checkbox').each(function (index) {
      $(this).prop('checked', false);
    });
  }
  setTimeout(function() {
    showCount();
  }, 100);
}).on('keydown', function (e) {
  if (e.key === 'Enter') {
    $(this).trigger('blur')
  }
});
function show_selected_bill(){
  var timer;
  var selected_bill = $('input[name=selected_bill]').val();
  var elmnt = document.getElementById(selected_bill);
  if (selected_bill !== ''){
    if (elmnt == null){
      $('#load_more').click();
    }else {
      elmnt.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
      timer = setTimeout(function () {
        $("tr[data-id='" + selected_bill + "']").addClass('highlight_row');
      }, 500);
      timer = setTimeout(function () {
        $("tr[data-id='" + selected_bill + "']").removeClass('highlight_row');
      }, 2000);
      $('input[name=selected_bill]').val('');
    }
  }
}
function check_bill_exist(){
  var selected_bill = $('input[name=selected_bill]').val();
  document.getElementById("main").addEventListener("bills-loaded", function(event) {
    var all_bills = [];
    $('.bill-item').each(function(){
      all_bills.push($(this).attr("data-id"));
    });
    if (all_bills.includes(selected_bill)){
      window.history.replaceState(null, null, window.location.pathname);
      show_selected_bill();
    } else {
      alert("付款單編輯成功，請依照更改後的寄送方式調整選單。");
      window.history.replaceState(null, null, window.location.pathname);
    }
  })
}

function trace_hct(ship_no) {
  window.open(`/pay/hct/${ship_no}`);
}

function trace_suda(ship_no) {
  window.open(`https://www.t-cat.com.tw/Inquire/TraceDetail.aspx?BillID=${ship_no}`);
}

function trace_xd(ship_no) {
  window.open(`https://xdelivery.io/admin/tracking/${ship_no}`);
}

$(document).on("click", "input[name='sms_bill_remark']", function() {
  if (document.querySelector('#sms-bill-remark:checked')) {
    $("#sms-add-remark").show();
  } else {
    $("#sms-add-remark").hide();
    $("#sms-add-remark").val("");
  }
})

$(document).on("click", ".ship-table-remark-more", function() {
  let item = $(this);
  item.siblings('.remark_info').toggleClass("remark-close");
  item.toggleClass("rotate");
});

$(document).on("click", ".ship-table-remarks-more", function() {
  let item = $(this);
  let current_display_status = item.attr("data-display")
  if (current_display_status == 'close') {
    item.attr("data-display", "open");
    item.removeClass("icon-columna-close");
    item.addClass("icon-columna-open");
    localStorage.setItem("remarksDisplay", "open");
    $(".remark_info").addClass("remark-close");
    $(".ship-table-remark-more").addClass("rotate");
  } else {
    item.attr("data-display", "close");
    item.removeClass("icon-columna-open");
    item.addClass("icon-columna-close");
    localStorage.setItem("remarksDisplay", "close");
    $(".remark_info").removeClass("remark-close");
    $(".ship-table-remark-more").removeClass("rotate");
  }
  $(".remark_info").toggleClass("remark-close");
  $(".ship-table-remark-more").toggleClass("rotate");
});

$(document).on("click", ".btn-issue-allowance", function(e) {
  var id = $(this).attr("data-id");
  var target = $("tr[data-id='" + id + "']");
  var invoice_number = target.find(".invoice_number");
  $('#orders_to_be_allowanced').html('');
  $.post('/console/api/invoice/orders/27733/', {bill: id} , function(data) {
    var template = document.getElementById('ship_order').innerHTML;
    Mustache.tags = ['[[', ']]'];
    var i;
    var rendered = '';
    for (i=0; i<data.length; i++) {
      var order = {
        id: data[i].id,
        name: data[i].name,
        quantity: data[i].quantity,
        price: data[i].price,
        tax_type: data[i].tax_type,
        from_allowance: 1,
      };
      rendered += Mustache.render(template, order);
    };
    $("#orders_to_be_allowanced").html(rendered);
  })

  $("#allowance_invoice_number").html(invoice_number.html());

  $( ".issue-allowance-box-container" ).dialog({
    width: 960,
    buttons : {
      "確認" : function() {
        var orders = [];
        var names = [];
        var quantitys = [];
        var prices = [];
        var tax_types = [];
        $(this).dialog("close");
        $("input[name='allowance_orders']:checked").each(function() {
          const order_id = $(this).val();
          orders.push(order_id);
          names.push($(`input[name="allowance_name_${order_id}"]`).val());
          quantitys.push($(`input[name="allowance_quantity_${order_id}"]`).val());
          prices.push($(`input[name="allowance_price_${order_id}"]`).val());
          tax_types.push($(`input[name="allowance_tax_type_${order_id}"]`).val());
        });
        if (!orders.length) {
          alert('請至少選擇 1 張訂單！');
          return;
        }
        var params = {
          bill: id,
          orders: orders,
          names: names,
          quantitys: quantitys,
          prices: prices,
          tax_types: tax_types,
        };
        $.post('/console/api/allowances/issue/27733/', params, function(response) {
          if (response.result) {
            alert('開立折讓完成！');
          } else {
            alert(response.ErrMsg);
          }
        }).fail(function () {
          alert('fail');
        });
      },
      "取消" : function() {
        $(this).dialog("close");
      }
    },
  });
  $(".issue-allowance-box-container").dialog( "open" );
});

$(document).on("click", ".btn-show-allowance", function(e) {
  var id = $(this).attr("data-id");
  Mustache.tags = ['[[', ']]'];
  var template = document.getElementById('allowances_template').innerHTML;
  $.post('/console/api/allowances/get/27733/', {bill: id} , function(data) {
    var rendered = '';
    for(var i = 0; i < data.length; i++) {
      var allowance = data[i];
      allowance.amount = toCommas(allowance.amount);
      allowance.bill_id = id;
      rendered += Mustache.render(template, allowance);
    }
    $("#allowance_list").html(rendered);
    $(function() {
      $(".btn-invalid-allowance").bind('click', function() {
        if (!confirm("確定要作廢嗎？")) {
          return;
        }
        var target = $(this);
        var param = {
          'bill': $(this).attr('data-bill_id'),
          'number': $(this).attr('data-number'),
        }
        $.post('/console/api/allowances/invalid/27733/', param, function(response) {
          if (response.result) {
            alert('作廢折讓完成！');
          } else {
            alert(response.ErrMsg);
          }
        }).fail(function () {
          alert('fail');
        });
      });
      $( ".show-allowance-box-container" ).dialog({
        width: 600,
        dialogClass: "view-delivery-box",
        buttons : {
          "關閉" : function() {
            $(this).dialog("close");
          }
        },
      });
      $(".show-allowance-box-container").dialog( "open" );
    });
  });
});
</script>

<script type="text/javascript" src="https://s3.ap-northeast-2.amazonaws.com/jambolive.tv/static/js/image-select.js"></script>
